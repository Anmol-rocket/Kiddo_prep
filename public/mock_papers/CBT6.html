<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIIMS CRE Radiographer CBT Mock</title>
    <style>
        :root {
            --header-bg: #3f51b5;
            --header-text: #fff;
            --panel-bg: #f5f5f5;
            --pallet-answered: #4caf50;
            --pallet-not-answered: #f44336;
            --pallet-review: #9c27b0;
            --pallet-not-visited: #e0e0e0;
            --text-color: #333;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; }
        body { height: 100vh; display: flex; flex-direction: column; overflow: hidden; background: #fff; }

        /* --- Header --- */
        header {
            background: var(--header-bg); color: var(--header-text);
            padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
            height: 60px; flex-shrink: 0;
        }
        .timer { font-size: 1.2rem; font-weight: bold; background: #fff; color: #333; padding: 5px 15px; border-radius: 4px; }

        /* --- Main Layout --- */
        .main-container { display: flex; flex: 1; overflow: hidden; }
        
        /* Left: Question Area */
        .question-area { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; }
        .q-header { display: flex; justify-content: space-between; border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-bottom: 15px; }
        .q-text { font-size: 1.1rem; margin-bottom: 20px; line-height: 1.5; }
        
        .options-container { display: flex; flex-direction: column; gap: 10px; }
        .option-label { 
            display: flex; align-items: center; padding: 10px; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; transition: 0.2s; 
        }
        .option-label:hover { background: #f0f8ff; }
        .option-label input { margin-right: 15px; transform: scale(1.2); }

        /* Right: Sidebar (Palette) */
        .sidebar {
            width: 320px; background: var(--panel-bg); border-left: 1px solid #ccc;
            display: flex; flex-direction: column; flex-shrink: 0;
        }
        .user-info { padding: 10px; background: #e8eaf6; border-bottom: 1px solid #ccc; display: flex; align-items: center; gap: 10px; }
        .user-img { width: 40px; height: 40px; background: #bbb; border-radius: 50%; }
        
        .palette-legend { padding: 10px; font-size: 0.8rem; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; background: #fff; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }

        .question-grid { 
            padding: 10px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; 
            overflow-y: auto; flex: 1; align-content: start;
        }
        .q-btn {
            height: 35px; width: 35px; border: 1px solid #ccc; background: #fff; 
            border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
        }
        
        /* Button States */
        .q-btn.answered { background: var(--pallet-answered); color: white; border-color: var(--pallet-answered); clip-path: polygon(0% 0%, 100% 0%, 100% 75%, 50% 100%, 0% 75%);  }
        .q-btn.not-answered { background: var(--pallet-not-answered); color: white; border-color: var(--pallet-not-answered); clip-path: polygon(0% 0%, 100% 0%, 100% 75%, 50% 100%, 0% 75%); }
        .q-btn.review { background: var(--pallet-review); color: white; border-radius: 50%; }
        .q-btn.current { border: 2px solid blue; box-shadow: 0 0 5px blue; }
        .q-btn.locked { opacity: 0.5; cursor: not-allowed; background: #555 !important; color: #fff; }

        /* Footer Controls */
        .footer-controls {
            height: 60px; background: #fff; border-top: 1px solid #ccc;
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
        }
        .btn { padding: 8px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.9rem; }
        .btn-primary { background: #2196f3; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-warn { background: #ff9800; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Mobile Adjustments */
        .mobile-toggle { display: none; background: none; border: none; color: white; font-size: 1.5rem; }
        
        @media (max-width: 768px) {
            .mobile-toggle { display: block; }
            .sidebar { 
                position: absolute; right: 0; top: 60px; bottom: 60px; z-index: 100;
                transform: translateX(100%); transition: transform 0.3s; width: 85%;
            }
            .sidebar.active { transform: translateX(0); }
            .question-grid { grid-template-columns: repeat(6, 1fr); }
            .footer-controls { flex-wrap: wrap; gap: 5px; height: auto; padding: 10px; }
            .btn { flex: 1; padding: 8px; font-size: 0.8rem; }
        }

        /* Overlay */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .hidden { display: none !important; }

        /* Review Mode */
        .review-panel { display: none; padding: 20px; height: 100%; overflow-y: auto; }
        .review-item { margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
        .correct-ans { color: green; font-weight: bold; }
        .wrong-ans { color: red; font-weight: bold; }
        .explanation { background: #fff3cd; padding: 10px; margin-top: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div id="landingPage" class="overlay">
        <h1>AIIMS CRE Radiographer CBT Mock</h1>
        <div style="width: 80%; max-width: 600px; text-align: left; margin: 20px 0;">
            <h3>Instructions:</h3>
            <ul>
                <li><strong>Total Questions:</strong> 100 (20 Non-Core, 80 Core)</li>
                <li><strong>Time:</strong> 90 Minutes</li>
                <li><strong>Marking:</strong> +4 Correct, -1 Incorrect, 0 Unattempted.</li>
                <li><strong>Constraint:</strong> Questions appear in sets of 20. Once you proceed to the next set (e.g., Q21), the previous set (Q1-20) is locked.</li>
            </ul>
        </div>
        <button class="btn btn-success" style="font-size: 1.2rem;" onclick="startExam()">START EXAM</button>
    </div>

    <header id="examHeader" class="hidden">
        <div style="display:flex; align-items:center; gap:10px;">
            <h3>AIIMS CRE</h3>
        </div>
        <div class="timer" id="timerDisplay">90:00</div>
        <button class="mobile-toggle" onclick="toggleSidebar()">☰</button>
    </header>

    <div class="main-container hidden" id="examBody">
        <div class="question-area">
            <div class="q-header">
                <span id="qNumDisplay">Question No. 1</span>
                <span style="color: #666;">Marks: +4, -1</span>
            </div>
            <div id="questionText" class="q-text">Loading question...</div>
            <div id="optionsBox" class="options-container">
                </div>
        </div>

        <div class="sidebar" id="sidebar">
            <div class="user-info">
                <div class="user-img"></div>
                <div>
                    <strong>Candidate Name</strong><br>
                    <small>Radiographer</small>
                </div>
            </div>
            <div class="palette-legend">
                <div class="legend-item"><span class="dot" style="background:var(--pallet-answered)"></span> Answered</div>
                <div class="legend-item"><span class="dot" style="background:var(--pallet-not-answered)"></span> Not Ans</div>
                <div class="legend-item"><span class="dot" style="background:var(--pallet-review)"></span> Review</div>
                <div class="legend-item"><span class="dot" style="background:#555"></span> Locked</div>
            </div>
            <div style="padding:5px; background:#ddd; font-weight:bold; text-align:center;">Question Palette</div>
            <div class="question-grid" id="questionPalette">
                </div>
            <div style="padding:10px; margin-top:auto;">
                <button class="btn btn-primary" style="width:100%" onclick="submitExam()">SUBMIT PAPER</button>
            </div>
        </div>
    </div>

    <div class="footer-controls hidden" id="examFooter">
        <div style="display:flex; gap:10px;">
            <button class="btn btn-danger" onclick="clearResponse()">Clear Response</button>
            <button class="btn btn-warn" onclick="markForReview()">Mark for Review</button>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn" onclick="prevQuestion()" id="btnPrev">Previous</button>
            <button class="btn btn-success" onclick="saveAndNext()">Save & Next</button>
        </div>
    </div>

    <div id="resultPage" class="overlay hidden" style="display:block; overflow-y:auto; justify-content:start; padding-top:40px;">
        <h2>Exam Summary</h2>
        <div id="scoreCard" style="margin: 20px; padding: 20px; border: 1px solid #ccc; text-align: center;">
            </div>
        <div style="display:flex; gap:20px; margin-bottom:20px;">
            <button class="btn btn-primary" onclick="showDetailedReview()">Review Questions</button>
            <button class="btn btn-danger" onclick="resetExam()">Exit / Restart</button>
        </div>
        <div id="detailedReview" class="review-panel" style="width: 90%; max-width: 800px;"></div>
    </div>

    <script type="text/javascript" charset="utf-8">
      // --- 1. Data & Configuration ---
    const TOTAL_QUESTIONS = 100;
    const SET_SIZE = 20; 
    const EXAM_DURATION = 90 * 60; // 90 Minutes

    let questions = [];

   function generateQuestions() {
        const createQ = (id, type, text, opts, ans, exp) => ({ id, type, text, opts, ans, exp });
        questions = []; // Reset array

        // --- SECTION A: NON-CORE (1-20) ---
        // Topics: Reasoning, Data Interpretation, Current Affairs, English

        const nonCoreData = [
            // Logical Reasoning & Math
            ["If 'A' denotes 'divided by', 'C' denotes 'multiplied by', 'F' denotes 'added to', 'J' denotes 'subtracted from', then 24 A 6 F 14 J 6 C 2 = ?", ["10", "6", "12", "16"], 1, "24 / 6 + 14 - (6 * 2) => 4 + 14 - 12 => 18 - 12 = 6."],
            ["Statement: 'Some papers are pens. All the pencils are pens.' Conclusion: 1. Some pens are pencils. 2. Some pens are papers.", ["Only 1 follows", "Only 2 follows", "Both 1 and 2 follow", "Neither follows"], 2, "Standard syllogism logic."],
            ["Find the wrong number in the series: 1, 2, 6, 15, 31, 56, 91", ["31", "91", "56", "15"], 1, "Differences are 1, 4, 9, 16, 25, 36 (Squares). 1+1=2, 2+4=6, 6+9=15, 15+16=31, 31+25=56, 56+36=92. So 91 is wrong."],
            ["A sum of money at simple interest amounts to Rs. 815 in 3 years and to Rs. 854 in 4 years. The sum is:", ["Rs. 650", "Rs. 690", "Rs. 698", "Rs. 700"], 2, "Interest for 1 yr = 854 - 815 = 39. For 3 yrs = 39*3 = 117. Principal = 815 - 117 = 698."],
            ["The angle between the minute hand and the hour hand of a clock when the time is 8:30 is:", ["80 degrees", "75 degrees", "60 degrees", "105 degrees"], 1, "Formula: |(30*H) - (5.5*M)|. |240 - 165| = 75 degrees."],

            // General Knowledge
            ["Which is the largest gland in the human body?", ["Pancreas", "Thyroid", "Liver", "Pituitary"], 2, "Liver."],
            ["The 'Dronacharya Award' is given to:", ["Scientists", "Sports Coaches", "Authors", "Actors"], 1, "Sports Coaches."],
            ["Which city hosted the G20 Summit in 2023?", ["Bali", "New Delhi", "Rio de Janeiro", "Rome"], 1, "New Delhi."],
            ["The chemical formula of 'Laughing Gas' is:", ["NO", "N2O", "NO2", "N2O2"], 1, "Nitrous Oxide (N2O)."],
            ["Who is the Chief of Defence Staff (CDS) of India (as of 2024)?", ["Gen. Bipin Rawat", "Gen. Anil Chauhan", "Gen. M.M. Naravane", "Gen. V.K. Singh"], 1, "Gen. Anil Chauhan."],

            // English & Computer Basics
            ["One word substitution: 'A person who does not believe in God':", ["Theist", "Heretic", "Atheist", "Fanatic"], 2, "Atheist."],
            ["Synonym of 'Inevitable':", ["Uncertain", "Unavoidable", "Doubtful", "Fixed"], 1, "Unavoidable."],
            ["Identify the error: 'He is one of the best boy in the class.'", ["He is", "one of", "best boy", "in the class"], 2, "Should be 'best boys' (One of the plural)."],
            ["'BIOS' stands for:", ["Basic Input Output System", "Binary Input Output System", "Basic Internal Operating System", "Bureau of Information Science"], 0, "Basic Input Output System."],
            ["Which is not an Operating System?", ["Linux", "Windows", "Oracle", "DOS"], 2, "Oracle is a database management system."],
            ["1 Petabyte = ___ Terabytes?", ["1000", "1024", "10^6", "100"], 1, "1024 TB."],
            ["Shortcut key to 'Hyperlink' in MS Word:", ["Ctrl + H", "Ctrl + K", "Ctrl + L", "Alt + K"], 1, "Ctrl + K."],
            ["Antonym of 'Optimistic':", ["Pessimistic", "Hopeful", "Idealistic", "Realistic"], 0, "Pessimistic."],
            ["The study of maps is called:", ["Calligraphy", "Cartography", "Geography", "Geology"], 1, "Cartography."],
            ["'QR Code' stands for:", ["Quick Response Code", "Quality Response Code", "Quick Read Code", "Quality Read Code"], 0, "Quick Response Code."]
        ];
        nonCoreData.forEach((d, i) => questions.push(createQ(i + 1, "Non-Core", d[0], d[1], d[2], d[3])));

        // --- SECTION B: CORE (21-100) ---
        // Topics: Emergency Radiology, Nuclear Medicine, Contrast, Physics, Pathology

        const coreData = [
            // Nuclear Medicine & PET (Critical for modern Radiography exams)
            ["The most common radioisotope used in Gamma Camera is:", ["Iodine-131", "Technetium-99m", "Gallium-67", "Thallium-201"], 1, "Tc-99m (Ideal 140 keV energy, 6hr half-life)."],
            ["PET Scan relies on the detection of:", ["Single Photons", "Annihilation Photons (511 keV)", "Electrons", "Protons"], 1, "Coincidence detection of two 511 keV photons from positron annihilation."],
            ["The crystal used in PET detectors is typically:", ["NaI(Tl)", "LSO / BGO", "CaSO4", "Amorphous Silicon"], 1, "LSO (Lutetium Oxyorthosilicate) or BGO (Bismuth Germanate)."],
            ["'SUV' in PET stands for:", ["Standard Uptake Value", "Specific Uptake Volume", "Standard Unit Value", "Single Unit Volume"], 0, "Standardized Uptake Value (Measure of metabolic activity)."],
            ["Bone Scans (Scintigraphy) use which radiopharmaceutical?", ["Tc-99m Pertechnetate", "Tc-99m MDP", "Tc-99m DTPA", "I-131"], 1, "Methylene Diphosphonate (MDP) binds to hydroxyapatite crystals."],
            ["The 'Half-Life' of Fluorine-18 (used in FDG-PET) is:", ["6 hours", "110 minutes", "68 minutes", "8 days"], 1, "~110 minutes."],
            ["Thyroid uptake study uses:", ["Tc-99m MAA", "I-131 or I-123", "Tc-99m HIDA", "Gallium"], 1, "Radioiodine (I-131/I-123) or Tc-99m Pertechnetate."],
            ["Which collimator is used for high-resolution thyroid imaging?", ["Low Energy All Purpose (LEAP)", "High Energy", "Pinhole", "Parallel Hole"], 2, "Pinhole collimator magnifies small structures like the thyroid."],
            ["'Molybdenum Breakthrough' test checks for:", ["Chemical impurity", "Radionuclidic impurity", "Radiochemical impurity", "pH"], 1, "Presence of parent Mo-99 in the Tc-99m eluate."],
            ["Radiation protection in Nuclear Medicine mainly involves:", ["Lead aprons", "Time, Distance, Shielding (Syringe shields)", "Goggles", "None"], 1, "Source is internal/unsealed; Syringe shields and distance are key."],

            // Radiographic Pathology Signs (Image Based logic)
            ["'Coin Lesion' in the lung refers to:", ["Solitary Pulmonary Nodule", "TB Cavity", "Pneumonia", "Abscess"], 0, "Round, well-defined opacity < 3cm."],
            ["'Golden S Sign' is seen in:", ["Right Upper Lobe Collapse", "Left Lower Lobe Collapse", "Pneumothorax", "Pleural Effusion"], 0, "Collapse of RUL with a central mass creating an S-shape fissure."],
            ["'Deep Sulcus Sign' on a supine chest X-ray indicates:", ["Pneumothorax", "Pleural Effusion", "Pneumonia", "Emphysema"], 0, "Deep costophrenic angle due to air collecting anteriorly."],
            ["'Steeple Sign' of the trachea is characteristic of:", ["Epiglottitis", "Croup (Laryngotracheobronchitis)", "Foreign Body", "Asthma"], 1, "Subglottic narrowing in Croup."],
            ["'Thumb Sign' on Lateral Neck X-ray indicates:", ["Croup", "Epiglottitis", "Retropharyngeal Abscess", "Tonsillitis"], 1, "Swollen Epiglottis."],
            ["'Rigler's Sign' (Double Wall Sign) indicates:", ["Pneumoperitoneum", "Ascites", "Bowel Obstruction", "Volvulus"], 0, "Air on both sides of the bowel wall (free air)."],
            ["'Football Sign' is seen in:", ["Massive Pneumoperitoneum in infants", "Ascites", "Bladder rupture", "Kidney mass"], 0, "Large oval gas shadow in abdomen."],
            ["'Scottie Dog' wearing a collar indicates:", ["Spondylolysis", "Spondylolisthesis", "Normal spine", "Fracture"], 0, "Break in the Pars Interarticularis (the neck of the dog)."],
            ["'Bamboo Spine' is seen in:", ["Ankylosing Spondylitis", "DISH", "Osteoporosis", "Metastasis"], 0, "Fused vertebrae."],
            ["'Codfish Vertebra' (biconcave) is seen in:", ["Osteoporosis / Osteomalacia", "Sickle Cell", "Thalassemia", "Metastasis"], 0, "Softening of bone leads to disc pressure indenting endplates."],

            // Emergency & Trauma Radiology
            ["'eFAST' includes scanning of:", ["Pericardium, Perihepatic, Perisplenic, Pelvis + Lung", "Abdomen only", "Chest only", "Brain"], 0, "Extended FAST includes Pleura (Lung) for Pneumothorax."],
            ["Standard views for Trauma C-Spine:", ["AP, Lateral, Odontoid", "Lateral only", "AP, Lateral, Oblique", "Swimmers only"], 0, "Cross-table Lateral, AP, and Open Mouth Odontoid."],
            ["Which is the most reliable sign of C-spine injury on lateral view?", ["Prevertebral soft tissue swelling", "Loss of lordosis", "Disc spacing", "Osteophytes"], 0, "Soft tissue swelling (>6mm at C2, >22mm at C6)."],
            ["'Jefferson Fracture' involves:", ["Atlas (C1) - Burst fracture", "Axis (C2)", "C7", "Odontoid"], 0, "Burst fracture of C1 ring."],
            ["'Hangman's Fracture' involves:", ["Pars interarticularis of C2", "Dens of C2", "Body of C1", "Spinous process of C7"], 0, "Bilateral pars fracture of C2 (Traumatic Spondylolisthesis)."],
            ["'Clay Shoveler's Fracture' is:", ["Avulsion of spinous process (C7/T1)", "Compression of C5", "Fracture of Clavicle", "Fracture of Scapula"], 0, "Spinous process avulsion."],
            ["'Boxer's Fracture' is usually angulated:", ["Dorsally", "Volarly (Palmar)", "Radially", "Ulnarly"], 1, "Volar angulation of the 5th metacarpal head."],
            ["'Monteggia Fracture-Dislocation' involves:", ["Proximal Ulnar fracture + Radial Head dislocation", "Distal Radius fracture", "Radius fracture + Ulnar dislocation", "Both bones"], 0, "Ulna fracture with Radial Head dislocation."],
            ["'Galeazzi Fracture-Dislocation' involves:", ["Distal Radius fracture + DRUJ dislocation", "Proximal Ulna fracture", "Scaphoid fracture", "Humerus"], 0, "Radius fracture with Distal Radioulnar Joint dislocation."],
            ["'Lisfranc Injury' involves the:", ["Tarso-Metatarsal joints", "Ankle joint", "Knee joint", "Wrist joint"], 0, "Midfoot injury."],

            // Physics (Imaging & Quality)
            ["The 'Air Gap Technique' works by:", ["Reducing scatter reaching the film", "Increasing scatter", "Magnifying noise", "Reducing dose"], 0, "Distance allows divergent scatter to miss the receptor."],
            ["Use of a Compression band in abdominal radiography:", ["Reduces tissue thickness & Scatter", "Increases dose", "Increases motion", "Reduces contrast"], 0, "Thinner part = Less scatter = Better contrast."],
            ["'Crossover' effect in screen-film radiography causes:", ["Blurring / Loss of sharpness", "Increased contrast", "Fog", "Speed increase"], 0, "Light from one screen crosses base to expose other emulsion."],
            ["Which layer of the X-ray film is the 'Active' layer?", ["Base", "Emulsion", "Adhesive", "Supercoat"], 1, "Emulsion contains the Silver Halide crystals."],
            ["Latent image formation theory is known as:", ["Gurney-Mott Theory", "Compton Theory", "Bohr Theory", "Einstein Theory"], 0, "Gurney-Mott Hypothesis."],
            ["Standard developer temperature for automatic processors:", ["35°C (95°F)", "20°C", "50°C", "25°C"], 0, "Typically 33-35 degrees Celsius."],
            ["'Replenishment' in processing prevents:", ["Exhaustion of chemicals", "Overdevelopment", "Fog", "Drying"], 0, "Keeps chemical activity stable."],
            ["The 'Safe Light' filter 'GBX-2' allows which light?", ["Red", "Blue", "Green", "Yellow"], 0, "Deep Red (safe for green and blue sensitive films)."],
            ["'Reticulation' of film is caused by:", ["Sudden temperature change between solutions", "Old developer", "Light leak", "Static"], 0, "Cracked emulsion appearance."],
            ["'Pi Lines' on a processed film indicate:", ["Dirt on rollers", "Light leak", "Static", "Fog"], 0, "Dirt on a roller (lines occur at circumference intervals)."],

            // CT & MRI Advanced Protocols
            ["Triple Phase CT Liver includes:", ["Arterial, Portal Venous, Delayed", "Plain, Arterial, Venous", "Arterial, Venous, Excretory", "None"], 0, "Late Arterial, Portal Venous, Equilibrium/Delayed."],
            ["CT Pulmonary Angiography (CTPA) bolus tracking ROI is placed in:", ["Main Pulmonary Artery", "Aorta", "Left Ventricle", "SVC"], 0, "Main Pulmonary Artery."],
            ["'Blooming Artifact' in CT is caused by:", ["Calcification / Metal", "Water", "Air", "Fat"], 0, "High density objects appear larger than they are."],
            ["Which MRI sequence is the 'Gold Standard' for ACL tear?", ["Sagittal PD / T2", "Axial T1", "Coronal STIR", "Axial GRE"], 0, "Sagittal Proton Density or T2."],
            ["For MRI Pituitary, the crucial plane is:", ["Sagittal & Coronal", "Axial only", "Oblique", "Radial"], 0, "Coronal and Sagittal thin sections."],
            ["'MRA' of the Circle of Willis typically uses:", ["3D TOF (Time of Flight)", "2D TOF", "Phase Contrast", "Contrast Enhanced"], 0, "3D TOF (Non-contrast)."],
            ["Diffusion Tensor Imaging (DTI) maps:", ["White matter tracts", "Blood flow", "CSF flow", "Cortical thickness"], 0, "Tractography of white matter."],
            ["MR Spectroscopy (MRS) measures:", ["Metabolites (Choline, NAA, Lactate)", "Blood volume", "Water content", "T1 relaxation"], 0, "Metabolic composition of tissue."],
            ["CT 'Cystography' is used for:", ["Bladder rupture / Leak", "Kidney stone", "Ureter stricture", "Prostate"], 0, "Trauma bladder assessment."],
            ["What is 'Dual Source CT'?", ["Two tubes and two detectors at 90 degrees", "Two monitors", "Two generators", "Double dose"], 0, "High temporal resolution (Cardiac CT)."],

            // Anatomy (Sectional & General)
            ["On a chest PA view, the right heart border is formed by:", ["Right Atrium", "Right Ventricle", "SVC", "Aorta"], 0, "Right Atrium."],
            ["The left heart border is formed by:", ["Left Ventricle & Auricle", "Left Atrium", "Right Ventricle", "Pulmonary Artery"], 0, "Left Ventricle and Left Atrial Appendage (Auricle)."],
            ["The 'Aortic Knuckle' is seen on the:", ["Left side of mediastinum", "Right side", "Center", "Base"], 0, "Left upper mediastinum."],
            ["In the localized view of the optic foramen (Rhese method), the optic foramen is located in the:", ["Lower outer quadrant of the orbit", "Upper outer quadrant", "Center", "Lower inner"], 0, "Lower outer quadrant."],
            ["The 'Vertebra Prominens' is:", ["C7", "C1", "C2", "T1"], 0, "C7 (Long spinous process)."],
            ["The 'Cystic Artery' supplies the:", ["Gallbladder", "Liver", "Pancreas", "Spleen"], 0, "Gallbladder."],
            ["'Pouch of Douglas' is located:", ["Between Rectum and Uterus", "Between Bladder and Uterus", "Behind Liver", "Around Kidney"], 0, "Rectouterine pouch."],
            ["The 'Phrenic Nerve' supplies the:", ["Diaphragm", "Heart", "Lungs", "Stomach"], 0, "Diaphragm."],
            ["Which sinus is the last to develop?", ["Frontal", "Maxillary", "Ethmoid", "Sphenoid"], 0, "Frontal sinuses develop after birth (around age 6-7)."],
            ["The 'Carpal Tunnel' contains:", ["Median Nerve", "Ulnar Nerve", "Radial Nerve", "Axillary Nerve"], 0, "Median Nerve and flexor tendons."],

            // Contrast & Pharmacology
            ["Contrast Induced Nephropathy (CIN) risk is reduced by:", ["Hydration", "Loop diuretics", "N-acetylcysteine", "A and C"], 3, "Hydration is key. NAC is controversial but used. Diuretics are bad."],
            ["Standard dose of Gadolinium is:", ["0.1 mmol/kg", "1.0 mmol/kg", "0.01 mmol/kg", "0.5 mmol/kg"], 0, "0.1 mmol/kg body weight."],
            ["Which drug is used to treat Anaphylactic shock in Radiology?", ["Adrenaline (Epinephrine)", "Atropine", "Heparin", "Digoxin"], 0, "Adrenaline (IM 1:1000)."],
            ["Buscopan (Hyoscine) is used in MRI/CT to:", ["Reduce bowel peristalsis (Motion)", "Enhance contrast", "Sedate patient", "Treat pain"], 0, "Anti-spasmodic to stop bowel motion artifacts."],
            ["Metformin should be stopped before contrast CT because:", ["Risk of Lactic Acidosis", "Risk of bleeding", "Reduces contrast effect", "Causes nausea"], 0, "If CIN occurs, Metformin accumulation causes Lactic Acidosis."],
            ["Osmolality of Non-ionic contrast media is:", ["Lower than Ionic high-osmolar", "Higher than Ionic", "Same as plasma", "Zero"], 0, "Lower than old ionic agents (usually 600-800 mOsm/kg, still higher than plasma)."],
            ["Iso-osmolar contrast media (e.g., Visipaque) has osmolality equal to:", ["Blood (290 mOsm/kg)", "Urine", "CSF", "Water"], 0, "Isotonic to blood."],
            ["Barium Sulfate is:", ["Insoluble in water", "Soluble in water", "Soluble in acid", "Gas"], 0, "Insoluble suspension."],
            ["Gastrografin is indicated when:", ["Suspected perforation", "Aspiration risk", "Barium allergy", "Normal study"], 0, "Water soluble - safe for peritoneum (but dangerous if aspirated to lungs)."],
            ["Gadolinium is toxic in free form, so it is:", ["Chelated", "Ionized", "Frozen", "Boiled"], 0, "Chelated with a ligand to make it safe."]
        ];

        coreData.forEach((d, i) => questions.push(createQ(21 + i, "Core", d[0], d[1], d[2], d[3])));
    }
    
    // Call the function to populate the array immediately
    generateQuestions();
    
    // --- 2. State Management ---
    let state = {
        currentQ: 0,
        answers: new Array(TOTAL_QUESTIONS).fill(null),
        status: new Array(TOTAL_QUESTIONS).fill('not-visited'),
        timeLeft: EXAM_DURATION,
        isFinished: false,
        maxSetReached: 0
    };

    // --- 3. DOM Elements (Ensure these match your HTML IDs) ---
    const els = {
        landing: document.getElementById('landingPage'),
        header: document.getElementById('examHeader'),
        body: document.getElementById('examBody'),
        footer: document.getElementById('examFooter'),
        result: document.getElementById('resultPage'),
        qText: document.getElementById('questionText'),
        optsBox: document.getElementById('optionsBox'),
        qNum: document.getElementById('qNumDisplay'),
        palette: document.getElementById('questionPalette'),
        timer: document.getElementById('timerDisplay'),
        btnPrev: document.getElementById('btnPrev'),
        sidebar: document.getElementById('sidebar')
    };

    // --- 4. Logic Functions ---

    function init() {
        const savedState = localStorage.getItem('aiims_cbt_state');
        if (savedState) {
            try {
                const parsed = JSON.parse(savedState);
                // Validate if saved state matches current question count
                if(parsed.answers.length === TOTAL_QUESTIONS) {
                    state = parsed;
                    if (state.isFinished) {
                        showResult();
                        return;
                    }
                    renderExamInterface();
                    startTimer();
                } else {
                    // Reset if question count changed
                    localStorage.removeItem('aiims_cbt_state');
                    els.landing.classList.remove('hidden');
                }
            } catch(e) {
                 els.landing.classList.remove('hidden');
            }
        } else {
            els.landing.classList.remove('hidden');
            els.result.classList.add('hidden');
        }
    }

    function startExam() {
        els.landing.classList.add('hidden');
        renderExamInterface();
        startTimer();
        updatePersistence();
    }

    function renderExamInterface() {
        els.header.classList.remove('hidden');
        els.body.classList.remove('hidden');
        els.footer.classList.remove('hidden');
        renderPalette();
        loadQuestion(state.currentQ);
    }

    function loadQuestion(index) {
        state.currentQ = index;
        if(state.status[index] === 'not-visited') {
            state.status[index] = 'not-answered';
        }
        
        // Update UI
        els.qNum.innerText = `Question No. ${index + 1} (${questions[index].type})`;
        els.qText.innerText = questions[index].text;
        
        els.optsBox.innerHTML = '';
        questions[index].opts.forEach((opt, i) => {
            const isChecked = state.answers[index] === i ? 'checked' : '';
            els.optsBox.innerHTML += `
                <label class="option-label">
                    <input type="radio" name="opt" value="${i}" ${isChecked} onchange="selectOption(${i})">
                    ${opt}
                </label>
            `;
        });

        document.querySelectorAll('.q-btn').forEach(b => b.classList.remove('current'));
        const currentBtn = document.getElementById(`qbtn-${index}`);
        if(currentBtn) currentBtn.classList.add('current');

        // Locking Logic
        els.btnPrev.disabled = (index === 0) || (Math.floor((index - 1) / SET_SIZE) < state.maxSetReached);

        updatePersistence();
    }

    function selectOption(optIndex) {
        state.answers[state.currentQ] = optIndex;
    }

    function saveAndNext() {
        const index = state.currentQ;
        if (state.answers[index] !== null) {
            state.status[index] = 'answered';
        } else {
            state.status[index] = 'not-answered';
        }
        moveToNextQuestion();
    }

    function markForReview() {
        const index = state.currentQ;
        if (state.answers[index] !== null) {
            state.status[index] = 'marked-answered';
        } else {
            state.status[index] = 'review';
        }
        moveToNextQuestion();
    }

    function clearResponse() {
        state.answers[state.currentQ] = null;
        state.status[state.currentQ] = 'not-answered';
        loadQuestion(state.currentQ);
        renderPalette();
    }

    function moveToNextQuestion() {
        const nextIndex = state.currentQ + 1;
        const currentSet = Math.floor(state.currentQ / SET_SIZE);
        const nextSet = Math.floor(nextIndex / SET_SIZE);

        if (nextSet > currentSet && nextSet <= Math.floor((TOTAL_QUESTIONS-1)/SET_SIZE)) {
            if (!confirm(`You are about to leave Section ${currentSet + 1}. You CANNOT return to these questions once you proceed. Continue?`)) {
                return;
            }
            state.maxSetReached = nextSet;
        }

        if (nextIndex < TOTAL_QUESTIONS) {
            renderPalette();
            loadQuestion(nextIndex);
        } else {
            renderPalette();
            alert("You have reached the last question.");
        }
    }

    function prevQuestion() {
        if (state.currentQ > 0) {
            const prevIndex = state.currentQ - 1;
            if (Math.floor(prevIndex / SET_SIZE) < state.maxSetReached) {
                alert("Previous section is locked.");
                return;
            }
            loadQuestion(prevIndex);
        }
    }

    function renderPalette() {
        els.palette.innerHTML = '';
        for (let i = 0; i < TOTAL_QUESTIONS; i++) {
            let statusClass = state.status[i];
            const isLocked = Math.floor(i / SET_SIZE) < state.maxSetReached;
            const lockedClass = isLocked ? ' locked' : '';

            els.palette.innerHTML += `
                <div id="qbtn-${i}" 
                        class="q-btn ${statusClass}${lockedClass}" 
                        onclick="jumpToQuestion(${i})">
                    ${i + 1}
                </div>
            `;
        }
    }

    function jumpToQuestion(index) {
        if (Math.floor(index / SET_SIZE) < state.maxSetReached) {
            alert("This section is locked.");
            return;
        }
        const targetSet = Math.floor(index / SET_SIZE);
        if (targetSet > state.maxSetReached) {
            alert("You must complete the current section first.");
            return;
        }
        loadQuestion(index);
    }

    let timerInterval;
    function startTimer() {
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            state.timeLeft--;
            const m = Math.floor(state.timeLeft / 60);
            const s = state.timeLeft % 60;
            els.timer.innerText = `${m}:${s < 10 ? '0'+s : s}`;
            
            if (state.timeLeft % 5 === 0) updatePersistence(); 

            if (state.timeLeft <= 0) {
                clearInterval(timerInterval);
                submitExam();
            }
        }, 1000);
    }

    function submitExam() {
        if (confirm("Are you sure you want to submit the exam?")) {
            finishExam();
        }
    }

    function finishExam() {
        clearInterval(timerInterval);
        state.isFinished = true;
        updatePersistence();
        
        els.header.classList.add('hidden');
        els.body.classList.add('hidden');
        els.footer.classList.add('hidden');
        els.result.classList.remove('hidden');
        
        calculateResult();
    }
    
    // Fixed: Added showResult to recover session on reload if finished
    function showResult() {
         els.header.classList.add('hidden');
         els.body.classList.add('hidden');
         els.footer.classList.add('hidden');
         els.result.classList.remove('hidden');
         calculateResult();
    }

    function calculateResult() {
        let correct = 0;
        let wrong = 0;
        let unattempted = 0;
        let score = 0;

        state.answers.forEach((ans, i) => {
            if (ans === null) {
                unattempted++;
            } else if (ans === questions[i].ans) {
                correct++;
                score += 4;
            } else {
                wrong++;
                score -= 1;
            }
        });

        document.getElementById('scoreCard').innerHTML = `
            <h1>Your Score: ${score} / 400</h1>
            <p>Correct: <span style="color:green">${correct}</span> | Wrong: <span style="color:red">${wrong}</span> | Unattempted: ${unattempted}</p>
        `;
    }

    function showDetailedReview() {
        const container = document.getElementById('detailedReview');
        container.style.display = 'block';
        container.innerHTML = '<h3>Detailed Solutions</h3>';
        
        questions.forEach((q, i) => {
            const userAns = state.answers[i];
            const isCorrect = userAns === q.ans;
            const statusColor = userAns === null ? 'gray' : (isCorrect ? 'green' : 'red');
            const statusText = userAns === null ? 'Skipped' : (isCorrect ? 'Correct' : 'Incorrect');

            let optsHtml = '';
            q.opts.forEach((opt, oi) => {
                let style = '';
                if (oi === q.ans) style = 'font-weight:bold; color:green;'; 
                if (oi === userAns && !isCorrect) style = 'font-weight:bold; color:red;'; 
                optsHtml += `<div style="${style}">${oi+1}. ${opt}</div>`;
            });

            container.innerHTML += `
                <div class="review-item">
                    <div style="color:${statusColor}; font-weight:bold; margin-bottom:5px;">Q${i+1}: ${statusText}</div>
                    <div>${q.text}</div>
                    <div style="margin:10px 0; padding-left:15px; border-left:3px solid #ddd;">${optsHtml}</div>
                    <div class="explanation"><strong>Explanation:</strong> ${q.exp}</div>
                </div>
            `;
        });
    }

    function resetExam() {
        localStorage.removeItem('aiims_cbt_state');
        location.reload();
    }

    function updatePersistence() {
        localStorage.setItem('aiims_cbt_state', JSON.stringify(state));
    }
    
    function toggleSidebar() {
        els.sidebar.classList.toggle('active');
    }

    init();
    </script>
</body>
</html>
