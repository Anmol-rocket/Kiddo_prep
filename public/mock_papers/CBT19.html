<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIIMS CBT - Sectional Timing Mode</title>
    <style>
        :root {
            --header-bg: #3f51b5;
            --header-text: #fff;
            --panel-bg: #f5f5f5;
            --pallet-answered: #4caf50;
            --pallet-not-answered: #f44336;
            --pallet-review: #9c27b0;
            --pallet-not-visited: #e0e0e0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; }
        body { height: 100vh; display: flex; flex-direction: column; overflow: hidden; background: #fff; }

        /* --- Header --- */
        header {
            background: var(--header-bg); color: var(--header-text);
            padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
            height: 60px; flex-shrink: 0;
        }
        .timer { font-size: 1.2rem; font-weight: bold; background: #fff; color: #d32f2f; padding: 5px 15px; border-radius: 4px; border: 2px solid #d32f2f; }

        /* --- Main Layout --- */
        .main-container { display: flex; flex: 1; overflow: hidden; }
        
        .question-area { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; }
        .q-header { display: flex; justify-content: space-between; border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-bottom: 15px; }
        .q-text { font-size: 1.1rem; margin-bottom: 20px; line-height: 1.5; }
        
        .options-container { display: flex; flex-direction: column; gap: 10px; }
        .option-label { 
            display: flex; align-items: center; padding: 10px; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; transition: 0.2s; 
        }
        .option-label:hover { background: #f0f8ff; }
        .option-label input { margin-right: 15px; transform: scale(1.2); }

        /* Sidebar */
        .sidebar {
            width: 320px; background: var(--panel-bg); border-left: 1px solid #ccc;
            display: flex; flex-direction: column; flex-shrink: 0;
        }
        .user-info { padding: 10px; background: #e8eaf6; border-bottom: 1px solid #ccc; }
        
        .palette-legend { padding: 10px; font-size: 0.8rem; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; background: #fff; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }

        .question-grid { 
            padding: 10px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; 
            overflow-y: auto; flex: 1; align-content: start;
        }
        .q-btn {
            height: 35px; width: 35px; border: 1px solid #ccc; background: #fff; 
            border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
        }
        
        .q-btn.answered { background: var(--pallet-answered); color: white; border-color: var(--pallet-answered); }
        .q-btn.not-answered { background: var(--pallet-not-answered); color: white; border-color: var(--pallet-not-answered); }
        .q-btn.review { background: var(--pallet-review); color: white; border-radius: 50%; }
        .q-btn.current { border: 2px solid blue; box-shadow: 0 0 5px blue; }
        .q-btn.locked { opacity: 0.4; cursor: not-allowed; background: #444 !important; color: #888; border: 1px solid #000; }

        /* Footer */
        .footer-controls {
            height: 60px; background: #fff; border-top: 1px solid #ccc;
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
        }
        .btn { padding: 8px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.9rem; }
        .btn-primary { background: #2196f3; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-warn { background: #ff9800; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Mobile */
        .mobile-toggle { display: none; background: none; border: none; color: white; font-size: 1.5rem; }
        @media (max-width: 768px) {
            .mobile-toggle { display: block; }
            .sidebar { 
                position: absolute; right: 0; top: 60px; bottom: 60px; z-index: 100;
                transform: translateX(100%); transition: transform 0.3s; width: 85%;
            }
            .sidebar.active { transform: translateX(0); }
            .question-grid { grid-template-columns: repeat(6, 1fr); }
            .footer-controls { flex-wrap: wrap; gap: 5px; height: auto; padding: 10px; }
            .btn { flex: 1; padding: 8px; font-size: 0.8rem; }
        }

        /* Overlay */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .hidden { display: none !important; }
        
        .review-panel { display: none; padding: 20px; height: 100%; overflow-y: auto; background:#f9f9f9;}
        .review-item { margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 5px; background:white; }
        .explanation { background: #fff3cd; padding: 10px; margin-top: 10px; font-size: 0.9rem; border-left: 4px solid #ffc107; }

    </style>
</head>
<body>

    <div id="landingPage" class="overlay">
        <h1>AIIMS CRE CBT (Strict Pattern)</h1>
        <div style="width: 80%; max-width: 600px; text-align: left; margin: 20px 0;">
            <h3>Exam Rules:</h3>
            <ul>
                <li><strong>Questions:</strong> 100 (5 Sections of 20 questions each).</li>
                <li><strong>Timing:</strong> 18 Minutes per section (Strictly Dedicated).</li>
                <li><strong>Total Time:</strong> 90 Minutes.</li>
                <li><strong>Locking:</strong> Once 18 mins are up, or if you manually proceed to the next section, you <u>cannot</u> return to the previous section.</li>
                <li><strong>Marking:</strong> +4 Correct, -1 Incorrect.</li>
            </ul>
        </div>
        <button class="btn btn-success" style="font-size: 1.2rem;" onclick="startExam()">START EXAM</button>
    </div>

    <header id="examHeader" class="hidden">
        <div style="display:flex; align-items:center; gap:10px;">
            <h3>AIIMS Radiographer</h3>
            <span style="font-size:0.8rem; background:#eee; padding:2px 6px; border-radius:4px; color:#333;" id="sectionLabel">Section 1</span>
        </div>
        <div class="timer" id="timerDisplay">18:00</div>
        <button class="mobile-toggle" onclick="toggleSidebar()">☰</button>
    </header>

    <div class="main-container hidden" id="examBody">
        <div class="question-area">
            <div class="q-header">
                <span id="qNumDisplay">Question No. 1</span>
                <span style="color: #666;">Marks: +4, -1</span>
            </div>
            <div id="questionText" class="q-text">Loading...</div>
            <div id="optionsBox" class="options-container"></div>
        </div>

        <div class="sidebar" id="sidebar">
            <div class="user-info">
                <strong>Candidate Name</strong><br><small>Roll No: 123456</small>
            </div>
            <div class="palette-legend">
                <div class="legend-item"><span class="dot" style="background:var(--pallet-answered)"></span> Ans</div>
                <div class="legend-item"><span class="dot" style="background:var(--pallet-not-answered)"></span> Not Ans</div>
                <div class="legend-item"><span class="dot" style="background:var(--pallet-review)"></span> Review</div>
                <div class="legend-item"><span class="dot" style="background:#444"></span> Locked</div>
            </div>
            <div class="question-grid" id="questionPalette"></div>
            <div style="padding:10px; margin-top:auto;">
                <button class="btn btn-primary" style="width:100%" onclick="submitExam()">FINISH EXAM</button>
            </div>
        </div>
    </div>

    <div class="footer-controls hidden" id="examFooter">
        <div style="display:flex; gap:10px;">
            <button class="btn btn-danger" onclick="clearResponse()">Clear</button>
            <button class="btn btn-warn" onclick="markForReview()">Review</button>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn" onclick="prevQuestion()" id="btnPrev">Previous</button>
            <button class="btn btn-success" onclick="saveAndNext()">Save & Next</button>
        </div>
    </div>

    <div id="resultPage" class="overlay hidden" style="display:block; overflow-y:auto; justify-content:start; padding-top:40px;">
        <h2 style="text-align:center;">Exam Summary</h2>
        <div id="scoreCard" style="margin: 20px auto; width:90%; max-width:600px; padding: 20px; border: 1px solid #ccc; text-align: center; background:#fff;"></div>
        <div style="display:flex; justify-content:center; gap:20px; margin-bottom:20px;">
            <button class="btn btn-primary" onclick="showDetailedReview()">Review Solutions</button>
            <button class="btn btn-danger" onclick="location.reload()">Exit</button>
        </div>
        <div id="detailedReview" class="review-panel" style="width: 90%; max-width: 800px; margin:0 auto;"></div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const TOTAL_QUESTIONS = 100;
        const SECTION_SIZE = 20; // 20 questions per section
        const SECTION_TIME_LIMIT = 18 * 60; // 18 minutes in seconds
        
        let questions = [];

function generateQuestions() {
    const createQ = (id, type, text, opts, ans, exp) => ({ id, type, text, opts, ans, exp });

    // --- HELPER: Randomize Options & Update Answer Index ---
    const addShuffled = (arr, id, type, data) => {
        let [text, opts, origAns, exp] = data;

        // 1. Get the actual text of the correct answer before shuffling
        const correctText = opts[origAns];

        // 2. Shuffle options using Fisher-Yates algorithm
        let shuffledOpts = [...opts];
        for (let i = shuffledOpts.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffledOpts[i], shuffledOpts[j]] = [shuffledOpts[j], shuffledOpts[i]];
        }

        // 3. Find the new index of the correct answer
        const newAns = shuffledOpts.indexOf(correctText);

        // 4. Push valid object to array
        arr.push(createQ(id, type, text, shuffledOpts, newAns, exp));
    };

    questions = []; // Reset array

    // --- SECTION A: NON-CORE (1-20) ---
    // Difficulty: High (Time-consuming Logic & Specific GK)

    const nonCoreData = [
        // Reasoning & Math
        ["The price of an article is cut by 20%. To restore it to the former value, the new price must be increased by:", ["20%", "25%", "16.66%", "24%"], 1, "Let price = 100. New price = 80. To get back to 100, increase by 20. % Increase = (20/80)*100 = 25%."],
        ["If 'P' means 'divide', 'R' means 'add', 'S' means 'subtract' and 'Q' means 'multiply', then what is the value of: 48 P 4 R 3 Q 4 S 6 ?", ["18", "16", "20", "6"], 0, "48 / 4 + 3 * 4 - 6 => 12 + 12 - 6 = 18."],
        ["Statement: 'The exams are approaching. We should start revising.' Assumption I: Revision helps in exams. Assumption II: Exams are difficult.", ["Only I is implicit", "Only II is implicit", "Both I and II are implicit", "Neither is implicit"], 0, "We revise *because* it helps (I). We don't know if exams are difficult or easy, just that they are approaching."],
        ["Find the missing number in the series: 3, 12, 27, 48, 75, ?", ["108", "100", "99", "120"], 0, "Differences: 9, 15, 21, 27 (Increasing by 6). Next diff is 33. 75+33 = 108."],
        ["A is B's sister. C is B's mother. D is C's father. E is D's mother. Then, how is A related to D?", ["Grandmother", "Granddaughter", "Daughter", "Aunt"], 1, "A is daughter of C. C is daughter of D. So A is Granddaughter of D. "],

        // GK (Static & Current)
        ["The 'Dadasaheb Phalke Lifetime Achievement Award' for the year 2021 (presented in 2023) was conferred upon:", ["Waheeda Rehman", "Asha Parekh", "Rajinikanth", "Amitabh Bachchan"], 0, "Waheeda Rehman."],
        ["Which gas is known as 'Marsh Gas'?", ["Methane", "Ethane", "Propane", "Butane"], 0, "Methane (CH4)."],
        ["The 'Palk Strait' separates India from:", ["Maldives", "Sri Lanka", "Myanmar", "Indonesia"], 1, "Sri Lanka. "],
        ["'Article 21' of the Indian Constitution guarantees:", ["Right to Property", "Right to Education", "Protection of Life and Personal Liberty", "Freedom of Speech"], 2, "Life and Personal Liberty."],
        ["Which Indian state has the highest number of Ramsar Sites (Wetlands)?", ["Uttar Pradesh", "Tamil Nadu", "West Bengal", "Odisha"], 1, "Tamil Nadu (14 sites)."],

        // English
        ["Synonym of 'PERUSE':", ["To misuse", "To read carefully", "To ignore", "To copy"], 1, "To read or examine thoroughly."],
        ["Antonym of 'OBSOLETE':", ["Old", "Ancient", "Contemporary", "Extinct"], 2, "Contemporary (Modern/Current)."],
        ["'A bolt from the blue' means:", ["A thunderstorm", "Something unexpected", "A bright light", "A blue sky"], 1, "A sudden, unexpected event."],
        ["'He is blind ___ one eye.'", ["of", "in", "to", "with"], 1, "Blind IN one eye."],
        ["Correct spelling:", ["Bureaucracy", "Beureaucracy", "Bureacracy", "Bureaucrasy"], 0, "Bureaucracy."],

        // Computers
        ["'Ctrl + J' in MS Word is used to:", ["Justify Align", "Jump", "Join", "Italicize"], 0, "Justify text."],
        ["Which of the following is NOT a valid IP address?", ["192.168.1.1", "10.0.0.50", "256.1.1.1", "172.16.0.1"], 2, "Octets cannot exceed 255."],
        ["The speed of a laser printer is measured in:", ["DPI", "PPM (Pages Per Minute)", "CPS", "LPM"], 1, "PPM."],
        ["'BIOS' is stored in:", ["RAM", "Hard Disk", "ROM / Flash Memory", "Cache"], 2, "ROM/Flash (Non-volatile)."],
        ["Which logic gate returns 'True' only if both inputs are 'True'?", ["OR", "AND", "NOT", "XOR"], 1, 'AND Gate. [Image of AND gate truth table]'
]
    ];

    // Shuffle and Add Non-Core
    nonCoreData.forEach((d, i) => addShuffled(questions, i + 1, "Non-Core", d));


    // --- SECTION B: CORE (21-100) ---
    // Randomized Answers & Clinical Focus

    const coreData = [
        // 1. Physics & Quality (21-40)
        ["The 'Focal Spot' size is determined by:", ["The filament size", "The anode angle", "The focusing cup", "All of the above"], 3, "Filament size (actual electron beam width) and Angle (effective size) both matter."],
        ["Which interaction is responsible for 'Subject Contrast' in the latent image?", ["Compton Scattering", "Photoelectric Effect", "Coherent Scattering", "Pair Production"], 1, "Photoelectric effect (Differential absorption)."],
        ["If the SID is halved (e.g., 72 to 36 inches) and technical factors remain unchanged, the intensity at the image receptor will:", ["Decrease by half", "Increase by 2 times", "Increase by 4 times", "Decrease to 1/4"], 2, "Inverse Square Law: Intensity is inversely proportional to distance squared. (1/0.5)^2 = 4x."],
        ["The 'Back-up Timer' for an AEC system should be set to:", ["100% of the expected mAs", "150% - 200% of the expected mAs", "50% of the expected mAs", "0.1 seconds"], 1, "150% (1.5 times) to allow for variations but prevent tube overload."],
        ["In digital imaging, 'Window Level' determines:", ["Image Contrast", "Image Brightness", "Spatial Resolution", "Matrix Size"], 1, "Window Level controls Brightness."],
        ["Which grid error results in 'Grid Cutoff' across the entire image (uniform loss of density)?", ["Off-Center", "Off-Focus", "Off-Level (Tilted)", "Upside Down"], 2, "Off-Level (Grid tilted relative to beam) affects the whole image uniformly. "],
        ["'DQE' (Detective Quantum Efficiency) is highest for which detector material?", ["Amorphous Selenium (a-Se)", "Gadolinium Oxysulfide", "Cesium Iodide (CsI)", "Barium Fluorohalide"], 2, "CsI has high absorption efficiency and light yield."],
        ["To reduce 'Quantum Mottle' (Noise) in a CR image, the radiographer should:", ["Increase kVp", "Increase mAs", "Decrease mAs", "Increase Grid Ratio"], 1, "Increase the number of photons (Signal)."],
        ["The 'Air Gap Technique' acts similar to a grid of what ratio?", ["5:1", "8:1", "12:1", "16:1"], 1, "Generally cited as equivalent to an 8:1 grid."],
        ["'Filtration' of the X-ray beam primarily removes:", ["High energy photons", "Low energy photons", "Scatter radiation", "Off-focus radiation"], 1, "Low energy (soft) rays that only contribute to patient dose."],
        ["'Flux Gain' in an Image Intensifier describes:", ["Increase in brightness due to minification", "Increase in brightness due to acceleration of electrons (conversion efficiency)", "Total brightness gain", "Resolution gain"], 1, "Gain from high energy electrons striking output phosphor."],
        ["The 'Latent Image' in a CR plate will fade by approximately ___% in 8 hours.", ["10%", "25%", "50%", "100%"], 1, "25% signal loss in 8 hours."],
        ["Which dosimeter is most sensitive to low levels of radiation?", ["Film Badge", "TLD", "OSL", "Pocket Ion Chamber"], 2, "OSL (Optically Stimulated Luminescence) can detect ~1 mrem."],
        ["The 'Half Value Layer' (HVL) measures:", ["Beam Quantity", "Beam Quality", "Scatter", "Leakage"], 1, "Penetrability/Quality."],
        ["'Leakage Radiation' limit for a diagnostic housing is:", ["10 mR/hr at 1m", "100 mR/hr at 1m", "500 mR/hr at 1m", "1 R/hr at 1m"], 1, "100 mR/hr (1 mGy/hr)."],
        ["'Geometric Unsharpness' is minimized by:", ["Small Focal Spot, Long SID, Short OID", "Large Focal Spot, Short SID, Long OID", "Small Focal Spot, Short SID, Long OID", "Large Focal Spot, Long SID, Short OID"], 0, "Small FSS, Max SID, Min OID."],
        ["In MRI, 'Quenching' refers to:", ["Starting the magnet", "Rapid loss of superconductivity and helium boil-off", "Image reconstruction", "Patient sedation"], 1, "Emergency shutdown."],
        ["'Pixel Pitch' is defined as:", ["The distance from the center of one pixel to the center of the adjacent pixel", "The size of the pixel", "The number of pixels", "The bit depth"], 0, "Center-to-center distance."],
        ["The 'Anode Heel Effect' is utilized for AP T-spine by placing the:", ["Head under the Anode", "Head under the Cathode", "Feet under the Cathode", "Center under the Anode"], 0, "Upper T-spine is thinner than lower. Anode (weaker beam) goes over thinner part (Head). "],
        ["'AERB' stands for:", ["Atomic Energy Research Board", "Atomic Energy Regulatory Board", "All India Energy Board", "Association of Energy Regulation"], 1, "Atomic Energy Regulatory Board."],

        // 2. Anatomy & Procedures (41-65)
        ["The 'Sustentaculum Tali' is found on the:", ["Talus", "Calcaneus", "Navicular", "Cuboid"], 1, "Calcaneus (Medial shelf)."],
        ["'Bennett's Fracture' is an intra-articular fracture of the:", ["Base of 5th Metacarpal", "Base of 1st Metacarpal", "Distal Radius", "Scaphoid"], 1, "Base of Thumb. "],
        ["Which projection best demonstrates the 'Radial Head'?", ["Lateral Elbow", "AP Elbow", "Lateral Oblique (External Rotation)", "Medial Oblique"], 2, "External Oblique removes superimposition."],
        ["To visualize the 'Pars Interarticularis' (Scottie Dog neck) of the Lumbar spine, the patient is rotated:", ["90 degrees", "45 degrees", "30 degrees", "70 degrees"], 1, "45 degree oblique. "],
        ["'Colles Fracture' involves the distal radius with ___ angulation.", ["Volar (Anterior)", "Dorsal (Posterior)", "Medial", "Lateral"], 1, "Dorsal (Dinner fork). "],
        ["'Smith's Fracture' involves the distal radius with ___ angulation.", ["Volar (Anterior)", "Dorsal (Posterior)", "Medial", "Lateral"], 0, "Volar (Garden spade)."],
        ["The 'Garth View' (Apical Oblique) is best for:", ["Anterior Dislocation", "Posterior Dislocation / Hill-Sachs", "AC Separation", "Clavicle fracture"], 1, "Posterior dislocation."],
        ["'Stenvers View' demonstrates:", ["Petrous Temporal Bone", "Orbits", "Mandible", "Sella"], 0, "Petrous ridge."],
        ["'Waters View' (Parietoacanthial) projects the Petrous Ridges:", ["Into the lower 1/3 of orbits", "Below the Maxillary Sinuses", "Over the Maxillary Sinuses", "Above the orbits"], 1, "Just below the maxillary floor. "],
        ["'Sialography' investigates the:", ["Spinal Canal", "Salivary Glands", "Bile Ducts", "Veins"], 1, "Salivary glands."],
        ["'Hysterosalpingography' (HSG) checks for:", ["Tubal Patency", "Ovarian Cysts", "Pregnancy", "Cervical Cancer"], 0, "Fallopian tube blockage. "],
        ["In 'Myelography', contrast is injected into:", ["Epidural Space", "Subarachnoid Space", "Subdural Space", "Disc Space"], 1, "Subarachnoid space (CSF)."],
        ["The 'Common Bile Duct' empties into the:", ["Stomach", "Duodenum (2nd Part)", "Jejunum", "Ileum"], 1, "Ampulla of Vater."],
        ["'McBurney's Point' tenderness indicates:", ["Cholecystitis", "Appendicitis", "Renal Colic", "Gastritis"], 1, "Appendicitis."],
        ["'Zenker's Diverticulum' is located in the:", ["Upper Esophagus (Cervical)", "Mid Esophagus", "Lower Esophagus", "Stomach"], 0, "Pharyngeal pouch. "],
        ["'Hirschsprung's Disease' is characterized by:", ["Megacolon (Dilated proximal, Narrow distal)", "Polyps", "Ulcers", "Fistulas"], 0, "Congenital megacolon."],
        ["'Apple Core' lesion is a sign of:", ["Diverticulitis", "Colon Cancer", "Volvulus", "Crohn's"], 1, "Constricting adenocarcinoma. "],
        ["'Lead Pipe' colon is a sign of:", ["Ulcerative Colitis", "Crohn's", "TB", "Cancer"], 0, "Chronic UC (loss of haustra)."],
        ["'String Sign' of Kantor indicates:", ["Crohn's Disease", "UC", "Cancer", "Volvulus"], 0, "Narrowed terminal ileum. "],
        ["'Bamboo Spine' is seen in:",
 ["Osteoporosis", "Ankylosing Spondylitis", "Scoliosis", "Myeloma"],
 1,
 "Ankylosing Spondylitis. [Image of Bamboo Spine x-ray]"
],
        ["'Codman's Triangle' indicates:", ["Osteosarcoma", "Benign cyst", "Fracture", "Infection"], 0, "Malignant periosteal reaction. "],
        ["'Pott's Fracture' involves the:", ["Wrist", "Ankle (Bimalleolar)", "Hip", "Elbow"], 1, "Ankle fracture."],
        ["'Lisfranc Injury' involves the:", ["Midfoot (Tarsometatarsal)", "Hindfoot", "Forefoot", "Ankle"], 0, "TMT joints."],
        ["'Monteggia Fracture' is:", ["Fracture Ulna + Radial Head Dislocation", "Fracture Radius + DRUJ Dislocation", "Fracture Humerus", "Fracture Scaphoid"], 0, "Ulna # + Radial Head D/L."],
        ["'Galeazzi Fracture' is:", ["Fracture Radius + Distal Radioulnar Joint Dislocation", "Fracture Ulna + Radial Head Dislocation", "Fracture Humerus", "Fracture Scaphoid"], 0, "Radius # + DRUJ D/L."],

        // 3. CT/MRI/USG (66-85)
        ["The CT number for 'Fat' is approx:", ["-100 HU", "0 HU", "+50 HU", "+1000 HU"], 0, "-50 to -100 HU."],
        ["'Pitch' > 1 in CT results in:", ["Gap in data / Lower Dose", "Overlap / Higher Dose", "Better resolution", "Slower scan"], 0, "Faster table speed, undersampling."],
        ["'Beam Hardening' artifact appears as:", ["Dark streaks / Cupping", "Rings", "Bright spots", "Blur"], 0, "Inter-petrous streaks."],
        ["'Ring Artifact' in CT is due to:", ["Detector failure", "Motion", "Metal", "Tube arcing"], 0, "3rd Gen detector fault. "],
        ["In MRI, 'T1 Weighted' images show fluid as:", ["Bright", "Dark", "Grey", "Mixed"], 1, "Fluid is Dark on T1."],
        ["'STIR' sequence suppresses:", ["Water", "Fat", "Bone", "Flow"], 1, "Fat."],
        ["'FLAIR' sequence suppresses:", ["Fat", "CSF (Fluid)", "White Matter", "Grey Matter"], 1, "CSF."],
        ["'Diffusion Weighted Imaging' (DWI) is the gold standard for:", ["Acute Stroke", "Tumor", "MS", "Bleed"], 0, "Cytotoxic edema."],
        ["'Gadolinium' contrast shortens:", ["T1 relaxation time", "T2 relaxation time", "PD", "TR"], 0, "Shortens T1 -> Bright signal."],
        ["'TOF MRA' relies on:", ["Flow related enhancement", "Phase shift", "Contrast media", "Subtraction"], 0, "Inflow effect."],
        ["'Chemical Shift' artifact occurs in the:", ["Frequency Encoding Direction", "Phase Encoding Direction", "Slice Select", "Readout"], 0, "Frequency axis."],
        ["In Ultrasound, 'Shadowing' is seen behind:", ["Fluid", "Stone / Bone", "Liver", "Spleen"], 1, "Calculi. "],
        ["'Posterior Enhancement' is seen behind:", ["Fluid / Cyst", "Solid mass", "Bone", "Air"], 0, "Fluid attenuates less."],
        ["'Mirror Image' artifact in USG is common at the:", ["Diaphragm", "Kidney", "Aorta", "Skin"], 0, "Diaphragm-Lung interface. "],
        ["'Reverberation' artifact appears as:", ["Parallel lines (Comet tail)", "Black shadow", "Mirror image", "Side lobes"], 0, "Bouncing echoes. "],
        ["'Doppler Shift' measures:", ["Velocity of flow", "Pressure", "Temperature", "Density"], 0, "Flow velocity."],
        ["'PET' scan detects:", ["Annihilation Photons (511 keV)", "140 keV Gamma", "Protons", "Electrons"], 0, "Coincidence detection."],
        ["'FDG' is an analog of:", ["Glucose", "Protein", "Fat", "Oxygen"], 0, "Glucose."],
        ["'SUV' stands for:", ["Standardized Uptake Value", "Single Unit Value", "Scan Unit Volume", "None"], 0, "Metabolic activity measure."],
        ["'Half Life' of F-18 is:", ["110 minutes", "6 hours", "68 minutes", "8 days"], 0, "110 mins."],

        // 4. Contrast & Emergency (86-100)
        ["Which contrast is 'Iso-osmolar'?", ["Iodixanol (Visipaque)", "Iohexol", "Urografin", "Barium"], 0, "Iodixanol."],
        ["'Metformin' is stopped to prevent:", ["Lactic Acidosis", "Hypoglycemia", "Allergy", "Bleeding"], 0, "If renal failure occurs."],
        ["Immediate treatment for 'Laryngeal Edema':", ["Adrenaline", "Atropine", "Digoxin", "Heparin"], 0, "Adrenaline."],
        ["'Atropine' is used for:", ["Bradycardia", "Tachycardia", "Hypertension", "Hives"], 0, "Increases heart rate."],
        ["'Nitroglycerin' is used for:", ["Angina (Chest Pain)", "Headache", "Nausea", "Fever"], 0, "Vasodilator."],
        ["'Heparin' is an:", ["Anticoagulant", "Antibiotic", "Analgesic", "Contrast"], 0, "Blood thinner."],
        ["'Universal Donor' blood group:", ["O-", "AB+", "A+", "B+"], 0, "O Negative."],
        ["'Creatinine' normal range:", ["0.6 - 1.2 mg/dL", "2.0 - 5.0", "10 - 20", "0.1 - 0.2"], 0, "0.6-1.2."],
        ["'Syncope' means:", ["Fainting", "Vomiting", "Seizure", "Bleeding"], 0, "Fainting."],
        ["'Triage' means:", ["Sorting patients by severity", "Treating everyone", "Billing", "Discharge"], 0, "Prioritizing treatment."],
        ["'Nosocomial' infection is:", ["Hospital acquired", "Community acquired", "Genetic", "Viral"], 0, "Hospital acquired."],
        ["'Sterilization' kills:", ["All forms including spores", "Bacteria only", "Viruses only", "Fungi"], 0, "All life."],
        ["'Autoclave' standard:", ["121°C, 15 psi, 15 mins", "100°C", "150°C", "Chemical"], 0, "Steam sterilization."],
        ["'Needle stick injury' first step:", ["Wash with soap/water", "Squeeze", "Bandage", "Report"], 0, "Wash."],
        ["'Pulse Oximetry' measures:", ["Oxygen Saturation (SpO2)", "BP", "Temp", "Glucose"], 0, "SpO2."]
    ];

    // Shuffle and Add Core
    coreData.forEach((d, i) => addShuffled(questions, 21 + i, "Core", d));
}

        // --- STATE MANAGEMENT ---
        let state = {
            currentQ: 0,
            answers: new Array(TOTAL_QUESTIONS).fill(null),
            status: new Array(TOTAL_QUESTIONS).fill('not-visited'),
            currentSection: 1,      // 1 to 5
            sectionTimeLeft: SECTION_TIME_LIMIT,
            maxSetReached: 1,       // Tracks highest section unlocked
            isFinished: false
        };

        const els = {
            landing: document.getElementById('landingPage'),
            header: document.getElementById('examHeader'),
            body: document.getElementById('examBody'),
            footer: document.getElementById('examFooter'),
            result: document.getElementById('resultPage'),
            qText: document.getElementById('questionText'),
            optsBox: document.getElementById('optionsBox'),
            qNum: document.getElementById('qNumDisplay'),
            sectionLabel: document.getElementById('sectionLabel'),
            palette: document.getElementById('questionPalette'),
            timer: document.getElementById('timerDisplay'),
            btnPrev: document.getElementById('btnPrev'),
            sidebar: document.getElementById('sidebar')
        };

        let timerInterval;

        function init() {
            generateQuestions(); // Load data
            // Persistence check could go here, but for strict timing, fresh start is safer
            els.landing.classList.remove('hidden');
            els.result.classList.add('hidden');
        }

        function startExam() {
            els.landing.classList.add('hidden');
            renderExamInterface();
            startSectionTimer();
        }

        function startSectionTimer() {
            if(timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                state.sectionTimeLeft--;
                
                // Format Time
                const m = Math.floor(state.sectionTimeLeft / 60);
                const s = state.sectionTimeLeft % 60;
                els.timer.innerText = `${m}:${s < 10 ? '0'+s : s}`;
                
                // Visual Warning
                if(state.sectionTimeLeft < 60) els.timer.style.backgroundColor = "#ffcdd2";
                else els.timer.style.backgroundColor = "#fff";

                // Time Up Logic
                if (state.sectionTimeLeft <= 0) {
                    handleSectionTimeout();
                }
            }, 1000);
        }

        function handleSectionTimeout() {
            clearInterval(timerInterval);
            
            if (state.currentSection < 5) {
                alert(`Time is up for Section ${state.currentSection}! Moving to Section ${state.currentSection + 1}.`);
                forceNextSection();
            } else {
                alert("Time is up for the final section! Submitting Exam.");
                finishExam();
            }
        }

        function forceNextSection() {
            state.currentSection++;
            state.maxSetReached = state.currentSection;
            state.sectionTimeLeft = SECTION_TIME_LIMIT;
            
            // Move to first question of next section
            const firstQofNextSection = (state.currentSection - 1) * SECTION_SIZE;
            loadQuestion(firstQofNextSection);
            startSectionTimer();
        }

        function renderExamInterface() {
            els.header.classList.remove('hidden');
            els.body.classList.remove('hidden');
            els.footer.classList.remove('hidden');
            renderPalette();
            loadQuestion(state.currentQ);
        }

        function loadQuestion(index) {
            state.currentQ = index;
            if(state.status[index] === 'not-visited') state.status[index] = 'not-answered';

            // Update Section Label
            const secNum = Math.floor(index / SECTION_SIZE) + 1;
            els.sectionLabel.innerText = `Section ${secNum} (Q${(secNum-1)*20 + 1}-${secNum*20})`;

            // Render Text
            els.qNum.innerText = `Question ${index + 1}`;
            els.qText.innerText = questions[index].text;
            
            // Render Options
            els.optsBox.innerHTML = '';
            questions[index].opts.forEach((opt, i) => {
                const isChecked = state.answers[index] === i ? 'checked' : '';
                els.optsBox.innerHTML += `
                    <label class="option-label">
                        <input type="radio" name="opt" value="${i}" ${isChecked} onchange="selectOption(${i})">
                        ${opt}
                    </label>
                `;
            });

            // Update Palette UI
            document.querySelectorAll('.q-btn').forEach(b => b.classList.remove('current'));
            const currentBtn = document.getElementById(`qbtn-${index}`);
            if(currentBtn) currentBtn.classList.add('current');

            // Handle Prev Button State (Cannot go back to previous locked section)
            const startOfCurrentSection = (state.currentSection - 1) * SECTION_SIZE;
            els.btnPrev.disabled = (index <= startOfCurrentSection);
        }

        function selectOption(optIndex) {
            state.answers[state.currentQ] = optIndex;
        }

        function saveAndNext() {
            const index = state.currentQ;
            // Update status
            state.status[index] = (state.answers[index] !== null) ? 'answered' : 'not-answered';
            
            moveToNextQuestion();
        }

        function markForReview() {
            const index = state.currentQ;
            state.status[index] = (state.answers[index] !== null) ? 'marked-answered' : 'review'; // Simplified
            moveToNextQuestion();
        }

        function clearResponse() {
            state.answers[state.currentQ] = null;
            state.status[state.currentQ] = 'not-answered';
            loadQuestion(state.currentQ);
            renderPalette();
        }

        function moveToNextQuestion() {
            const nextIndex = state.currentQ + 1;
            const currentSecBound = state.currentSection * SECTION_SIZE;

            // Check if next question crosses section boundary
            if (nextIndex >= currentSecBound) {
                // End of section reached
                if (state.currentSection < 5) {
                    if (confirm(`You have reached the end of Section ${state.currentSection}.\nDo you want to submit this section and move to Section ${state.currentSection+1}?\n\nWARNING: You cannot return to this section.`)) {
                        forceNextSection();
                    }
                } else {
                    if(confirm("This was the last question. Submit Exam?")) {
                        finishExam();
                    }
                }
            } else {
                // Normal movement within section
                renderPalette();
                loadQuestion(nextIndex);
            }
        }

        function prevQuestion() {
            // Logic handled in loadQuestion to disable button if at start of section
            if (state.currentQ > 0) {
                loadQuestion(state.currentQ - 1);
            }
        }

        function renderPalette() {
            els.palette.innerHTML = '';
            for (let i = 0; i < TOTAL_QUESTIONS; i++) {
                let statusClass = state.status[i];
                if(statusClass === 'marked-answered') statusClass = 'review';
                
                // Check if question belongs to a locked (previous) section
                // A question is locked if its section index is < current active section
                const qSection = Math.floor(i / SECTION_SIZE) + 1;
                const isLocked = qSection < state.currentSection;
                const lockedClass = isLocked ? ' locked' : '';
                
                // Gray out future sections
                const isFuture = qSection > state.currentSection;
                const futureStyle = isFuture ? 'opacity:0.3; pointer-events:none;' : '';

                els.palette.innerHTML += `
                    <div id="qbtn-${i}" 
                         class="q-btn ${statusClass}${lockedClass}" 
                         style="${futureStyle}"
                         onclick="jumpToQuestion(${i})">
                        ${i + 1}
                    </div>
                `;
            }
        }

        function jumpToQuestion(index) {
            const qSection = Math.floor(index / SECTION_SIZE) + 1;
            
            if (qSection < state.currentSection) {
                alert("This section is locked.");
                return;
            }
            if (qSection > state.currentSection) {
                alert("You cannot jump to a future section yet.");
                return;
            }
            
            loadQuestion(index);
        }

        function submitExam() {
            if(confirm("Are you sure you want to finish the exam? Unanswered questions in future sections will be marked zero.")) {
                finishExam();
            }
        }

        function finishExam() {
            clearInterval(timerInterval);
            state.isFinished = true;
            
            els.header.classList.add('hidden');
            els.body.classList.add('hidden');
            els.footer.classList.add('hidden');
            els.result.classList.remove('hidden');
            
            calculateResult();
        }

        function calculateResult() {
            let correct = 0, wrong = 0, unattempted = 0, score = 0;

            state.answers.forEach((ans, i) => {
                if (ans === null) {
                    unattempted++;
                } else if (questions[i] && ans === questions[i].ans) {
                    correct++;
                    score += 4;
                } else {
                    wrong++;
                    score -= 1;
                }
            });

            document.getElementById('scoreCard').innerHTML = `
                <h1 style="color:#3f51b5; font-size:3rem;">${score} / 400</h1>
                <p><strong>Correct:</strong> ${correct} (+${correct*4})</p>
                <p><strong>Incorrect:</strong> ${wrong} (-${wrong})</p>
                <p><strong>Unattempted:</strong> ${unattempted}</p>
            `;
        }

        function showDetailedReview() {
            const container = document.getElementById('detailedReview');
            container.style.display = 'block';
            container.innerHTML = '<h3>Detailed Solutions</h3>';
            
            questions.forEach((q, i) => {
                const userAns = state.answers[i];
                const isCorrect = userAns === q.ans;
                const statusColor = userAns === null ? 'gray' : (isCorrect ? 'green' : 'red');
                const statusText = userAns === null ? 'Skipped' : (isCorrect ? 'Correct' : 'Incorrect');

                let optsHtml = '';
                q.opts.forEach((opt, oi) => {
                    let style = '';
                    if (oi === q.ans) style = 'font-weight:bold; color:green;'; 
                    if (oi === userAns && !isCorrect) style = 'font-weight:bold; color:red;'; 
                    optsHtml += `<div style="${style}">${oi+1}. ${opt}</div>`;
                });

                container.innerHTML += `
                    <div class="review-item">
                        <div style="color:${statusColor}; font-weight:bold; margin-bottom:5px;">Q${i+1}: ${statusText}</div>
                        <div>${q.text}</div>
                        <div style="margin:10px 0; padding-left:15px; border-left:3px solid #ddd;">${optsHtml}</div>
                        <div class="explanation"><strong>Explanation:</strong> ${q.exp}</div>
                    </div>
                `;
            });
        }

        function toggleSidebar() {
            els.sidebar.classList.toggle('active');
        }

        // Initialize
        init();

    </script>
</body>
</html>
