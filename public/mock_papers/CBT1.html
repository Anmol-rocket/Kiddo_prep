<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIIMS CRE Radiographer CBT Mock</title>
    <style>
        :root {
            --header-bg: #3f51b5;
            --header-text: #fff;
            --panel-bg: #f5f5f5;
            --pallet-answered: #4caf50;
            --pallet-not-answered: #f44336;
            --pallet-review: #9c27b0;
            --pallet-not-visited: #e0e0e0;
            --text-color: #333;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; }
        body { height: 100vh; display: flex; flex-direction: column; overflow: hidden; background: #fff; }

        /* --- Header --- */
        header {
            background: var(--header-bg); color: var(--header-text);
            padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
            height: 60px; flex-shrink: 0;
        }
        .timer { font-size: 1.2rem; font-weight: bold; background: #fff; color: #333; padding: 5px 15px; border-radius: 4px; }

        /* --- Main Layout --- */
        .main-container { display: flex; flex: 1; overflow: hidden; }
        
        /* Left: Question Area */
        .question-area { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; }
        .q-header { display: flex; justify-content: space-between; border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-bottom: 15px; }
        .q-text { font-size: 1.1rem; margin-bottom: 20px; line-height: 1.5; }
        
        .options-container { display: flex; flex-direction: column; gap: 10px; }
        .option-label { 
            display: flex; align-items: center; padding: 10px; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; transition: 0.2s; 
        }
        .option-label:hover { background: #f0f8ff; }
        .option-label input { margin-right: 15px; transform: scale(1.2); }

        /* Right: Sidebar (Palette) */
        .sidebar {
            width: 320px; background: var(--panel-bg); border-left: 1px solid #ccc;
            display: flex; flex-direction: column; flex-shrink: 0;
        }
        .user-info { padding: 10px; background: #e8eaf6; border-bottom: 1px solid #ccc; display: flex; align-items: center; gap: 10px; }
        .user-img { width: 40px; height: 40px; background: #bbb; border-radius: 50%; }
        
        .palette-legend { padding: 10px; font-size: 0.8rem; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; background: #fff; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }

        .question-grid { 
            padding: 10px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; 
            overflow-y: auto; flex: 1; align-content: start;
        }
        .q-btn {
            height: 35px; width: 35px; border: 1px solid #ccc; background: #fff; 
            border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
        }
        
        /* Button States */
        .q-btn.answered { background: var(--pallet-answered); color: white; border-color: var(--pallet-answered); clip-path: polygon(0% 0%, 100% 0%, 100% 75%, 50% 100%, 0% 75%);  }
        .q-btn.not-answered { background: var(--pallet-not-answered); color: white; border-color: var(--pallet-not-answered); clip-path: polygon(0% 0%, 100% 0%, 100% 75%, 50% 100%, 0% 75%); }
        .q-btn.review { background: var(--pallet-review); color: white; border-radius: 50%; }
        .q-btn.current { border: 2px solid blue; box-shadow: 0 0 5px blue; }
        .q-btn.locked { opacity: 0.5; cursor: not-allowed; background: #555 !important; color: #fff; }

        /* Footer Controls */
        .footer-controls {
            height: 60px; background: #fff; border-top: 1px solid #ccc;
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
        }
        .btn { padding: 8px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.9rem; }
        .btn-primary { background: #2196f3; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-warn { background: #ff9800; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Mobile Adjustments */
        .mobile-toggle { display: none; background: none; border: none; color: white; font-size: 1.5rem; }
        
        @media (max-width: 768px) {
            .mobile-toggle { display: block; }
            .sidebar { 
                position: absolute; right: 0; top: 60px; bottom: 60px; z-index: 100;
                transform: translateX(100%); transition: transform 0.3s; width: 85%;
            }
            .sidebar.active { transform: translateX(0); }
            .question-grid { grid-template-columns: repeat(6, 1fr); }
            .footer-controls { flex-wrap: wrap; gap: 5px; height: auto; padding: 10px; }
            .btn { flex: 1; padding: 8px; font-size: 0.8rem; }
        }

        /* Overlay */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .hidden { display: none !important; }

        /* Review Mode */
        .review-panel { display: none; padding: 20px; height: 100%; overflow-y: auto; }
        .review-item { margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
        .correct-ans { color: green; font-weight: bold; }
        .wrong-ans { color: red; font-weight: bold; }
        .explanation { background: #fff3cd; padding: 10px; margin-top: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div id="landingPage" class="overlay">
        <h1>AIIMS CRE Radiographer CBT Mock</h1>
        <div style="width: 80%; max-width: 600px; text-align: left; margin: 20px 0;">
            <h3>Instructions:</h3>
            <ul>
                <li><strong>Total Questions:</strong> 100 (20 Non-Core, 80 Core)</li>
                <li><strong>Time:</strong> 90 Minutes</li>
                <li><strong>Marking:</strong> +4 Correct, -1 Incorrect, 0 Unattempted.</li>
                <li><strong>Constraint:</strong> Questions appear in sets of 20. Once you proceed to the next set (e.g., Q21), the previous set (Q1-20) is locked.</li>
            </ul>
        </div>
        <button class="btn btn-success" style="font-size: 1.2rem;" onclick="startExam()">START EXAM</button>
    </div>

    <header id="examHeader" class="hidden">
        <div style="display:flex; align-items:center; gap:10px;">
            <h3>AIIMS CRE</h3>
        </div>
        <div class="timer" id="timerDisplay">90:00</div>
        <button class="mobile-toggle" onclick="toggleSidebar()">☰</button>
    </header>

    <div class="main-container hidden" id="examBody">
        <div class="question-area">
            <div class="q-header">
                <span id="qNumDisplay">Question No. 1</span>
                <span style="color: #666;">Marks: +4, -1</span>
            </div>
            <div id="questionText" class="q-text">Loading question...</div>
            <div id="optionsBox" class="options-container">
                </div>
        </div>

        <div class="sidebar" id="sidebar">
            <div class="user-info">
                <div class="user-img"></div>
                <div>
                    <strong>Candidate Name</strong><br>
                    <small>Radiographer</small>
                </div>
            </div>
            <div class="palette-legend">
                <div class="legend-item"><span class="dot" style="background:var(--pallet-answered)"></span> Answered</div>
                <div class="legend-item"><span class="dot" style="background:var(--pallet-not-answered)"></span> Not Ans</div>
                <div class="legend-item"><span class="dot" style="background:var(--pallet-review)"></span> Review</div>
                <div class="legend-item"><span class="dot" style="background:#555"></span> Locked</div>
            </div>
            <div style="padding:5px; background:#ddd; font-weight:bold; text-align:center;">Question Palette</div>
            <div class="question-grid" id="questionPalette">
                </div>
            <div style="padding:10px; margin-top:auto;">
                <button class="btn btn-primary" style="width:100%" onclick="submitExam()">SUBMIT PAPER</button>
            </div>
        </div>
    </div>

    <div class="footer-controls hidden" id="examFooter">
        <div style="display:flex; gap:10px;">
            <button class="btn btn-danger" onclick="clearResponse()">Clear Response</button>
            <button class="btn btn-warn" onclick="markForReview()">Mark for Review</button>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn" onclick="prevQuestion()" id="btnPrev">Previous</button>
            <button class="btn btn-success" onclick="saveAndNext()">Save & Next</button>
        </div>
    </div>

    <div id="resultPage" class="overlay hidden" style="display:block; overflow-y:auto; justify-content:start; padding-top:40px;">
        <h2>Exam Summary</h2>
        <div id="scoreCard" style="margin: 20px; padding: 20px; border: 1px solid #ccc; text-align: center;">
            </div>
        <div style="display:flex; gap:20px; margin-bottom:20px;">
            <button class="btn btn-primary" onclick="showDetailedReview()">Review Questions</button>
            <button class="btn btn-danger" onclick="resetExam()">Exit / Restart</button>
        </div>
        <div id="detailedReview" class="review-panel" style="width: 90%; max-width: 800px;"></div>
    </div>

    <script type="text/javascript" charset="utf-8">
      // --- 1. Data & Configuration ---
    const TOTAL_QUESTIONS = 100;
    const SET_SIZE = 20; 
    const EXAM_DURATION = 90 * 60; // 90 Minutes

    let questions = [];

    function generateQuestions() {
        const createQ = (id, type, text, opts, ans, exp) => ({ id, type, text, opts, ans, exp });

        // --- SECTION A: NON-CORE (Questions 1-20) ---
        // Topics: Reasoning, GK, English, Basic Computers
        
        const nonCoreData = [
            // General Intelligence & Reasoning
            ["In a certain code, 'RADIOLOGY' is written as 'SBEJPMPHZ'. How is 'CATHLAB' written in that code?", ["DBUIMBC", "DBUJNBC", "DBUIOMB", "DAUJMBC"], 0, "Each letter is shifted forward by +1."],
            ["Point A is 10m West of Point B. Point B is 5m North of Point C. What is the direction of A with respect to C?", ["North-West", "South-East", "North-East", "South-West"], 0, "A is West and North relative to C."],
            ["Select the odd one out: Monitor, Printer, Mouse, Plotter.", ["Monitor", "Printer", "Mouse", "Plotter"], 2, "Mouse is an input device; the others are output devices."],
            ["Series: 2, 6, 12, 20, 30, ?", ["40", "42", "44", "48"], 1, "The pattern is +4, +6, +8, +10, +12. 30 + 12 = 42."],
            ["Blood Relation: A is the father of B. C is the daughter of B. D is the brother of B. How is D related to C?", ["Father", "Uncle", "Brother", "Grandfather"], 1, "D is the brother of C's parent (B), so D is C's Uncle."],
            
            // General Awareness
            ["Who is the current Director of AIIMS New Delhi (as of 2025 context)?", ["Dr. Randeep Guleria", "Dr. M. Srinivas", "Dr. Balram Bhargava", "Dr. V.K. Paul"], 1, "Dr. M. Srinivas is the Director."],
            ["Which isotope is most commonly used in PET scans?", ["Technetium-99m", "Iodine-131", "Fluorine-18 (FDG)", "Cobalt-60"], 2, "F-18 FDG is the standard radiotracer for PET."],
            ["The 'Right to Health' is guaranteed under which Article of the Indian Constitution?", ["Article 19", "Article 21", "Article 14", "Article 32"], 1, "Article 21 (Right to Life) includes the right to health."],
            ["Which state recently hosted the 'Global Investors Summit 2024'?", ["Uttar Pradesh", "Gujarat", "Maharashtra", "Tamil Nadu"], 1, "Gujarat (Vibrant Gujarat)."],
            ["What is the full form of PACS in hospital workflow?", ["Picture Archiving and Communication System", "Patient Access and Control System", "Picture Analysis and Computer System", "Patient Admission and Care System"], 0, "PACS stands for Picture Archiving and Communication System."],
            
            // English & Computers
            ["Antonym of 'OBSOLETE':", ["Outdated", "Modern", "Ancient", "Extinct"], 1, "Obsolete means old; Modern is the opposite."],
            ["Choose the correct spelling:", ["Fluorscopy", "Fluoroscopy", "Fluroscopy", "Floroscopy"], 1, "Fluoroscopy is the correct spelling."],
            ["'To break the ice' means:", ["To start a fight", "To start a conversation", "To make cooling arrangements", "To feel sad"], 1, "It means to initiate social interaction."],
            ["Which key combination is used to 'Redo' an action in MS Word?", ["Ctrl + Z", "Ctrl + Y", "Ctrl + R", "Ctrl + X"], 1, "Ctrl + Y is for Redo."],
            ["1 Gigabyte (GB) is equal to:", ["1000 MB", "1024 KB", "1024 MB", "1024 TB"], 2, "1 GB = 1024 MB."],
            ["Synonym of 'BENIGN':", ["Harmful", "Malignant", "Gentle", "Fatal"], 2, "Benign means gentle or harmless."],
            ["Find the missing number in the matrix: [5, 6, 30], [7, 8, 56], [4, 9, ?]", ["36", "45", "13", "28"], 0, "Pattern is Row 1 * Row 2 = Row 3. 4 * 9 = 36."],
            ["Which layer of the OSI model is responsible for routing?", ["Physical", "Data Link", "Network", "Transport"], 2, "The Network layer handles routing."],
            ["The headquarters of the WHO is located in:", ["New York", "London", "Geneva", "Paris"], 2, "Geneva, Switzerland."],
            ["A person who studies X-rays and radioactive substances is called a:", ["Radiologist", "Cardiologist", "Pathologist", "Dermatologist"], 0, "Radiologist."]
        ];

        nonCoreData.forEach((d, i) => questions.push(createQ(i + 1, "Non-Core", d[0], d[1], d[2], d[3])));

        // --- SECTION B: CORE (Questions 21-100) ---
        // Topics: Physics, Anatomy, Positioning, Darkroom, CT, MRI, USG, Safety
        
        const coreData = [
            // Radiation Physics (21-30)
            ["Which interaction is responsible for the majority of patient dose in diagnostic radiology?", ["Photoelectric Effect", "Compton Scattering", "Coherent Scattering", "Pair Production"], 0, "Photoelectric effect involves total absorption, contributing most to patient dose."],
            ["The binding energy of the K-shell electron in Tungsten is approximately:", ["69.5 keV", "12 keV", "33 keV", "50 keV"], 0, "K-shell binding energy of Tungsten is ~69.5 keV."],
            ["To double the optical density on a radiograph, the kVp should be increased by:", ["5%", "10%", "15%", "50%"], 2, "The 15% rule states that increasing kVp by 15% doubles the exposure."],
            ["Which of the following grid ratios would result in the highest patient dose?", ["5:1", "8:1", "12:1", "16:1"], 3, "Higher grid ratios require higher exposure factors (mAs) to maintain density, increasing dose."],
            ["The unit of Equivalent Dose is:", ["Gray", "Sievert", "Becquerel", "Roentgen"], 1, "Sievert (Sv) is the unit for Equivalent and Effective Dose."],
            ["Filament in the X-ray tube is made of:", ["Copper", "Tungsten", "Molybdenum", "Aluminum"], 1, "Tungsten is used due to its high melting point and atomic number."],
            ["The 'Line Focus Principle' is used to:", ["Reduce effective focal spot size", "Increase actual focal spot size", "Reduce anode heat", "Increase patient dose"], 0, "It reduces the effective focal spot size for better resolution while keeping actual spot large for heat."],
            ["Which transformer is used in the filament circuit?", ["Step-up transformer", "Step-down transformer", "Autotransformer", "High tension transformer"], 1, "Step-down transformer reduces voltage to heat the filament."],
            ["The annual effective dose limit for radiation workers (averaged over 5 years) is:", ["20 mSv", "50 mSv", "100 mSv", "5 mSv"], 0, "According to AERB/ICRP, it is 20 mSv/year averaged over 5 years."],
            ["Half Value Layer (HVL) is a measure of X-ray beam:", ["Quantity", "Quality", "Intensity", "Scatter"], 1, "HVL measures beam quality (penetrability)."],

            // Radiographic Positioning & Procedures (31-50)
            ["The 'Towne's View' is primarily used to visualize:", ["Frontal Sinus", "Occipital Bone", "Maxilla", "Mandible"], 1, "Towne's view best demonstrates the Occipital bone and Foramen Magnum."],
            ["For a lateral view of the wrist, the elbow should be flexed at:", ["45 degrees", "90 degrees", "180 degrees", "0 degrees"], 1, "90 degrees flexion ensures the radius and ulna are superimposed."],
            ["Which view is best for demonstrating a pleural effusion in a patient who cannot stand?", ["Supine Chest", "Lateral Decubitus", "Lordotic View", "Lateral Chest"], 1, "Lateral Decubitus allows fluid to layer out for visualization."],
            ["The 'Swimmer's View' is used to visualize:", ["C1-C2 junction", "C7-T1 junction", "L5-S1 junction", "Thoracic spine"], 1, "It visualizes the cervicothoracic junction (C7-T1)."],
            ["In 'Waters View', the OML forms what angle with the image receptor?", ["37 degrees", "45 degrees", "90 degrees", "0 degrees"], 0, "In Waters view, the OML makes a 37-degree angle to the IR."],
            ["Which contrast medium is contraindicated in case of suspected perforation?", ["Barium Sulfate", "Iodinated Contrast (Water soluble)", "Air", "Gadolinium"], 0, "Barium is non-absorbable and can cause peritonitis if it leaks."],
            ["The 'Judet View' is used for:", ["Acetabulum", "Scaphoid", "Patella", "Calcaneus"], 0, "Judet views are oblique views for acetabular fractures."],
            ["ERCP stands for:", ["Endoscopic Retrograde Cholangiopancreatography", "Emergency Retrograde Cystopancreatography", "Endoscopic Renal Cholangiopancreatography", "External Retrograde Cholangiopancreatography"], 0, "Endoscopic Retrograde Cholangiopancreatography."],
            ["For a skyline view of the patella, the patient is placed in:", ["Prone", "Supine with knee flexed", "Lateral", "Standing"], 1, "Often inferosuperior or superoinferior projection with knee flexed."],
            ["Which position demonstrates the right intervertebral foramina of the cervical spine?", ["RAO", "LAO", "RPO", "Lateral"], 2, "LPO/RPO show the foramina furthest from IR; RPO shows Left, LPO shows Right. Wait, actually: Anterior obliques (LAO/RAO) show foramina CLOSEST to IR. Posterior obliques (LPO/RPO) show foramina FURTHEST. LPO shows Right, RPO shows Left. *Correction*: In C-spine, Anterior Oblique (RAO) shows Right foramina. RPO shows Left."],
            // Let's correct the logic in the explanation for Q40 in the array below.
            // C-Spine: LPO shows Right foramina. RPO shows Left foramina. LAO shows Left. RAO shows Right.
            // Question asks for Right foramina.
            // Options: RAO (shows Right), LAO (shows Left), RPO (shows Left), Lateral (shows none).
            // Answer: RAO.
            
            ["HSG (Hysterosalpingography) is performed to evaluate:", ["Urethral stricture", "Tubal patency", "Renal stones", "Bladder tumor"], 1, "It evaluates infertility and fallopian tube patency."],
            ["The recommended time for a Barium Meal follow-through study to reach the ileocecal valve is approx:", ["15 mins", "30 mins", "1-2 hours", "24 hours"], 2, "Usually takes 1-2 hours."],
            ["'Stenvers View' is used for:", ["Petrous Temporal Bone", "Optic Foramen", "Sella Turcica", "TM Joint"], 0, "Visualizes the Petrous ridge and bony labyrinth."],
            ["Which projection best demonstrates the scaphoid bone?", ["PA with Ulnar deviation", "PA with Radial deviation", "Lateral", "AP Oblique"], 0, "Ulnar deviation elongates the scaphoid."],
            ["In IVP, compression is applied to:", ["Retain contrast in pelvicalyceal system", "Empty the bladder", "Immobilize patient", "Reduce scatter"], 0, "It blocks ureters to fill the renal pelvis and calyces."],
            ["The 'Y-view' of the shoulder is useful for diagnosing:", ["Fracture of clavicle", "Dislocation of shoulder", "Fracture of humerus", "Rotator cuff tear"], 1, "Scapular Y view is standard for shoulder dislocation."],
            ["Total amount of barium suspension used for a barium enema is approximately:", ["200 ml", "500 ml", "1000-1500 ml", "3000 ml"], 2, "Large volume is needed to fill the colon."],
            ["Which of the following is a negative contrast agent?", ["Iodine", "Barium", "Gadolinium", "CO2 / Air"], 3, "Gases like Air or CO2 appear black (radiolucent)."],
            ["Sialography is the radiographic examination of:", ["Salivary Glands", "Sinuses", "Spinal Cord", "Spleen"], 0, "Salivary glands."],
            ["Myelography involves injection of contrast into:", ["Epidural space", "Subarachnoid space", "Subdural space", "Vertebral body"], 1, "Contrast is injected into the subarachnoid space."],

            // CT Scan (51-65)
            ["Which generation of CT scanners introduced the 'Slip Ring' technology?", ["Third", "Fourth", "Spiral/Helical", "First"], 2, "Slip rings allowed continuous rotation, enabling Spiral/Helical CT."],
            ["The CT number (Hounsfield Unit) for water is:", ["-1000", "0", "+1000", "+50"], 1, "Water is calibrated to 0 HU."],
            ["The CT number for Air is:", ["-1000", "0", "1000", "500"], 0, "Air is -1000 HU."],
            ["In CT, 'Pitch' is defined as:", ["Table movement per rotation / Beam width", "Beam width / Table movement", "Rotation time / Slice thickness", "None"], 0, "Pitch = Table feed per rotation / Total collimation width."],
            ["Which artifact in CT appears as streaks arising from high-density objects?", ["Ring artifact", "Beam hardening artifact", "Motion artifact", "Star artifact/Streak artifact"], 3, "Metal or high density causes streak artifacts."],
            ["Window Width (WW) in CT determines:", ["Image Density", "Image Contrast", "Spatial Resolution", "Pixel Size"], 1, "Window Width controls contrast (range of HU displayed)."],
            ["Window Level (WL) determines:", ["Image Contrast", "Center of the range of HU displayed", "Image Noise", "Slice thickness"], 1, "WL controls image brightness."],
            ["HRCT of the chest typically uses a slice thickness of:", ["5-10 mm", "1-2 mm", "10-20 mm", "0.1 mm"], 1, "1-2 mm (thin sections) are used for High Resolution CT."],
            ["CTDI stands for:", ["Computed Tomography Dose Index", "Computed Tomography Digital Interface", "Computerized Tomography Data Input", "None"], 0, "CT Dose Index."],
            ["Which reconstruction algorithm is used in Back Projection?", ["Fourier Transform", "Filtered Back Projection", "Iterative Reconstruction", "All of the above"], 3, "Historically FBP, now Iterative is common too. 'All' is safest, but FBP is classic."],
            ["A 'Ring Artifact' in CT is usually caused by:", ["Patient motion", "Detector failure", "Metal implant", "Beam hardening"], 1, "Detector malfunction in 3rd gen scanners causes rings."],
            ["Which contrast phase is best for detecting Liver HCC (Hepatocellular Carcinoma)?", ["Non-contrast", "Arterial Phase", "Portal Venous Phase", "Delayed Phase"], 1, "HCC gets blood from hepatic artery, so it enhances in Arterial phase."],
            ["What is the matrix size of a standard CT image?", ["64 x 64", "256 x 256", "512 x 512", "1024 x 1024"], 2, "512 x 512 is standard."],
            ["The process of creating 3D images from CT data is called:", ["MIP", "MPR", "VRT", "All of the above"], 3, "MIP, MPR, and VRT are all post-processing techniques."],
            ["CT Angiography usually requires injection rate of:", ["0.5-1 ml/sec", "3-5 ml/sec", "8-10 ml/sec", "15 ml/sec"], 1, "3-5 ml/sec (typically 4) is needed for good arterial enhancement."],

            // MRI (66-75)
            ["The unit of magnetic field strength in MRI is:", ["Tesla", "Volt", "Ampere", "Hertz"], 0, "Tesla (T)."],
            ["T1 relaxation is also known as:", ["Spin-Spin relaxation", "Spin-Lattice relaxation", "Proton density", "Free induction decay"], 1, "Spin-Lattice relaxation."],
            ["T2 relaxation is also known as:", ["Spin-Spin relaxation", "Spin-Lattice relaxation", "Echo time", "Inversion recovery"], 0, "Spin-Spin relaxation."],
            ["On a T1-weighted image, water/CSF appears:", ["Bright (Hyperintense)", "Dark (Hypointense)", "Grey", "Mixed"], 1, "Fluid is dark on T1, bright on T2."],
            ["Gadolinium based contrast agents act by:", ["Shortening T1 relaxation time", "Lengthening T1 relaxation time", "Shortening T2 only", "Blocking protons"], 0, "They shorten T1, causing bright signal on T1 weighted images."],
            ["What is the specific absorption rate (SAR) limit for the whole body in MRI?", ["4 W/kg", "10 W/kg", "1 W/kg", "20 W/kg"], 0, "4 W/kg is the standard safety limit."],
            ["Which pulse sequence begins with a 180-degree inversion pulse?", ["Spin Echo", "Gradient Echo", "Inversion Recovery", "FSE"], 2, "Inversion Recovery (STIR/FLAIR) starts with 180 deg."],
            ["'Quench' in MRI refers to:", ["Rapid loss of superconductivity and boiling off of helium", "Turning off the computer", "Patient panic attack", "Gradient noise"], 0, "Emergency venting of liquid helium."],
            ["The larmor frequency of Hydrogen at 1.5 Tesla is approx:", ["42.6 MHz", "63.9 MHz", "21.3 MHz", "128 MHz"], 1, "42.58 MHz/T * 1.5 T ≈ 63.9 MHz."],
            ["Contraindication for MRI includes:", ["Titanium plates", "Cardiac Pacemaker (non-compatible)", "Dental fillings", "Hip replacement (old)"], 1, "Pacemakers are the classic absolute contraindication (unless MRI conditional)."],

            // Ultrasound & Doppler (76-80)
            ["The piezoelectric effect is used in:", ["CT detectors", "MRI coils", "Ultrasound Transducers", "X-ray tubes"], 2, "Converts electrical energy to sound and vice versa."],
            ["Frequency of diagnostic ultrasound is typically:", ["20-200 Hz", "2-15 MHz", "1-5 KHz", "50-100 MHz"], 1, "2 MHz to 15 MHz range."],
            ["Acoustic Shadowing is seen behind:", ["Fluid filled cysts", "Gallstones / Bones", "Liver parenchyma", "Blood vessels"], 1, "High attenuation objects like stones cause shadowing."],
            ["Acoustic Enhancement is seen behind:", ["Bones", "Air", "Fluid filled structures", "Soft tissue"], 2, "Fluid allows sound to pass easily, making area behind it brighter."],
            ["Which probe is used for high resolution superficial structures (Thyroid/Breast)?", ["Curvilinear Low Frequency", "Linear High Frequency", "Phased Array", "Sector Probe"], 1, "Linear High Frequency probe."],

            // Anatomy & Physiology (81-90)
            ["The 'Odontoid Process' (Dens) is part of which vertebra?", ["Atlas (C1)", "Axis (C2)", "C7", "T1"], 1, "It is part of the Axis (C2)."],
            ["Total number of bones in the adult human body:", ["200", "206", "212", "300"], 1, "206 bones."],
            ["The longest bone in the human body is:", ["Humerus", "Tibia", "Femur", "Fibula"], 2, "Femur."],
            ["Which valve is located between the right atrium and right ventricle?", ["Mitral", "Tricuspid", "Aortic", "Pulmonary"], 1, "Tricuspid valve."],
            ["The 'Olecranon process' is found on the:", ["Radius", "Ulna", "Humerus", "Scapula"], 1, "Proximal end of the Ulna."],
            ["Which organ produces Bile?", ["Gallbladder", "Pancreas", "Liver", "Stomach"], 2, "Liver produces bile; Gallbladder stores it."],
            ["The covering of the lungs is called:", ["Peritoneum", "Pericardium", "Pleura", "Meninges"], 2, "Pleura."],
            ["The 'Acetabulum' articulates with the:", ["Humerus head", "Femur head", "Tibia", "Sacrum"], 1, "Forms the hip joint with the Femur head."],
            ["Number of pairs of ribs in the human body:", ["10", "12", "14", "6"], 1, "12 pairs."],
            ["Which carpal bone is most commonly fractured?", ["Lunate", "Scaphoid", "Capitate", "Hamate"], 1, "Scaphoid."],

            // Darkroom & Digital Radiography (91-100)
            ["The active ingredient in the fixer solution is:", ["Sodium Carbonate", "Ammonium Thiosulfate", "Hydroquinone", "Potassium Bromide"], 1, "Ammonium or Sodium Thiosulfate (Clearing agent)."],
            ["In CR (Computed Radiography), the image plate is coated with:", ["Silver Halide", "Photostimulable Phosphor (BaFBr:Eu)", "Amorphous Selenium", "Cesium Iodide"], 1, "PSP usually Barium Fluorohalide."],
            ["Active layer in Direct DR detectors is made of:", ["Cesium Iodide", "Amorphous Selenium", "Gadolinium Oxysulfide", "Silicon"], 1, "Amorphous Selenium (a-Se) converts X-rays directly to charge."],
            ["DICOM stands for:", ["Digital Image Communication in Medicine", "Direct Imaging Computer Method", "Digital Input Computer Mode", "Dual Imaging Communication Method"], 0, "Global standard for medical imaging info."],
            ["'Fog' on a film can be caused by:", ["Safe light imbalance", "Scatter radiation", "Outdated film", "All of the above"], 3, "All are causes of fog."],
            ["Developer solution is alkaline or acidic?", ["Acidic", "Alkaline", "Neutral", "Variable"], 1, "Alkaline (pH 10-10.5)."],
            ["Fixer solution is acidic or alkaline?", ["Acidic", "Alkaline", "Neutral", "Variable"], 0, "Acidic (pH 4-4.5)."],
            ["The function of the 'Intensifying Screen' is to:", ["Filter low energy x-rays", "Convert x-rays to visible light", "Protect film from light", "Reduce scatter"], 1, "It converts x-rays to light to expose film, reducing dose."],
            ["A 'Safe light' in a darkroom usually uses a filter of which color?", ["Blue", "Green", "Red/Amber", "White"], 2, "Red or Amber (GBX-2 filter)."],
            ["In DR, 'Ghosting' artifact refers to:", ["Blurred image", "Previous image sticking to current image", "White spots", "Grid lines"], 1, "Latent image from previous exposure appearing on new one (Image Lag)."]
        ];

        coreData.forEach((d, i) => questions.push(createQ(21 + i, "Core", d[0], d[1], d[2], d[3])));
    }
    
    // Call the function to populate the array immediately
    generateQuestions();
    
    // --- 2. State Management ---
    let state = {
        currentQ: 0,
        answers: new Array(TOTAL_QUESTIONS).fill(null),
        status: new Array(TOTAL_QUESTIONS).fill('not-visited'),
        timeLeft: EXAM_DURATION,
        isFinished: false,
        maxSetReached: 0
    };

    // --- 3. DOM Elements (Ensure these match your HTML IDs) ---
    const els = {
        landing: document.getElementById('landingPage'),
        header: document.getElementById('examHeader'),
        body: document.getElementById('examBody'),
        footer: document.getElementById('examFooter'),
        result: document.getElementById('resultPage'),
        qText: document.getElementById('questionText'),
        optsBox: document.getElementById('optionsBox'),
        qNum: document.getElementById('qNumDisplay'),
        palette: document.getElementById('questionPalette'),
        timer: document.getElementById('timerDisplay'),
        btnPrev: document.getElementById('btnPrev'),
        sidebar: document.getElementById('sidebar')
    };

    // --- 4. Logic Functions ---

    function init() {
        const savedState = localStorage.getItem('aiims_cbt_state');
        if (savedState) {
            try {
                const parsed = JSON.parse(savedState);
                // Validate if saved state matches current question count
                if(parsed.answers.length === TOTAL_QUESTIONS) {
                    state = parsed;
                    if (state.isFinished) {
                        showResult();
                        return;
                    }
                    renderExamInterface();
                    startTimer();
                } else {
                    // Reset if question count changed
                    localStorage.removeItem('aiims_cbt_state');
                    els.landing.classList.remove('hidden');
                }
            } catch(e) {
                 els.landing.classList.remove('hidden');
            }
        } else {
            els.landing.classList.remove('hidden');
            els.result.classList.add('hidden');
        }
    }

    function startExam() {
        els.landing.classList.add('hidden');
        renderExamInterface();
        startTimer();
        updatePersistence();
    }

    function renderExamInterface() {
        els.header.classList.remove('hidden');
        els.body.classList.remove('hidden');
        els.footer.classList.remove('hidden');
        renderPalette();
        loadQuestion(state.currentQ);
    }

    function loadQuestion(index) {
        state.currentQ = index;
        if(state.status[index] === 'not-visited') {
            state.status[index] = 'not-answered';
        }
        
        // Update UI
        els.qNum.innerText = `Question No. ${index + 1} (${questions[index].type})`;
        els.qText.innerText = questions[index].text;
        
        els.optsBox.innerHTML = '';
        questions[index].opts.forEach((opt, i) => {
            const isChecked = state.answers[index] === i ? 'checked' : '';
            els.optsBox.innerHTML += `
                <label class="option-label">
                    <input type="radio" name="opt" value="${i}" ${isChecked} onchange="selectOption(${i})">
                    ${opt}
                </label>
            `;
        });

        document.querySelectorAll('.q-btn').forEach(b => b.classList.remove('current'));
        const currentBtn = document.getElementById(`qbtn-${index}`);
        if(currentBtn) currentBtn.classList.add('current');

        // Locking Logic
        els.btnPrev.disabled = (index === 0) || (Math.floor((index - 1) / SET_SIZE) < state.maxSetReached);

        updatePersistence();
    }

    function selectOption(optIndex) {
        state.answers[state.currentQ] = optIndex;
    }

    function saveAndNext() {
        const index = state.currentQ;
        if (state.answers[index] !== null) {
            state.status[index] = 'answered';
        } else {
            state.status[index] = 'not-answered';
        }
        moveToNextQuestion();
    }

    function markForReview() {
        const index = state.currentQ;
        if (state.answers[index] !== null) {
            state.status[index] = 'marked-answered';
        } else {
            state.status[index] = 'review';
        }
        moveToNextQuestion();
    }

    function clearResponse() {
        state.answers[state.currentQ] = null;
        state.status[state.currentQ] = 'not-answered';
        loadQuestion(state.currentQ);
        renderPalette();
    }

    function moveToNextQuestion() {
        const nextIndex = state.currentQ + 1;
        const currentSet = Math.floor(state.currentQ / SET_SIZE);
        const nextSet = Math.floor(nextIndex / SET_SIZE);

        if (nextSet > currentSet && nextSet <= Math.floor((TOTAL_QUESTIONS-1)/SET_SIZE)) {
            if (!confirm(`You are about to leave Section ${currentSet + 1}. You CANNOT return to these questions once you proceed. Continue?`)) {
                return;
            }
            state.maxSetReached = nextSet;
        }

        if (nextIndex < TOTAL_QUESTIONS) {
            renderPalette();
            loadQuestion(nextIndex);
        } else {
            renderPalette();
            alert("You have reached the last question.");
        }
    }

    function prevQuestion() {
        if (state.currentQ > 0) {
            const prevIndex = state.currentQ - 1;
            if (Math.floor(prevIndex / SET_SIZE) < state.maxSetReached) {
                alert("Previous section is locked.");
                return;
            }
            loadQuestion(prevIndex);
        }
    }

    function renderPalette() {
        els.palette.innerHTML = '';
        for (let i = 0; i < TOTAL_QUESTIONS; i++) {
            let statusClass = state.status[i];
            const isLocked = Math.floor(i / SET_SIZE) < state.maxSetReached;
            const lockedClass = isLocked ? ' locked' : '';

            els.palette.innerHTML += `
                <div id="qbtn-${i}" 
                        class="q-btn ${statusClass}${lockedClass}" 
                        onclick="jumpToQuestion(${i})">
                    ${i + 1}
                </div>
            `;
        }
    }

    function jumpToQuestion(index) {
        if (Math.floor(index / SET_SIZE) < state.maxSetReached) {
            alert("This section is locked.");
            return;
        }
        const targetSet = Math.floor(index / SET_SIZE);
        if (targetSet > state.maxSetReached) {
            alert("You must complete the current section first.");
            return;
        }
        loadQuestion(index);
    }

    let timerInterval;
    function startTimer() {
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            state.timeLeft--;
            const m = Math.floor(state.timeLeft / 60);
            const s = state.timeLeft % 60;
            els.timer.innerText = `${m}:${s < 10 ? '0'+s : s}`;
            
            if (state.timeLeft % 5 === 0) updatePersistence(); 

            if (state.timeLeft <= 0) {
                clearInterval(timerInterval);
                submitExam();
            }
        }, 1000);
    }

    function submitExam() {
        if (confirm("Are you sure you want to submit the exam?")) {
            finishExam();
        }
    }

    function finishExam() {
        clearInterval(timerInterval);
        state.isFinished = true;
        updatePersistence();
        
        els.header.classList.add('hidden');
        els.body.classList.add('hidden');
        els.footer.classList.add('hidden');
        els.result.classList.remove('hidden');
        
        calculateResult();
    }
    
    // Fixed: Added showResult to recover session on reload if finished
    function showResult() {
         els.header.classList.add('hidden');
         els.body.classList.add('hidden');
         els.footer.classList.add('hidden');
         els.result.classList.remove('hidden');
         calculateResult();
    }

    function calculateResult() {
        let correct = 0;
        let wrong = 0;
        let unattempted = 0;
        let score = 0;

        state.answers.forEach((ans, i) => {
            if (ans === null) {
                unattempted++;
            } else if (ans === questions[i].ans) {
                correct++;
                score += 4;
            } else {
                wrong++;
                score -= 1;
            }
        });

        document.getElementById('scoreCard').innerHTML = `
            <h1>Your Score: ${score} / 400</h1>
            <p>Correct: <span style="color:green">${correct}</span> | Wrong: <span style="color:red">${wrong}</span> | Unattempted: ${unattempted}</p>
        `;
    }

    function showDetailedReview() {
        const container = document.getElementById('detailedReview');
        container.style.display = 'block';
        container.innerHTML = '<h3>Detailed Solutions</h3>';
        
        questions.forEach((q, i) => {
            const userAns = state.answers[i];
            const isCorrect = userAns === q.ans;
            const statusColor = userAns === null ? 'gray' : (isCorrect ? 'green' : 'red');
            const statusText = userAns === null ? 'Skipped' : (isCorrect ? 'Correct' : 'Incorrect');

            let optsHtml = '';
            q.opts.forEach((opt, oi) => {
                let style = '';
                if (oi === q.ans) style = 'font-weight:bold; color:green;'; 
                if (oi === userAns && !isCorrect) style = 'font-weight:bold; color:red;'; 
                optsHtml += `<div style="${style}">${oi+1}. ${opt}</div>`;
            });

            container.innerHTML += `
                <div class="review-item">
                    <div style="color:${statusColor}; font-weight:bold; margin-bottom:5px;">Q${i+1}: ${statusText}</div>
                    <div>${q.text}</div>
                    <div style="margin:10px 0; padding-left:15px; border-left:3px solid #ddd;">${optsHtml}</div>
                    <div class="explanation"><strong>Explanation:</strong> ${q.exp}</div>
                </div>
            `;
        });
    }

    function resetExam() {
        localStorage.removeItem('aiims_cbt_state');
        location.reload();
    }

    function updatePersistence() {
        localStorage.setItem('aiims_cbt_state', JSON.stringify(state));
    }
    
    function toggleSidebar() {
        els.sidebar.classList.toggle('active');
    }

    init();
    </script>
</body>
</html>
