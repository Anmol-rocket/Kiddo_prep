<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIIMS CBT - Sectional Timing Mode</title>
    <style>
        :root {
            --header-bg: #3f51b5;
            --header-text: #fff;
            --panel-bg: #f5f5f5;
            --pallet-answered: #4caf50;
            --pallet-not-answered: #f44336;
            --pallet-review: #9c27b0;
            --pallet-not-visited: #e0e0e0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; }
        body { height: 100vh; display: flex; flex-direction: column; overflow: hidden; background: #fff; }

        /* --- Header --- */
        header {
            background: var(--header-bg); color: var(--header-text);
            padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
            height: 60px; flex-shrink: 0;
        }
        .timer { font-size: 1.2rem; font-weight: bold; background: #fff; color: #d32f2f; padding: 5px 15px; border-radius: 4px; border: 2px solid #d32f2f; }

        /* --- Main Layout --- */
        .main-container { display: flex; flex: 1; overflow: hidden; }
        
        .question-area { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; }
        .q-header { display: flex; justify-content: space-between; border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-bottom: 15px; }
        .q-text { font-size: 1.1rem; margin-bottom: 20px; line-height: 1.5; }
        
        .options-container { display: flex; flex-direction: column; gap: 10px; }
        .option-label { 
            display: flex; align-items: center; padding: 10px; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; transition: 0.2s; 
        }
        .option-label:hover { background: #f0f8ff; }
        .option-label input { margin-right: 15px; transform: scale(1.2); }

        /* Sidebar */
        .sidebar {
            width: 320px; background: var(--panel-bg); border-left: 1px solid #ccc;
            display: flex; flex-direction: column; flex-shrink: 0;
        }
        .user-info { padding: 10px; background: #e8eaf6; border-bottom: 1px solid #ccc; }
        
        .palette-legend { padding: 10px; font-size: 0.8rem; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; background: #fff; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }

        .question-grid { 
            padding: 10px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; 
            overflow-y: auto; flex: 1; align-content: start;
        }
        .q-btn {
            height: 35px; width: 35px; border: 1px solid #ccc; background: #fff; 
            border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
        }
        
        .q-btn.answered { background: var(--pallet-answered); color: white; border-color: var(--pallet-answered); }
        .q-btn.not-answered { background: var(--pallet-not-answered); color: white; border-color: var(--pallet-not-answered); }
        .q-btn.review { background: var(--pallet-review); color: white; border-radius: 50%; }
        .q-btn.current { border: 2px solid blue; box-shadow: 0 0 5px blue; }
        .q-btn.locked { opacity: 0.4; cursor: not-allowed; background: #444 !important; color: #888; border: 1px solid #000; }

        /* Footer */
        .footer-controls {
            height: 60px; background: #fff; border-top: 1px solid #ccc;
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
        }
        .btn { padding: 8px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.9rem; }
        .btn-primary { background: #2196f3; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-warn { background: #ff9800; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Mobile */
        .mobile-toggle { display: none; background: none; border: none; color: white; font-size: 1.5rem; }
        @media (max-width: 768px) {
            .mobile-toggle { display: block; }
            .sidebar { 
                position: absolute; right: 0; top: 60px; bottom: 60px; z-index: 100;
                transform: translateX(100%); transition: transform 0.3s; width: 85%;
            }
            .sidebar.active { transform: translateX(0); }
            .question-grid { grid-template-columns: repeat(6, 1fr); }
            .footer-controls { flex-wrap: wrap; gap: 5px; height: auto; padding: 10px; }
            .btn { flex: 1; padding: 8px; font-size: 0.8rem; }
        }

        /* Overlay */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .hidden { display: none !important; }
        
        .review-panel { display: none; padding: 20px; height: 100%; overflow-y: auto; background:#f9f9f9;}
        .review-item { margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 5px; background:white; }
        .explanation { background: #fff3cd; padding: 10px; margin-top: 10px; font-size: 0.9rem; border-left: 4px solid #ffc107; }

    </style>
</head>
<body>

    <div id="landingPage" class="overlay">
        <h1>AIIMS CRE CBT (Strict Pattern)</h1>
        <div style="width: 80%; max-width: 600px; text-align: left; margin: 20px 0;">
            <h3>Exam Rules:</h3>
            <ul>
                <li><strong>Questions:</strong> 100 (5 Sections of 20 questions each).</li>
                <li><strong>Timing:</strong> 18 Minutes per section (Strictly Dedicated).</li>
                <li><strong>Total Time:</strong> 90 Minutes.</li>
                <li><strong>Locking:</strong> Once 18 mins are up, or if you manually proceed to the next section, you <u>cannot</u> return to the previous section.</li>
                <li><strong>Marking:</strong> +4 Correct, -1 Incorrect.</li>
            </ul>
        </div>
        <button class="btn btn-success" style="font-size: 1.2rem;" onclick="startExam()">START EXAM</button>
    </div>

    <header id="examHeader" class="hidden">
        <div style="display:flex; align-items:center; gap:10px;">
            <h3>AIIMS Radiographer</h3>
            <span style="font-size:0.8rem; background:#eee; padding:2px 6px; border-radius:4px; color:#333;" id="sectionLabel">Section 1</span>
        </div>
        <div class="timer" id="timerDisplay">18:00</div>
        <button class="mobile-toggle" onclick="toggleSidebar()">☰</button>
    </header>

    <div class="main-container hidden" id="examBody">
        <div class="question-area">
            <div class="q-header">
                <span id="qNumDisplay">Question No. 1</span>
                <span style="color: #666;">Marks: +4, -1</span>
            </div>
            <div id="questionText" class="q-text">Loading...</div>
            <div id="optionsBox" class="options-container"></div>
        </div>

        <div class="sidebar" id="sidebar">
            <div class="user-info">
                <strong>Candidate Name</strong><br><small>Roll No: 123456</small>
            </div>
            <div class="palette-legend">
                <div class="legend-item"><span class="dot" style="background:var(--pallet-answered)"></span> Ans</div>
                <div class="legend-item"><span class="dot" style="background:var(--pallet-not-answered)"></span> Not Ans</div>
                <div class="legend-item"><span class="dot" style="background:var(--pallet-review)"></span> Review</div>
                <div class="legend-item"><span class="dot" style="background:#444"></span> Locked</div>
            </div>
            <div class="question-grid" id="questionPalette"></div>
            <div style="padding:10px; margin-top:auto;">
                <button class="btn btn-primary" style="width:100%" onclick="submitExam()">FINISH EXAM</button>
            </div>
        </div>
    </div>

    <div class="footer-controls hidden" id="examFooter">
        <div style="display:flex; gap:10px;">
            <button class="btn btn-danger" onclick="clearResponse()">Clear</button>
            <button class="btn btn-warn" onclick="markForReview()">Review</button>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn" onclick="prevQuestion()" id="btnPrev">Previous</button>
            <button class="btn btn-success" onclick="saveAndNext()">Save & Next</button>
        </div>
    </div>

    <div id="resultPage" class="overlay hidden" style="display:block; overflow-y:auto; justify-content:start; padding-top:40px;">
        <h2 style="text-align:center;">Exam Summary</h2>
        <div id="scoreCard" style="margin: 20px auto; width:90%; max-width:600px; padding: 20px; border: 1px solid #ccc; text-align: center; background:#fff;"></div>
        <div style="display:flex; justify-content:center; gap:20px; margin-bottom:20px;">
            <button class="btn btn-primary" onclick="showDetailedReview()">Review Solutions</button>
            <button class="btn btn-danger" onclick="location.reload()">Exit</button>
        </div>
        <div id="detailedReview" class="review-panel" style="width: 90%; max-width: 800px; margin:0 auto;"></div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const TOTAL_QUESTIONS = 100;
        const SECTION_SIZE = 20; // 20 questions per section
        const SECTION_TIME_LIMIT = 18 * 60; // 18 minutes in seconds
        
        let questions = [];

function generateQuestions() {
        const createQ = (id, type, text, opts, ans, exp) => ({ id, type, text, opts, ans, exp });
        questions = []; // Reset array

        // --- SECTION A: NON-CORE (1-20) ---
        // Difficulty: High (Tricky Reasoning & GK)

        const nonCoreData = [
            // Reasoning & Math
            ["If 'P' denotes 'multiplied by', 'T' denotes 'subtracted from', 'M' denotes 'added to' and 'B' denotes 'divided by', then: 28 B 7 P 8 T 6 M 4 = ?", ["32", "30", "34", "28"], 1, "28 / 7 * 8 - 6 + 4 => 4 * 8 - 6 + 4 => 32 - 6 + 4 = 30."],
            ["A man walks 1 km to East and then he turns to South and walks 5 km. Again he turns to East and walks 2 km. After this he turns to North and walks 9 km. How far is he from his starting point?", ["3 km", "4 km", "5 km", "7 km"], 2, "Net East = 1 + 2 = 3 km. Net North = 9 - 5 = 4 km. Hypotenuse = √(3² + 4²) = 5 km."],
            ["Statement: 'Opening a library in Rama's village will be a wastage.' Assumptions: I. Inhabitants of Rama's village are illiterate. II. Inhabitants are not interested in reading.", ["Only I is implicit", "Only II is implicit", "Either I or II is implicit", "Neither I nor II is implicit"], 2, "Wastage implies it won't be used. This could be because they can't read (I) OR they don't want to (II). Either could be the reason."],
            ["Choose the odd number pair: 14-9, 17-8, 42-3, 21-6.", ["17-8", "14-9", "42-3", "21-6"], 0, "Product logic? 14*9=126. 42*3=126. 21*6=126. 17*8=136. So 17-8 is the odd one."],
            ["In a class, the average age of 40 boys is 16.95 years and that of the remaining 20 boys is 15.95 years. Calculate the average age of the whole class.", ["16.25", "16.61", "16.55", "16.45"], 1, "Total sum = (40*16.95) + (20*15.95). Total boys = 60. Avg = (678 + 319)/60 = 997/60 = 16.616."],

            // GK (Current & Static)
            ["The 'Nobel Prize' for Literature 2023 was awarded to:", ["Jon Fosse", "Annie Ernaux", "Abdulrazak Gurnah", "Murakami"], 0, "Jon Fosse (Norwegian author)."],
            ["Which city has been declared as India’s first 'UNESCO City of Literature'?", ["Kolkata", "Jaipur", "Kozhikode", "Varanasi"], 2, "Kozhikode (Kerala)."],
            ["The term 'Bull' and 'Bear' are associated with:", ["Banking", "Foreign Trade", "Stock Market", "Internet Commerce"], 2, "Stock Market trends."],
            ["Who is the current Chief Election Commissioner of India (2024)?", ["Rajiv Kumar", "Sunil Arora", "Sushil Chandra", "T.N. Seshan"], 0, "Rajiv Kumar."],
            ["'Project Tiger' was launched in India in the year:", ["1972", "1973", "1980", "1992"], 1, "1973."],

            // English
            ["Synonym of 'VINDICATE':", ["Accuse", "Justify", "Destroy", "Convict"], 1, "Vindicate means to clear of blame or justify."],
            ["Antonym of 'PROFANE':", ["Sacred", "Wild", "Artistic", "Rude"], 0, "Profane means disrespectful; Sacred is the opposite."],
            ["Idiom 'To read between the lines':", ["To suspect", "To read carefully", "To understand the hidden meaning", "To do useless work"], 2, "Understanding implied meaning."],
            ["Find the error: 'The news were broadcasted last night.'", ["The news", "were", "broadcasted", "last night"], 2, "'Broadcast' remains 'broadcast' in past tense. Also 'News' is singular, so 'was broadcast'."],
            ["One who possesses many talents:", ["Versatile", "Gifted", "Nubile", "Exceptional"], 0, "Versatile."],

            // Computers
            ["Which key is used to refresh the active window?", ["F5", "F2", "F7", "F12"], 0, "F5."],
            ["What is the full form of 'PDF'?", ["Portable Data File", "Portable Document Format", "Public Document File", "Primary Data Format"], 1, "Portable Document Format."],
            ["The protocol used to browse websites is:", ["SMTP", "FTP", "HTTP", "TCP"], 2, "HTTP/HTTPS."],
            ["Which is NOT an Operating System?", ["Linux", "Windows", "Oracle", "Android"], 2, "Oracle is a Database."],
            ["'Ctrl + B' in MS Word is used to:", ["Italicize", "Bold", "Underline", "Save"], 1, "Bold."]
        ];
        nonCoreData.forEach((d, i) => questions.push(createQ(i + 1, "Non-Core", d[0], d[1], d[2], d[3])));


        // --- SECTION B: CORE (21-100) ---
        // Mixed & Randomized Answers

        const coreData = [
            // 1. Physics & Dosimetry (21-40)
            ["Which of the following has the highest 'Specific Ionization'?", ["Alpha Particles", "Beta Particles", "Gamma Rays", "X-rays"], 0, "Alpha particles have high charge and mass, causing dense ionization."],
            ["The 'Half Value Layer' (HVL) is related to the Linear Attenuation Coefficient (u) by the formula:", ["HVL = 0.693 / u", "HVL = u / 0.693", "HVL = 0.693 * u", "HVL = u^2"], 0, "HVL = ln(2) / u = 0.693 / u."],
            ["1 Gray (Gy) is equivalent to:", ["1 Joule/kg", "100 Joules/kg", "10 Joules/kg", "0.01 Joule/kg"], 0, "Definition: 1 Gy = 1 J/kg."],
            ["In the interaction of X-rays, 'Coherent Scattering' (Thompson/Rayleigh) occurs primarily at:", ["High energies (> 1 MeV)", "Very low energies (< 10 keV)", "Diagnostic range (60-100 keV)", "Therapeutic range"], 1, "Low energies; contributes only to fog, no energy transfer."],
            ["The 'Focal Spot Blur' (Geometric Unsharpness) is reduced by:", ["Increasing Focal Spot Size", "Decreasing SID", "Decreasing OID", "Increasing OID"], 2, "Small OID reduces magnification and blur."],
            ["In a CR system, the 'Exposure Index' (S-number in Fuji) is inversely proportional to exposure. If the S-number is 400 (Target 200), the image is:", ["Overexposed", "Underexposed", "Perfectly exposed", "Fogged"], 1, "Fuji S-number: Higher number = Lower dose. 400 is half the dose of 200 -> Underexposed."],
            ["The 'Grid Ratio' of a grid with 3mm high strips and 0.25mm interspace is:", ["8:1", "10:1", "12:1", "6:1"], 2, "3 / 0.25 = 12:1."],
            ["Which component of the Image Intensifier focuses the electrons?", ["Input Phosphor", "Photocathode", "Electrostatic Lenses", "Anode"], 2, "Electrostatic lenses."],
            ["'Minification Gain' in an II tube is calculated as:", ["(Input Diameter / Output Diameter)^2", "(Output / Input)^2", "Input Area * Output Area", "Flux Gain / 2"], 0, "Ratio of squares of diameters."],
            ["The 'K-edge' of Iodine (contrast media) is approx:", ["20 keV", "33 keV", "50 keV", "69 keV"], 1, "33.2 keV."],
            ["'Off-Focus Radiation' is produced at:", ["The Focal Track", "The Filament", "The Anode Stem or Disc outside the focal spot", "The Window"], 2, "Electrons hitting outside the target area."],
            ["Which generator has the least voltage ripple?", ["Single Phase", "3-Phase 6-Pulse", "3-Phase 12-Pulse", "High Frequency"], 3, "High Frequency (<1% ripple)."],
            ["'Dose Area Product' (DAP) is measured in:", ["mGy", "mGy-cm^2", "Sv", "C/kg"], 1, "Dose x Area (mGy-cm^2)."],
            ["The 'Oxygen Enhancement Ratio' (OER) is significant for:", ["High LET radiation", "Low LET radiation (X/Gamma)", "Alpha particles", "Neutrons"], 1, "Oxygen makes Low LET radiation more damaging (free radicals)."],
            ["'Stochastic Effects' are assumed to follow which dose-response relationship?", ["Linear Threshold", "Linear Non-Threshold", "Non-Linear Threshold", "Sigmoid"], 1, "LNT Model (No safe dose)."],
            ["The annual dose limit for the 'Lens of the Eye' for radiation workers (ICRP) is:", ["150 mSv", "50 mSv", "20 mSv", "500 mSv"], 2, "Revised down to 20 mSv/year (averaged) to prevent cataracts."],
            ["A 'Wedge Filter' is used for:", ["Skull X-ray", "Foot (Dorsoplantar) / T-spine", "Chest X-ray", "Hand"], 1, "Compensates for thickness difference in foot or T-spine."],
            ["Which material is used for the 'Input Phosphor' of an Image Intensifier?", ["Zinc Cadmium Sulfide", "Cesium Iodide (CsI)", "Calcium Tungstate", "Gadolinium"], 1, "Cesium Iodide."],
            ["The 'Anode Heel Effect' is more uniform (less noticeable) with:", ["Short SID", "Large Film Size", "Long SID", "Steep Anode Angle"], 2, "Long SID uses the central, more uniform part of the beam."],
            ["'Subject Contrast' is chiefly controlled by:", ["mAs", "Focal Spot", "kVp", "Grid"], 2, "kVp determines differential absorption."],

            // 2. Anatomy & Procedures (41-65)
            ["The 'Greater Tubercle' is a landmark on the:", ["Femur", "Humerus", "Tibia", "Radius"], 1, "Proximal Humerus (Lateral aspect)."],
            ["Which projection demonstrates the 'Intercondylar Fossa' of the knee?", ["AP", "Lateral", "Tunnel View (Camp-Coventry)", "Skyline"], 2, "Tunnel view."],
            ["'Colles Fracture' involves the:", ["Distal Radius (Dorsal tilt)", "Distal Radius (Volar tilt)", "Proximal Ulna", "Scaphoid"], 0, "Distal Radius with Dorsal displacement."],
            ["The 'Sella Turcica' is best visualized on a:", ["PA Skull", "Lateral Skull", "Towne View", "SMV"], 1, "Lateral Skull."],
            ["'Stenvers View' demonstrates the:", ["Petrous Temporal Bone", "Optic Foramen", "Mandible", "Zygoma"], 0, "Petrous ridge profile."],
            ["The 'Common Bile Duct' is formed by the union of:", ["Cystic Duct and Common Hepatic Duct", "Right and Left Hepatic Ducts", "Pancreatic Duct and Cystic Duct", "None"], 0, "Cystic + Common Hepatic."],
            ["'McBurney's Point' corresponds to the location of the:", ["Gallbladder", "Appendix", "Spleen", "Left Kidney"], 1, "Appendix (RLQ)."],
            ["Which carpal bone articulates with the 3rd Metacarpal?", ["Trapezoid", "Capitate", "Hamate", "Lunate"], 1, "Capitate (Largest carpal, central)."],
            ["The 'Odontoid Process' (Dens) is part of:", ["C1 (Atlas)", "C2 (Axis)", "C7", "Occiput"], 1, "Axis (C2)."],
            ["'Spondylolisthesis' is most commonly seen at:", ["L5-S1", "L1-L2", "T12-L1", "C1-C2"], 0, "L5-S1 junction."],
            ["The 'Navicular' bone of the foot articulates posteriorly with the:", ["Calcaneus", "Talus", "Cuboid", "Cuneiforms"], 1, "Talus."],
            ["To visualize the 'Right Sacroiliac Joint' open, the patient is positioned in:", ["RPO", "LPO", "Right Lateral", "AP"], 1, "LPO (Left Posterior Oblique) opens the Right SI Joint (Side UP)."],
            ["The 'Y-View' of the shoulder is used to detect:", ["Fracture of Humeral Shaft", "Dislocation (Ant/Post)", "Rotator Cuff tear", "AC joint separation"], 1, "Dislocation."],
            ["'Hirschsprung's Disease' is characterized by:", ["Dilated proximal colon and narrowed distal segment", "Multiple polyps", "Cobblestone appearance", "Fistulas"], 0, "Megacolon due to aganglionic distal segment."],
            ["'Zenker's Diverticulum' is found in the:", ["Upper Esophagus (Pharyngeal)", "Mid Esophagus", "Lower Esophagus", "Stomach"], 0, "Posterior hypopharynx."],
            ["A 'Blow-out Fracture' involves the:", ["Nasal bone", "Orbital Floor", "Zygomatic Arch", "Mandible"], 1, "Orbital floor."],
            ["'ERCP' is used to evaluate:", ["Biliary and Pancreatic ducts", "Renal arteries", "Ureters", "Spinal cord"], 0, "Endoscopic Retrograde Cholangiopancreatography."],
            ["Which contrast agent is used for 'Myelography'?", ["Ionic Water Soluble", "Non-Ionic Water Soluble", "Barium", "Oily Iodine"], 1, "Non-ionic water soluble (Safe for intrathecal use)."],
            ["'Hysterosalpingography' (HSG) is performed to diagnose:", ["Tubal blockage / Infertility", "Ovarian cancer", "Cervical cancer", "Pregnancy"], 0, "Tubal patency."],
            ["The 'Valsalva Maneuver' helps to demonstrate:", ["Esophageal Varices", "Pyloric Stenosis", "Gastric Ulcer", "Duodenal Cap"], 0, "Distends veins in the esophagus."],
            ["'Intussusception' in children presents as:", ["Target / Donut Sign on USG", "Bird Beak sign", "Apple Core lesion", "String sign"], 0, "Bowel within bowel."],
            ["'Volvulus' of the Sigmoid colon appears as:", ["Coffee Bean Sign", "Lead Pipe", "Saw tooth", "Rat tail"], 0, "Inverted U / Coffee Bean."],
            ["'Bamboo Spine' is a sign of:", ["Ankylosing Spondylitis", "Osteoporosis", "Metastasis", "Scoliosis"], 0, "Calcified ligaments."],
            ["'Codman's Triangle' is a periosteal reaction seen in:", ["Osteosarcoma", "Bone Cyst", "Giant Cell Tumor", "Osteoma"], 0, "Malignant bone tumor."],
            ["'Rickets' is caused by deficiency of:", ["Vitamin C", "Vitamin D", "Vitamin A", "Calcium only"], 1, "Vitamin D."],

            // 3. CT/MRI/USG & Special (66-85)
            ["CT Number for 'Air' is:", ["0", "+1000", "-1000", "-100"], 2, "-1000 HU."],
            ["'Window Width' in CT controls:", ["Brightness", "Contrast", "Resolution", "Dose"], 1, "Contrast (Number of gray shades)."],
            ["'Pitch' > 1 in Helical CT results in:", ["Higher Dose", "Lower Dose", "Better Z-axis resolution", "Slower scan"], 1, "Table moves fast, gaps in helix -> Lower dose."],
            ["'Ring Artifact' in CT is caused by:", ["Patient motion", "Detector failure", "Beam hardening", "Tube arcing"], 1, "3rd Gen detector fault."],
            ["In MRI, 'T1 Weighted' image shows Fluid as:", ["Bright", "Dark", "Grey", "Mixed"], 1, "Fluid is Dark on T1."],
            ["In MRI, 'T2 Weighted' image shows Fluid as:", ["Dark", "Bright", "Grey", "Mixed"], 1, "Fluid is Bright on T2."],
            ["'STIR' sequence in MRI is used to:", ["Suppress Fat", "Suppress Fluid", "Visualize flow", "Enhance contrast"], 0, "Fat Suppression."],
            ["'FLAIR' sequence in MRI is used to:", ["Suppress Fat", "Suppress CSF (Fluid)", "Show blood", "Show bone"], 1, "Fluid Attenuated Inversion Recovery."],
            ["'Gadolinium' contrast shortens:", ["T1 relaxation time", "T2 relaxation time", "Proton density", "TR"], 0, "Shortens T1 -> Bright signal."],
            ["Contraindication for MRI:", ["Pacemaker", "Pregnancy (1st Trim)", "Cochlear Implant", "All of the above"], 3, "All are contraindications (Pacemaker/Cochlear are absolute usually)."],
            ["'Diffusion Weighted Imaging' (DWI) is most sensitive for:", ["Acute Stroke", "Tumor", "Bleed", "MS"], 0, "Cytotoxic edema restricted diffusion."],
            ["'Time of Flight' (TOF) MRA uses:", ["Contrast injection", "Flow related enhancement", "Phase shift", "Subtraction"], 1, "Flow enhancement (Inflow)."],
            ["In Ultrasound, 'Shadowing' is seen behind:", ["Fluid", "Cyst", "Stone / Bone", "Air"], 2, "High attenuation structures."],
            ["'Posterior Enhancement' in USG is seen behind:", ["Bone", "Cyst / Fluid", "Solid mass", "Air"], 1, "Low attenuation fluid."],
            ["'Mirror Image' artifact in USG occurs at:", ["Diaphragm", "Kidney", "Aorta", "Skin"], 0, "Strong reflector like Diaphragm."],
            ["'Doppler Shift' depends on:", ["Velocity of blood", "Angle of insonation", "Transducer frequency", "All of the above"], 3, "All are in the Doppler equation."],
            ["'PET' scan uses:", ["X-rays", "Gamma rays (Annihilation photons)", "Electrons", "Protons"], 1, "511 keV Gamma rays."],
            ["'FDG' in PET is an analog of:", ["Protein", "Fat", "Glucose", "Oxygen"], 2, "Glucose."],
            ["'Quench' in MRI refers to:", ["Emergency magnet shutdown (Helium boil-off)", "Computer crash", "Coil failure", "Power outage"], 0, "Helium loss."],
            ["'Chemical Shift' artifact occurs in the:", ["Frequency Encoding direction", "Phase Encoding direction", "Slice Select", "Readout"], 0, "Frequency direction."],

            // 4. Contrast & Emergency (86-100)
            ["Which contrast is 'Iso-osmolar'?", ["Iohexol", "Iopamidol", "Iodixanol (Visipaque)", "Diatrizoate"], 2, "Iodixanol."],
            ["Immediate treatment for Anaphylaxis:", ["Adrenaline", "Atropine", "Digoxin", "Heparin"], 0, "Adrenaline."],
            ["'Metformin' is stopped to prevent:", ["Lactic Acidosis", "Hypoglycemia", "Bleeding", "Nausea"], 0, "MALA."],
            ["'Shock' characterized by low BP and tachycardia is:", ["Hypovolemic", "Neurogenic", "Septic", "Cardiogenic"], 0, "Hypovolemic (Blood loss)."],
            ["Universal Donor:", ["O-", "O+", "AB+", "AB-"], 0, "O Negative."],
            ["'Needle stick injury' first step:", ["Wash with soap/water", "Squeeze", "Bandage", "Report"], 0, "Wash."],
            ["'Nosocomial' means:", ["Community acquired", "Hospital acquired", "Genetic", "Congenital"], 1, "Hospital acquired."],
            ["'Sterilization' kills:", ["Bacteria only", "Viruses only", "All spores and microbes", "Fungi"], 2, "All life forms."],
            ["'Barium Peritonitis' is caused by:", ["Aspiration", "Perforation of bowel", "Allergy", "Overdose"], 1, "Leakage into peritoneum."],
            ["'Air Embolism' patient position:", ["Right lateral", "Left Lateral Decubitus", "Supine", "Prone"], 1, "Left Lateral (traps air in Right Atrium)."],
            ["Normal Creatinine level:", ["0.6 - 1.2 mg/dL", "2.0 - 3.0", "5.0", "0.1"], 0, "0.6-1.2."],
            ["'eGFR' below which contrast is risky:", ["60", "90", "30", "15"], 2, "Below 30 is high risk."],
            ["'Pulse Oximetry' measures:", ["Blood Pressure", "Heart Rate", "O2 Saturation", "Temp"], 2, "SpO2."],
            ["'Syncope' is:", ["Vomiting", "Fainting", "Seizure", "Cough"], 1, "Fainting."],
            ["'Triage' implies:", ["Treating everyone", "Sorting patients by priority", "Sending home", "Billing"], 1, "Sorting based on severity."]
        ];

        coreData.forEach((d, i) => questions.push(createQ(21 + i, "Core", d[0], d[1], d[2], d[3])));
    }

        // --- STATE MANAGEMENT ---
        let state = {
            currentQ: 0,
            answers: new Array(TOTAL_QUESTIONS).fill(null),
            status: new Array(TOTAL_QUESTIONS).fill('not-visited'),
            currentSection: 1,      // 1 to 5
            sectionTimeLeft: SECTION_TIME_LIMIT,
            maxSetReached: 1,       // Tracks highest section unlocked
            isFinished: false
        };

        const els = {
            landing: document.getElementById('landingPage'),
            header: document.getElementById('examHeader'),
            body: document.getElementById('examBody'),
            footer: document.getElementById('examFooter'),
            result: document.getElementById('resultPage'),
            qText: document.getElementById('questionText'),
            optsBox: document.getElementById('optionsBox'),
            qNum: document.getElementById('qNumDisplay'),
            sectionLabel: document.getElementById('sectionLabel'),
            palette: document.getElementById('questionPalette'),
            timer: document.getElementById('timerDisplay'),
            btnPrev: document.getElementById('btnPrev'),
            sidebar: document.getElementById('sidebar')
        };

        let timerInterval;

        function init() {
            generateQuestions(); // Load data
            // Persistence check could go here, but for strict timing, fresh start is safer
            els.landing.classList.remove('hidden');
            els.result.classList.add('hidden');
        }

        function startExam() {
            els.landing.classList.add('hidden');
            renderExamInterface();
            startSectionTimer();
        }

        function startSectionTimer() {
            if(timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                state.sectionTimeLeft--;
                
                // Format Time
                const m = Math.floor(state.sectionTimeLeft / 60);
                const s = state.sectionTimeLeft % 60;
                els.timer.innerText = `${m}:${s < 10 ? '0'+s : s}`;
                
                // Visual Warning
                if(state.sectionTimeLeft < 60) els.timer.style.backgroundColor = "#ffcdd2";
                else els.timer.style.backgroundColor = "#fff";

                // Time Up Logic
                if (state.sectionTimeLeft <= 0) {
                    handleSectionTimeout();
                }
            }, 1000);
        }

        function handleSectionTimeout() {
            clearInterval(timerInterval);
            
            if (state.currentSection < 5) {
                alert(`Time is up for Section ${state.currentSection}! Moving to Section ${state.currentSection + 1}.`);
                forceNextSection();
            } else {
                alert("Time is up for the final section! Submitting Exam.");
                finishExam();
            }
        }

        function forceNextSection() {
            state.currentSection++;
            state.maxSetReached = state.currentSection;
            state.sectionTimeLeft = SECTION_TIME_LIMIT;
            
            // Move to first question of next section
            const firstQofNextSection = (state.currentSection - 1) * SECTION_SIZE;
            loadQuestion(firstQofNextSection);
            startSectionTimer();
        }

        function renderExamInterface() {
            els.header.classList.remove('hidden');
            els.body.classList.remove('hidden');
            els.footer.classList.remove('hidden');
            renderPalette();
            loadQuestion(state.currentQ);
        }

        function loadQuestion(index) {
            state.currentQ = index;
            if(state.status[index] === 'not-visited') state.status[index] = 'not-answered';

            // Update Section Label
            const secNum = Math.floor(index / SECTION_SIZE) + 1;
            els.sectionLabel.innerText = `Section ${secNum} (Q${(secNum-1)*20 + 1}-${secNum*20})`;

            // Render Text
            els.qNum.innerText = `Question ${index + 1}`;
            els.qText.innerText = questions[index].text;
            
            // Render Options
            els.optsBox.innerHTML = '';
            questions[index].opts.forEach((opt, i) => {
                const isChecked = state.answers[index] === i ? 'checked' : '';
                els.optsBox.innerHTML += `
                    <label class="option-label">
                        <input type="radio" name="opt" value="${i}" ${isChecked} onchange="selectOption(${i})">
                        ${opt}
                    </label>
                `;
            });

            // Update Palette UI
            document.querySelectorAll('.q-btn').forEach(b => b.classList.remove('current'));
            const currentBtn = document.getElementById(`qbtn-${index}`);
            if(currentBtn) currentBtn.classList.add('current');

            // Handle Prev Button State (Cannot go back to previous locked section)
            const startOfCurrentSection = (state.currentSection - 1) * SECTION_SIZE;
            els.btnPrev.disabled = (index <= startOfCurrentSection);
        }

        function selectOption(optIndex) {
            state.answers[state.currentQ] = optIndex;
        }

        function saveAndNext() {
            const index = state.currentQ;
            // Update status
            state.status[index] = (state.answers[index] !== null) ? 'answered' : 'not-answered';
            
            moveToNextQuestion();
        }

        function markForReview() {
            const index = state.currentQ;
            state.status[index] = (state.answers[index] !== null) ? 'marked-answered' : 'review'; // Simplified
            moveToNextQuestion();
        }

        function clearResponse() {
            state.answers[state.currentQ] = null;
            state.status[state.currentQ] = 'not-answered';
            loadQuestion(state.currentQ);
            renderPalette();
        }

        function moveToNextQuestion() {
            const nextIndex = state.currentQ + 1;
            const currentSecBound = state.currentSection * SECTION_SIZE;

            // Check if next question crosses section boundary
            if (nextIndex >= currentSecBound) {
                // End of section reached
                if (state.currentSection < 5) {
                    if (confirm(`You have reached the end of Section ${state.currentSection}.\nDo you want to submit this section and move to Section ${state.currentSection+1}?\n\nWARNING: You cannot return to this section.`)) {
                        forceNextSection();
                    }
                } else {
                    if(confirm("This was the last question. Submit Exam?")) {
                        finishExam();
                    }
                }
            } else {
                // Normal movement within section
                renderPalette();
                loadQuestion(nextIndex);
            }
        }

        function prevQuestion() {
            // Logic handled in loadQuestion to disable button if at start of section
            if (state.currentQ > 0) {
                loadQuestion(state.currentQ - 1);
            }
        }

        function renderPalette() {
            els.palette.innerHTML = '';
            for (let i = 0; i < TOTAL_QUESTIONS; i++) {
                let statusClass = state.status[i];
                if(statusClass === 'marked-answered') statusClass = 'review';
                
                // Check if question belongs to a locked (previous) section
                // A question is locked if its section index is < current active section
                const qSection = Math.floor(i / SECTION_SIZE) + 1;
                const isLocked = qSection < state.currentSection;
                const lockedClass = isLocked ? ' locked' : '';
                
                // Gray out future sections
                const isFuture = qSection > state.currentSection;
                const futureStyle = isFuture ? 'opacity:0.3; pointer-events:none;' : '';

                els.palette.innerHTML += `
                    <div id="qbtn-${i}" 
                         class="q-btn ${statusClass}${lockedClass}" 
                         style="${futureStyle}"
                         onclick="jumpToQuestion(${i})">
                        ${i + 1}
                    </div>
                `;
            }
        }

        function jumpToQuestion(index) {
            const qSection = Math.floor(index / SECTION_SIZE) + 1;
            
            if (qSection < state.currentSection) {
                alert("This section is locked.");
                return;
            }
            if (qSection > state.currentSection) {
                alert("You cannot jump to a future section yet.");
                return;
            }
            
            loadQuestion(index);
        }

        function submitExam() {
            if(confirm("Are you sure you want to finish the exam? Unanswered questions in future sections will be marked zero.")) {
                finishExam();
            }
        }

        function finishExam() {
            clearInterval(timerInterval);
            state.isFinished = true;
            
            els.header.classList.add('hidden');
            els.body.classList.add('hidden');
            els.footer.classList.add('hidden');
            els.result.classList.remove('hidden');
            
            calculateResult();
        }

        function calculateResult() {
            let correct = 0, wrong = 0, unattempted = 0, score = 0;

            state.answers.forEach((ans, i) => {
                if (ans === null) {
                    unattempted++;
                } else if (questions[i] && ans === questions[i].ans) {
                    correct++;
                    score += 4;
                } else {
                    wrong++;
                    score -= 1;
                }
            });

            document.getElementById('scoreCard').innerHTML = `
                <h1 style="color:#3f51b5; font-size:3rem;">${score} / 400</h1>
                <p><strong>Correct:</strong> ${correct} (+${correct*4})</p>
                <p><strong>Incorrect:</strong> ${wrong} (-${wrong})</p>
                <p><strong>Unattempted:</strong> ${unattempted}</p>
            `;
        }

        function showDetailedReview() {
            const container = document.getElementById('detailedReview');
            container.style.display = 'block';
            container.innerHTML = '<h3>Detailed Solutions</h3>';
            
            questions.forEach((q, i) => {
                const userAns = state.answers[i];
                const isCorrect = userAns === q.ans;
                const statusColor = userAns === null ? 'gray' : (isCorrect ? 'green' : 'red');
                const statusText = userAns === null ? 'Skipped' : (isCorrect ? 'Correct' : 'Incorrect');

                let optsHtml = '';
                q.opts.forEach((opt, oi) => {
                    let style = '';
                    if (oi === q.ans) style = 'font-weight:bold; color:green;'; 
                    if (oi === userAns && !isCorrect) style = 'font-weight:bold; color:red;'; 
                    optsHtml += `<div style="${style}">${oi+1}. ${opt}</div>`;
                });

                container.innerHTML += `
                    <div class="review-item">
                        <div style="color:${statusColor}; font-weight:bold; margin-bottom:5px;">Q${i+1}: ${statusText}</div>
                        <div>${q.text}</div>
                        <div style="margin:10px 0; padding-left:15px; border-left:3px solid #ddd;">${optsHtml}</div>
                        <div class="explanation"><strong>Explanation:</strong> ${q.exp}</div>
                    </div>
                `;
            });
        }

        function toggleSidebar() {
            els.sidebar.classList.toggle('active');
        }

        // Initialize
        init();

    </script>
</body>
</html>
