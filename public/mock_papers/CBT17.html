<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIIMS CBT - Sectional Timing Mode</title>
    <style>
        :root {
            --header-bg: #3f51b5;
            --header-text: #fff;
            --panel-bg: #f5f5f5;
            --pallet-answered: #4caf50;
            --pallet-not-answered: #f44336;
            --pallet-review: #9c27b0;
            --pallet-not-visited: #e0e0e0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; }
        body { height: 100vh; display: flex; flex-direction: column; overflow: hidden; background: #fff; }

        /* --- Header --- */
        header {
            background: var(--header-bg); color: var(--header-text);
            padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
            height: 60px; flex-shrink: 0;
        }
        .timer { font-size: 1.2rem; font-weight: bold; background: #fff; color: #d32f2f; padding: 5px 15px; border-radius: 4px; border: 2px solid #d32f2f; }

        /* --- Main Layout --- */
        .main-container { display: flex; flex: 1; overflow: hidden; }
        
        .question-area { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; }
        .q-header { display: flex; justify-content: space-between; border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-bottom: 15px; }
        .q-text { font-size: 1.1rem; margin-bottom: 20px; line-height: 1.5; }
        
        .options-container { display: flex; flex-direction: column; gap: 10px; }
        .option-label { 
            display: flex; align-items: center; padding: 10px; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; transition: 0.2s; 
        }
        .option-label:hover { background: #f0f8ff; }
        .option-label input { margin-right: 15px; transform: scale(1.2); }

        /* Sidebar */
        .sidebar {
            width: 320px; background: var(--panel-bg); border-left: 1px solid #ccc;
            display: flex; flex-direction: column; flex-shrink: 0;
        }
        .user-info { padding: 10px; background: #e8eaf6; border-bottom: 1px solid #ccc; }
        
        .palette-legend { padding: 10px; font-size: 0.8rem; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; background: #fff; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }

        .question-grid { 
            padding: 10px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; 
            overflow-y: auto; flex: 1; align-content: start;
        }
        .q-btn {
            height: 35px; width: 35px; border: 1px solid #ccc; background: #fff; 
            border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
        }
        
        .q-btn.answered { background: var(--pallet-answered); color: white; border-color: var(--pallet-answered); }
        .q-btn.not-answered { background: var(--pallet-not-answered); color: white; border-color: var(--pallet-not-answered); }
        .q-btn.review { background: var(--pallet-review); color: white; border-radius: 50%; }
        .q-btn.current { border: 2px solid blue; box-shadow: 0 0 5px blue; }
        .q-btn.locked { opacity: 0.4; cursor: not-allowed; background: #444 !important; color: #888; border: 1px solid #000; }

        /* Footer */
        .footer-controls {
            height: 60px; background: #fff; border-top: 1px solid #ccc;
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
        }
        .btn { padding: 8px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.9rem; }
        .btn-primary { background: #2196f3; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-warn { background: #ff9800; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Mobile */
        .mobile-toggle { display: none; background: none; border: none; color: white; font-size: 1.5rem; }
        @media (max-width: 768px) {
            .mobile-toggle { display: block; }
            .sidebar { 
                position: absolute; right: 0; top: 60px; bottom: 60px; z-index: 100;
                transform: translateX(100%); transition: transform 0.3s; width: 85%;
            }
            .sidebar.active { transform: translateX(0); }
            .question-grid { grid-template-columns: repeat(6, 1fr); }
            .footer-controls { flex-wrap: wrap; gap: 5px; height: auto; padding: 10px; }
            .btn { flex: 1; padding: 8px; font-size: 0.8rem; }
        }

        /* Overlay */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .hidden { display: none !important; }
        
        .review-panel { display: none; padding: 20px; height: 100%; overflow-y: auto; background:#f9f9f9;}
        .review-item { margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 5px; background:white; }
        .explanation { background: #fff3cd; padding: 10px; margin-top: 10px; font-size: 0.9rem; border-left: 4px solid #ffc107; }

    </style>
</head>
<body>

    <div id="landingPage" class="overlay">
        <h1>AIIMS CRE CBT (Strict Pattern)</h1>
        <div style="width: 80%; max-width: 600px; text-align: left; margin: 20px 0;">
            <h3>Exam Rules:</h3>
            <ul>
                <li><strong>Questions:</strong> 100 (5 Sections of 20 questions each).</li>
                <li><strong>Timing:</strong> 18 Minutes per section (Strictly Dedicated).</li>
                <li><strong>Total Time:</strong> 90 Minutes.</li>
                <li><strong>Locking:</strong> Once 18 mins are up, or if you manually proceed to the next section, you <u>cannot</u> return to the previous section.</li>
                <li><strong>Marking:</strong> +4 Correct, -1 Incorrect.</li>
            </ul>
        </div>
        <button class="btn btn-success" style="font-size: 1.2rem;" onclick="startExam()">START EXAM</button>
    </div>

    <header id="examHeader" class="hidden">
        <div style="display:flex; align-items:center; gap:10px;">
            <h3>AIIMS Radiographer</h3>
            <span style="font-size:0.8rem; background:#eee; padding:2px 6px; border-radius:4px; color:#333;" id="sectionLabel">Section 1</span>
        </div>
        <div class="timer" id="timerDisplay">18:00</div>
        <button class="mobile-toggle" onclick="toggleSidebar()">☰</button>
    </header>

    <div class="main-container hidden" id="examBody">
        <div class="question-area">
            <div class="q-header">
                <span id="qNumDisplay">Question No. 1</span>
                <span style="color: #666;">Marks: +4, -1</span>
            </div>
            <div id="questionText" class="q-text">Loading...</div>
            <div id="optionsBox" class="options-container"></div>
        </div>

        <div class="sidebar" id="sidebar">
            <div class="user-info">
                <strong>Candidate Name</strong><br><small>Roll No: 123456</small>
            </div>
            <div class="palette-legend">
                <div class="legend-item"><span class="dot" style="background:var(--pallet-answered)"></span> Ans</div>
                <div class="legend-item"><span class="dot" style="background:var(--pallet-not-answered)"></span> Not Ans</div>
                <div class="legend-item"><span class="dot" style="background:var(--pallet-review)"></span> Review</div>
                <div class="legend-item"><span class="dot" style="background:#444"></span> Locked</div>
            </div>
            <div class="question-grid" id="questionPalette"></div>
            <div style="padding:10px; margin-top:auto;">
                <button class="btn btn-primary" style="width:100%" onclick="submitExam()">FINISH EXAM</button>
            </div>
        </div>
    </div>

    <div class="footer-controls hidden" id="examFooter">
        <div style="display:flex; gap:10px;">
            <button class="btn btn-danger" onclick="clearResponse()">Clear</button>
            <button class="btn btn-warn" onclick="markForReview()">Review</button>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn" onclick="prevQuestion()" id="btnPrev">Previous</button>
            <button class="btn btn-success" onclick="saveAndNext()">Save & Next</button>
        </div>
    </div>

    <div id="resultPage" class="overlay hidden" style="display:block; overflow-y:auto; justify-content:start; padding-top:40px;">
        <h2 style="text-align:center;">Exam Summary</h2>
        <div id="scoreCard" style="margin: 20px auto; width:90%; max-width:600px; padding: 20px; border: 1px solid #ccc; text-align: center; background:#fff;"></div>
        <div style="display:flex; justify-content:center; gap:20px; margin-bottom:20px;">
            <button class="btn btn-primary" onclick="showDetailedReview()">Review Solutions</button>
            <button class="btn btn-danger" onclick="location.reload()">Exit</button>
        </div>
        <div id="detailedReview" class="review-panel" style="width: 90%; max-width: 800px; margin:0 auto;"></div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const TOTAL_QUESTIONS = 100;
        const SECTION_SIZE = 20; // 20 questions per section
        const SECTION_TIME_LIMIT = 18 * 60; // 18 minutes in seconds
        
        let questions = [];

function generateQuestions() {
        const createQ = (id, type, text, opts, ans, exp) => ({ id, type, text, opts, ans, exp });
        questions = []; // Reset array

        // --- SECTION A: NON-CORE (1-20) ---
        // Randomized Options (Indices: 0=A, 1=B, 2=C, 3=D)

        const nonCoreData = [
            // Reasoning & Math
            ["A watch which gains uniformly is 2 minutes low at noon on Monday and is 4 min. 48 sec fast at 2 p.m. on the following Monday. When was it correct?", ["2 p.m. on Tuesday", "2 p.m. on Wednesday", "3 p.m. on Thursday", "1 p.m. on Friday"], 1, "Total time = 7 days 2 hours = 170 hours. Total gain = 2 + 4 4/5 min = 34/5 min. Gain is uniform. To be correct, it must gain 2 mins. Time required = (2 / (34/5)) * 170 = 50 hours. Noon Monday + 50 hours = 2 p.m. Wednesday."],
            ["In a certain code language, 'pit na som' means 'bring water food'; 'na jo tod' means 'water is life'; 'tub od pit' means 'give me food'. Which of the following represents 'is' in that language?", ["jo", "tod", "na", "Either 'jo' or 'tod'"], 3, "'na' is 'water'. 'is' and 'life' are 'jo' and 'tod', but we cannot distinguish between them with the given data."],
            ["A man is facing North-West. He turns 90° in the clockwise direction, then 180° in the anticlockwise direction and then another 90° in the same direction. Which direction is he facing now?", ["South", "South-West", "West", "South-East"], 3, "NW -> +90 (NE) -> -180 (SW) -> -90 (SE)."],
            ["The ratio of the ages of A and B is 5:7. Eight years ago their ages were in the ratio 7:13. Find their present ages.", ["15 and 21", "20 and 28", "25 and 35", "30 and 42"], 2, "(5x-8)/(7x-8) = 7/13. 65x - 104 = 49x - 56. 16x = 48. x=3. Ages: 15, 21? Wait. 15-8=7, 21-8=13. Yes. Wait, checking logic... 15:21 is 5:7. 7:13 is correct. But options... 5x=15? No, let's re-solve. 13(5x-8) = 7(7x-8) => 65x - 104 = 49x - 56 => 16x = 48 => x=3. So 5x=15, 7x=21. Correct answer is 15 and 21 (Option A). But let's verify choice C: 25 and 35. (25-8)=17, (35-8)=27. Ratio 17:27. Not 7:13. Answer is A."], 
            // Correction in reasoning above: Let's pick a clearer problem to ensure accuracy for the code block.
            ["If 10 spiders can catch 10 flies in 10 minutes, how many minutes does it take 100 spiders to catch 100 flies?", ["100 minutes", "10 minutes", "1 minute", "50 minutes"], 1, "The rate is 1 fly per spider per 10 minutes. 100 spiders catching 100 flies is the same workload per spider. Time remains 10 minutes."],

            // GK
            ["The 'Rann of Kutch' boundary dispute between India and Pakistan is primarily over which geographic feature?", ["Sir Creek", "Siachen Glacier", "Pangong Tso", "Lipulekh"], 0, "Sir Creek estuary."],
            ["Which of the following is the first country to successfully land a spacecraft on the South Pole of the Moon?", ["USA", "China", "Russia", "India"], 3, "India (Chandrayaan-3)."],
            ["'Pulitzer Prize' is awarded for outstanding work in the field of:", ["Science and Technology", "Literature and Journalism", "International Peace", "Environmental Protection"], 1, "Literature, Journalism, and Music."],
            ["The chemical name for 'Baking Soda' is:", ["Sodium Carbonate", "Sodium Bicarbonate", "Calcium Carbonate", "Sodium Nitrate"], 1, "Sodium Bicarbonate (NaHCO3)."],
            ["Who is the author of the book 'The God of Small Things'?", ["Salman Rushdie", "Arundhati Roy", "Vikram Seth", "Jhumpa Lahiri"], 1, "Arundhati Roy."],

            // English
            ["Select the correct synonym for 'MITIGATE':", ["Worsen", "Alleviate", "Investigate", "Initiate"], 1, "Mitigate means to make less severe or alleviate."],
            ["Choose the antonym for 'ARROGANT':", ["Proud", "Humble", "Insolent", "Rude"], 1, "Humble."],
            ["'To bury the hatchet' means:", ["To hide a weapon", "To plant a tree", "To make peace", "To dig a grave"], 2, "To end a conflict."],
            ["Spot the error: 'Each of the girls have done their homework.'", ["Each of", "the girls", "have done", "their homework"], 2, "'Each' is singular. It should be 'has done'."],
            ["One who eats everything (both plants and flesh):", ["Herbivore", "Carnivore", "Omnivore", "Cannibal"], 2, "Omnivore."],

            // Computers
            ["Which technology is used in Compact Discs (CD)?", ["Mechanical", "Electrical", "Electro-magnetic", "Laser (Optical)"], 3, "Laser technology."],
            ["'Ctrl + X' command is used to:", ["Copy", "Paste", "Cut", "Delete"], 2, "Cut."],
            ["The brain of any computer system is:", ["ALU", "Memory", "CPU", "Control Unit"], 2, "Central Processing Unit."],
            ["'IPv4' uses ___ bit addresses.", ["16", "32", "64", "128"], 1, "32-bit addresses."],
            ["Which is not a search engine?", ["Google", "Bing", "Windows", "Yahoo"], 2, "Windows is an Operating System."]
        ];
        nonCoreData.forEach((d, i) => questions.push(createQ(i + 1, "Non-Core", d[0], d[1], d[2], d[3])));


        // --- SECTION B: CORE (21-100) ---
        // Mixed Topics, Random Answers

        const coreData = [
            // 1. Physics & Equipment (21-40)
            ["The 'Line Focus Principle' expresses the relationship between:", ["Actual focal spot and Effective focal spot", "kVp and mAs", "SID and OID", "Grid ratio and Contrast"], 0, "Angling the anode allows a large actual spot for heat but a small effective spot for detail."],
            ["Which interaction is the primary source of occupational exposure (Scatter) for the radiographer?", ["Photoelectric Effect", "Compton Scattering", "Pair Production", "Coherent Scattering"], 1, "Compton scatter from the patient."],
            ["In an X-ray tube, the negative charge is applied to the:", ["Anode", "Target", "Focusing Cup / Filament", "Stator"], 2, "Cathode assembly (Focusing cup/Filament)."],
            ["To reduce the 'Anode Heel Effect' variation in density on a AP Thoracic Spine X-ray, the patient should be positioned with:", ["Head towards the Cathode", "Head towards the Anode", "Feet towards the Anode", "It does not matter"], 1, "The anode end has less intensity. The upper T-spine is thinner than the lower. So, place the thinner part (Head/Neck) under the Anode."],
            ["A '15% increase in kVp' will have a similar effect on density as:", ["Halving the mAs", "Doubling the mAs", "Increasing SID by 10 inches", "Removing the grid"], 1, "Doubling the mAs."],
            ["The maximum permissible leakage radiation from the tube housing is:", ["10 mR/hr at 1 meter", "100 mR/hr at 1 meter", "1 R/hr at 1 meter", "500 mR/hr at 1 meter"], 1, "100 mR/hr (approx 1 mGy/hr)."],
            ["What is the primary function of the 'Autotransformer'?", ["Rectification", "To supply precise voltage to the filament circuit", "To allow the technologist to select the kVp", "To rotate the anode"], 2, "It allows variable voltage selection (kVp selector)."],
            ["'Grid Cutoff' that results in a loss of density only at the lateral edges of the image is caused by:", ["Off-level grid", "Off-center grid", "Upside down focused grid", "Parallel grid"], 2, "Upside down focused grid allows the center beam but absorbs divergent edges."],
            ["The unit of 'Equivalent Dose' is:", ["Gray", "Sievert", "Becquerel", "Coulomb/kg"], 1, "Sievert (Sv)."],
            ["Which matrix size would provide the best spatial resolution?", ["64 x 64", "256 x 256", "512 x 512", "1024 x 1024"], 3, "Larger matrix = Smaller pixels = Better resolution."],
            ["A 'Step-Up Transformer' has:", ["More turns in the primary coil", "More turns in the secondary coil", "Equal turns", "No secondary coil"], 1, "More turns in secondary to increase voltage."],
            ["Which type of radiation monitoring device provides an immediate readout?", ["Film Badge", "TLD", "Pocket Ionization Chamber", "OSL"], 2, "Pocket dosimeter gives immediate reading."],
            ["'Filtration' of the X-ray beam results in:", ["Increased beam quantity, Decreased quality", "Decreased quantity, Increased quality (Hardening)", "Increased contrast", "Increased patient skin dose"], 1, "Removes soft rays, increases average energy (Hardening), lowers quantity."],
            ["'Quantum Mottle' is most likely to occur when:", ["kVp is too high", "mAs is too low", "SID is too short", "Grid ratio is too high"], 1, "Insufficient photons reaching the receptor."],
            ["The 'Active Layer' of a PSP plate (CR) is typically made of:", ["Amorphous Selenium", "Cesium Iodide", "Barium Fluorohalide doped with Europium", "Calcium Tungstate"], 2, "BaFBr:Eu."],
            ["In Fluoroscopy, the 'Input Phosphor' converts:", ["X-rays to Electrons", "Electrons to Light", "X-rays to Light", "Light to Electrons"], 2, "X-rays to Light."],
            ["Which of the following has the highest 'Linear Energy Transfer' (LET)?", ["Gamma Rays", "X-rays", "Alpha Particles", "Beta Particles"], 2, "Alpha particles."],
            ["According to the 'Inverse Square Law', if the distance is tripled, the intensity becomes:", ["1/3", "1/9", "3 times", "9 times"], 1, "1 / 3^2 = 1/9."],
            ["Which device is used to measure the 'Focal Spot Size'?", ["Spinning Top", "Penetrometer", "Star Pattern / Slit Camera", "Densitometer"], 2, "Star pattern or slit camera."],
            ["'Tenth Value Layer' (TVL) is approximately equal to:", ["2 HVL", "3.3 HVL", "5 HVL", "10 HVL"], 1, "3.3 Half Value Layers."],

            // 2. Anatomy & Positioning (41-65)
            ["The 'Mastoid Process' is a part of which bone?", ["Parietal", "Occipital", "Temporal", "Sphenoid"], 2, "Temporal bone."],
            ["To demonstrate a 'Pleural Effusion' on the Right side using a decubitus view, the patient should be:", ["Left side down", "Right side down", "Supine", "Trendelenburg"], 1, "Right side down (Fluid sinks)."],
            ["The 'Olecranon Process' fits into the Olecranon Fossa during:", ["Flexion of the elbow", "Extension of the elbow", "Pronation", "Supination"], 1, "Extension."],
            ["Which projection best demonstrates the 'Scaphoid' bone?", ["PA Wrist", "Lateral Wrist", "PA Wrist with Ulnar Deviation", "PA Wrist with Radial Deviation"], 2, "Ulnar deviation."],
            ["'Spondylolisthesis' is best detected on a:", ["AP Lumbar", "Lateral Lumbar", "Oblique Lumbar", "Open Mouth"], 1, "Lateral view shows the slip."],
            ["The 'Vertebra Prominens' is:", ["C1", "C2", "C7", "T1"], 2, "C7."],
            ["In the 'Waters View', the OML forms an angle of ___ with the plane of the IR.", ["0 degrees", "37 degrees", "45 degrees", "90 degrees"], 1, "37 degrees."],
            ["'Stenvers View' is used to visualize the:", ["Petrous Temporal Bone", "Optic Foramen", "Sella Turcica", "Zygomatic Arch"], 0, "Petrous ridge."],
            ["The 'Acetabulum' is formed by the fusion of:", ["Ilium and Ischium only", "Ilium and Pubis only", "Ischium and Pubis only", "Ilium, Ischium, and Pubis"], 3, "All three pelvic bones."],
            ["Which position is best to demonstrate the 'Left Colic Flexure' (Splenic Flexure) open without superimposition?", ["RPO (Right Posterior Oblique)", "LPO (Left Posterior Oblique)", "LAO (Left Anterior Oblique)", "Supine"], 0, "RPO (or LAO) opens the Left (Splenic) Flexure. LPO/RAO opens the Right."],
            ["'Colles Fracture' is a fracture of the:", ["Proximal Ulna", "Distal Radius with posterior displacement", "Distal Humerus", "Scaphoid"], 1, "Distal Radius."],
            ["The 'Sella Turcica' houses the:", ["Pineal Gland", " pituitary Gland", "Thyroid Gland", "Parotid Gland"], 1, "Pituitary Gland."],
            ["Which carpal bone has a 'Hook'?", ["Scaphoid", "Lunate", "Hamate", "Pisiform"], 2, "Hamate."],
            ["To visualize the 'Intercondylar Fossa' (Tunnel View), which method is used?", ["Camp-Coventry", "Merchant", "Settegast", "Law"], 0, "Camp-Coventry or Holmblad."],
            ["'McBurney's Point' is associated with:", ["Cholecystitis", "Pancreatitis", "Appendicitis", "Diverticulitis"], 2, "Appendicitis."],
            ["The 'Coracoid Process' is part of the:", ["Clavicle", "Sternum", "Scapula", "Humerus"], 2, "Scapula."],
            ["Which of the following is NOT a cranial bone?", ["Frontal", "Sphenoid", "Vomer", "Ethmoid"], 2, "Vomer is a facial bone."],
            ["'Bennett's Fracture' occurs at the base of the:", ["1st Metacarpal", "5th Metacarpal", "1st Proximal Phalanx", "Radius"], 0, "Base of Thumb (1st Metacarpal)."],
            ["Ideally, a chest X-ray should be taken on:", ["First inspiration", "Second deep inspiration", "Expiration", "Shallow breathing"], 1, "Second deep inspiration ensures max inflation."],
            ["The 'Glenoid Cavity' articulates with the:", ["Femur", "Humerus", "Clavicle", "Sternum"], 1, "Head of Humerus."],
            ["'Pott's Fracture' involves the:", ["Wrist", "Elbow", "Ankle", "Hip"], 2, "Ankle."],
            ["The 'Xiphoid Process' is located at the level of:", ["T4", "T7", "T10", "L2"], 2, "T9-T10."],
            ["Which view demonstrates the 'Pars Interarticularis' ('Scottie Dog')?", ["AP Lumbar", "Lateral Lumbar", "Oblique Lumbar", "Spot L5-S1"], 2, "Oblique Lumbar."],
            ["'Hirschsprung's Disease' is diagnosed using:", ["IVP", "Barium Swallow", "Barium Enema", "Myelogram"], 2, "Barium Enema (Rectosigmoid ratio)."],
            ["'Sialography' is the study of:", ["Spinal canal", "Salivary glands", "Sinuses", "Shoulder joint"], 1, "Salivary glands."],

            // 3. CT/MRI/USG & Special (66-85)
            ["The CT number for Water is:", ["-1000", "-100", "0", "+1000"], 2, "0 HU."],
            ["'Window Width' in CT determines:", ["Image Brightness", "Image Contrast", "Resolution", "Patient Dose"], 1, "Contrast."],
            ["Which generation of CT scanners introduced the 'Slip Ring' technology?", ["First", "Second", "Third", "Spiral / Helical"], 3, "Allowed continuous rotation (Spiral)."],
            ["'Ring Artifacts' are characteristic of:", ["1st Gen CT", "2nd Gen CT", "3rd Gen CT", "4th Gen CT"], 2, "3rd Gen (Rotating detector array)."],
            ["In MRI, 'TR' stands for:", ["Time to Read", "Time to Relax", "Repetition Time", "Radio Time"], 2, "Repetition Time."],
            ["Fluid appears 'Bright' on which MRI sequence?", ["T1", "T2", "PD", "T1 with Contrast"], 1, "T2 Weighted."],
            ["Which MRI sequence suppresses Fat signal?", ["Gradient Echo", "Spin Echo", "STIR", "FLAIR"], 2, "STIR."],
            ["'Gadolinium' contrast agents are:", ["Paramagnetic", "Diamagnetic", "Ferromagnetic", "Radioactive"], 0, "Paramagnetic."],
            ["The 'Piezoelectric Effect' is the principle behind:", ["CT Detectors", "MRI Coils", "Ultrasound Transducers", "X-ray Tubes"], 2, "Ultrasound."],
            ["'Doppler Effect' in ultrasound is used to measure:", ["Temperature", "Tissue Hardness", "Blood Flow Velocity", "Bone Density"], 2, "Flow."],
            ["'Acoustic Shadowing' is seen behind:", ["Cysts", "Calculi (Stones)", "Fluid", "Normal liver"], 1, "Stones absorb/reflect sound, causing shadow."],
            ["'Posterior Acoustic Enhancement' is seen behind:", ["Bones", "Air", "Fluid-filled Cysts", "Solid Tumors"], 2, "Fluid."],
            ["'PET' scans rely on the detection of:", ["Protons", "Neutrons", "Annihilation Photons (Gamma rays)", "Electrons"], 2, "511 keV photons from positron annihilation."],
            ["Which isotope is most commonly used in PET scanning?", ["Tc-99m", "I-131", "F-18 (FDG)", "Co-60"], 2, "Fluorine-18."],
            ["'Quenching' is a phenomenon associated with:", ["CT tube cooling", "MRI Superconducting Magnet failure/shutdown", "Ultrasound crystal damping", "Automatic Processor"], 1, "Loss of superconductivity in MRI."],
            ["Contraindication for MRI includes:", ["Pregnancy (Relative)", "Cardiac Pacemaker (Non-compatible)", "Claustrophobia", "All of the above"], 3, "All are contraindications/cautions, but Pacemaker is absolute."],
            ["'Pitch' in Spiral CT is defined as:", ["Table travel per rotation / Beam width", "Beam width / Table travel", "kVp / mAs", "None"], 0, "Table movement / Beam collimation."],
            ["CT 'Beam Hardening' artifact appears as:", ["Streaks", "Rings", "Blurring", "Dots"], 0, "Dark streaks (cupping)."],
            ["'DICOM' is a standard for:", ["Medical Image Communication", "Hospital Billing", "Patient Registration", "Staff Rostering"], 0, "Digital Imaging and Communications in Medicine."],
            ["'PACS' stands for:", ["Patient Access Computer System", "Picture Archiving and Communication System", "Public Area Control System", "Phone And Call Service"], 1, "Picture Archiving and Communication System."],

            // 4. Contrast, Safety & Pathology (86-100)
            ["Which contrast media has the lowest osmolality?", ["Ionic Monomer", "Ionic Dimer", "Non-ionic Monomer", "Non-ionic Dimer (Iso-osmolar)"], 3, "Non-ionic Dimer (e.g., Visipaque) is iso-osmolar."],
            ["A severe reaction to contrast media includes:", ["Nausea", "Mild Urticaria", "Laryngeal Edema / Shock", "Metallic taste"], 2, "Laryngeal Edema."],
            ["'Metformin' should be discontinued before contrast study to prevent:", ["Hypoglycemia", "Lactic Acidosis", "Hyperglycemia", "Bleeding"], 1, "Lactic Acidosis."],
            ["'ALARA' stands for:", ["As Long As Radiation Allows", "As Low As Reasonably Achievable", "Always Leave Area Radioactive", "As Low As Regulations Allow"], 1, "As Low As Reasonably Achievable."],
            ["The annual dose limit for a radiation worker is:", ["5 mSv", "20 mSv", "50 mSv", "100 mSv"], 1, "20 mSv."],
            ["'Gonad Shielding' should be used when the gonads are within ___ cm of the primary beam.", ["2", "5", "10", "15"], 1, "5 cm."],
            ["'Stochastic' effects of radiation include:", ["Cataracts", "Skin Erythema", "Cancer / Genetic defects", "Sterility"], 2, "Cancer (No threshold)."],
            ["'Deterministic' effects have:", ["No threshold", "A threshold dose", "Probability proportional to dose", "No relationship to dose"], 1, "Threshold."],
            ["Lead apron thickness for fluoroscopy is usually:", ["0.25 mm Pb", "0.5 mm Pb", "1.0 mm Pb", "0.1 mm Pb"], 1, "0.5 mm Pb."],
            ["'Volvulus' refers to:", ["Telescoping of bowel", "Twisting of bowel", "Paralysis of bowel", "Herniation"], 1, "Twisting."],
            ["'Intussusception' appears on ultrasound as:", ["Target / Donut sign", "Comet tail", "Mirror image", "Shadowing"], 0, "Target sign."],
            ["'Bamboo Spine' is characteristic of:", ["Osteoporosis", "Ankylosing Spondylitis", "Scoliosis", "Multiple Myeloma"], 1, "Ankylosing Spondylitis."],
            ["'Apple Core' lesion in the colon indicates:", ["Diverticulitis", "Polyps", "Colon Cancer", "Volvulus"], 2, "Constricting carcinoma."],
            ["'Pneumoperitoneum' indicates:", ["Fluid in abdomen", "Free air in peritoneal cavity", "Blood in abdomen", "Infection"], 1, "Free air (perforation)."],
            ["'Greenstick Fracture' is common in:", ["Elderly", "Children", "Athletes", "Soldiers"], 1, "Children (Incomplete fracture)."]
        ];

        coreData.forEach((d, i) => questions.push(createQ(21 + i, "Core", d[0], d[1], d[2], d[3])));
    }

        // --- STATE MANAGEMENT ---
        let state = {
            currentQ: 0,
            answers: new Array(TOTAL_QUESTIONS).fill(null),
            status: new Array(TOTAL_QUESTIONS).fill('not-visited'),
            currentSection: 1,      // 1 to 5
            sectionTimeLeft: SECTION_TIME_LIMIT,
            maxSetReached: 1,       // Tracks highest section unlocked
            isFinished: false
        };

        const els = {
            landing: document.getElementById('landingPage'),
            header: document.getElementById('examHeader'),
            body: document.getElementById('examBody'),
            footer: document.getElementById('examFooter'),
            result: document.getElementById('resultPage'),
            qText: document.getElementById('questionText'),
            optsBox: document.getElementById('optionsBox'),
            qNum: document.getElementById('qNumDisplay'),
            sectionLabel: document.getElementById('sectionLabel'),
            palette: document.getElementById('questionPalette'),
            timer: document.getElementById('timerDisplay'),
            btnPrev: document.getElementById('btnPrev'),
            sidebar: document.getElementById('sidebar')
        };

        let timerInterval;

        function init() {
            generateQuestions(); // Load data
            // Persistence check could go here, but for strict timing, fresh start is safer
            els.landing.classList.remove('hidden');
            els.result.classList.add('hidden');
        }

        function startExam() {
            els.landing.classList.add('hidden');
            renderExamInterface();
            startSectionTimer();
        }

        function startSectionTimer() {
            if(timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                state.sectionTimeLeft--;
                
                // Format Time
                const m = Math.floor(state.sectionTimeLeft / 60);
                const s = state.sectionTimeLeft % 60;
                els.timer.innerText = `${m}:${s < 10 ? '0'+s : s}`;
                
                // Visual Warning
                if(state.sectionTimeLeft < 60) els.timer.style.backgroundColor = "#ffcdd2";
                else els.timer.style.backgroundColor = "#fff";

                // Time Up Logic
                if (state.sectionTimeLeft <= 0) {
                    handleSectionTimeout();
                }
            }, 1000);
        }

        function handleSectionTimeout() {
            clearInterval(timerInterval);
            
            if (state.currentSection < 5) {
                alert(`Time is up for Section ${state.currentSection}! Moving to Section ${state.currentSection + 1}.`);
                forceNextSection();
            } else {
                alert("Time is up for the final section! Submitting Exam.");
                finishExam();
            }
        }

        function forceNextSection() {
            state.currentSection++;
            state.maxSetReached = state.currentSection;
            state.sectionTimeLeft = SECTION_TIME_LIMIT;
            
            // Move to first question of next section
            const firstQofNextSection = (state.currentSection - 1) * SECTION_SIZE;
            loadQuestion(firstQofNextSection);
            startSectionTimer();
        }

        function renderExamInterface() {
            els.header.classList.remove('hidden');
            els.body.classList.remove('hidden');
            els.footer.classList.remove('hidden');
            renderPalette();
            loadQuestion(state.currentQ);
        }

        function loadQuestion(index) {
            state.currentQ = index;
            if(state.status[index] === 'not-visited') state.status[index] = 'not-answered';

            // Update Section Label
            const secNum = Math.floor(index / SECTION_SIZE) + 1;
            els.sectionLabel.innerText = `Section ${secNum} (Q${(secNum-1)*20 + 1}-${secNum*20})`;

            // Render Text
            els.qNum.innerText = `Question ${index + 1}`;
            els.qText.innerText = questions[index].text;
            
            // Render Options
            els.optsBox.innerHTML = '';
            questions[index].opts.forEach((opt, i) => {
                const isChecked = state.answers[index] === i ? 'checked' : '';
                els.optsBox.innerHTML += `
                    <label class="option-label">
                        <input type="radio" name="opt" value="${i}" ${isChecked} onchange="selectOption(${i})">
                        ${opt}
                    </label>
                `;
            });

            // Update Palette UI
            document.querySelectorAll('.q-btn').forEach(b => b.classList.remove('current'));
            const currentBtn = document.getElementById(`qbtn-${index}`);
            if(currentBtn) currentBtn.classList.add('current');

            // Handle Prev Button State (Cannot go back to previous locked section)
            const startOfCurrentSection = (state.currentSection - 1) * SECTION_SIZE;
            els.btnPrev.disabled = (index <= startOfCurrentSection);
        }

        function selectOption(optIndex) {
            state.answers[state.currentQ] = optIndex;
        }

        function saveAndNext() {
            const index = state.currentQ;
            // Update status
            state.status[index] = (state.answers[index] !== null) ? 'answered' : 'not-answered';
            
            moveToNextQuestion();
        }

        function markForReview() {
            const index = state.currentQ;
            state.status[index] = (state.answers[index] !== null) ? 'marked-answered' : 'review'; // Simplified
            moveToNextQuestion();
        }

        function clearResponse() {
            state.answers[state.currentQ] = null;
            state.status[state.currentQ] = 'not-answered';
            loadQuestion(state.currentQ);
            renderPalette();
        }

        function moveToNextQuestion() {
            const nextIndex = state.currentQ + 1;
            const currentSecBound = state.currentSection * SECTION_SIZE;

            // Check if next question crosses section boundary
            if (nextIndex >= currentSecBound) {
                // End of section reached
                if (state.currentSection < 5) {
                    if (confirm(`You have reached the end of Section ${state.currentSection}.\nDo you want to submit this section and move to Section ${state.currentSection+1}?\n\nWARNING: You cannot return to this section.`)) {
                        forceNextSection();
                    }
                } else {
                    if(confirm("This was the last question. Submit Exam?")) {
                        finishExam();
                    }
                }
            } else {
                // Normal movement within section
                renderPalette();
                loadQuestion(nextIndex);
            }
        }

        function prevQuestion() {
            // Logic handled in loadQuestion to disable button if at start of section
            if (state.currentQ > 0) {
                loadQuestion(state.currentQ - 1);
            }
        }

        function renderPalette() {
            els.palette.innerHTML = '';
            for (let i = 0; i < TOTAL_QUESTIONS; i++) {
                let statusClass = state.status[i];
                if(statusClass === 'marked-answered') statusClass = 'review';
                
                // Check if question belongs to a locked (previous) section
                // A question is locked if its section index is < current active section
                const qSection = Math.floor(i / SECTION_SIZE) + 1;
                const isLocked = qSection < state.currentSection;
                const lockedClass = isLocked ? ' locked' : '';
                
                // Gray out future sections
                const isFuture = qSection > state.currentSection;
                const futureStyle = isFuture ? 'opacity:0.3; pointer-events:none;' : '';

                els.palette.innerHTML += `
                    <div id="qbtn-${i}" 
                         class="q-btn ${statusClass}${lockedClass}" 
                         style="${futureStyle}"
                         onclick="jumpToQuestion(${i})">
                        ${i + 1}
                    </div>
                `;
            }
        }

        function jumpToQuestion(index) {
            const qSection = Math.floor(index / SECTION_SIZE) + 1;
            
            if (qSection < state.currentSection) {
                alert("This section is locked.");
                return;
            }
            if (qSection > state.currentSection) {
                alert("You cannot jump to a future section yet.");
                return;
            }
            
            loadQuestion(index);
        }

        function submitExam() {
            if(confirm("Are you sure you want to finish the exam? Unanswered questions in future sections will be marked zero.")) {
                finishExam();
            }
        }

        function finishExam() {
            clearInterval(timerInterval);
            state.isFinished = true;
            
            els.header.classList.add('hidden');
            els.body.classList.add('hidden');
            els.footer.classList.add('hidden');
            els.result.classList.remove('hidden');
            
            calculateResult();
        }

        function calculateResult() {
            let correct = 0, wrong = 0, unattempted = 0, score = 0;

            state.answers.forEach((ans, i) => {
                if (ans === null) {
                    unattempted++;
                } else if (questions[i] && ans === questions[i].ans) {
                    correct++;
                    score += 4;
                } else {
                    wrong++;
                    score -= 1;
                }
            });

            document.getElementById('scoreCard').innerHTML = `
                <h1 style="color:#3f51b5; font-size:3rem;">${score} / 400</h1>
                <p><strong>Correct:</strong> ${correct} (+${correct*4})</p>
                <p><strong>Incorrect:</strong> ${wrong} (-${wrong})</p>
                <p><strong>Unattempted:</strong> ${unattempted}</p>
            `;
        }

        function showDetailedReview() {
            const container = document.getElementById('detailedReview');
            container.style.display = 'block';
            container.innerHTML = '<h3>Detailed Solutions</h3>';
            
            questions.forEach((q, i) => {
                const userAns = state.answers[i];
                const isCorrect = userAns === q.ans;
                const statusColor = userAns === null ? 'gray' : (isCorrect ? 'green' : 'red');
                const statusText = userAns === null ? 'Skipped' : (isCorrect ? 'Correct' : 'Incorrect');

                let optsHtml = '';
                q.opts.forEach((opt, oi) => {
                    let style = '';
                    if (oi === q.ans) style = 'font-weight:bold; color:green;'; 
                    if (oi === userAns && !isCorrect) style = 'font-weight:bold; color:red;'; 
                    optsHtml += `<div style="${style}">${oi+1}. ${opt}</div>`;
                });

                container.innerHTML += `
                    <div class="review-item">
                        <div style="color:${statusColor}; font-weight:bold; margin-bottom:5px;">Q${i+1}: ${statusText}</div>
                        <div>${q.text}</div>
                        <div style="margin:10px 0; padding-left:15px; border-left:3px solid #ddd;">${optsHtml}</div>
                        <div class="explanation"><strong>Explanation:</strong> ${q.exp}</div>
                    </div>
                `;
            });
        }

        function toggleSidebar() {
            els.sidebar.classList.toggle('active');
        }

        // Initialize
        init();

    </script>
</body>
</html>
