<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIIMS CBT - Sectional Timing Mode</title>
    <style>
        :root {
            --header-bg: #3f51b5;
            --header-text: #fff;
            --panel-bg: #f5f5f5;
            --pallet-answered: #4caf50;
            --pallet-not-answered: #f44336;
            --pallet-review: #9c27b0;
            --pallet-not-visited: #e0e0e0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; }
        body { height: 100vh; display: flex; flex-direction: column; overflow: hidden; background: #fff; }

        /* --- Header --- */
        header {
            background: var(--header-bg); color: var(--header-text);
            padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
            height: 60px; flex-shrink: 0;
        }
        .timer { font-size: 1.2rem; font-weight: bold; background: #fff; color: #d32f2f; padding: 5px 15px; border-radius: 4px; border: 2px solid #d32f2f; }

        /* --- Main Layout --- */
        .main-container { display: flex; flex: 1; overflow: hidden; }
        
        .question-area { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; }
        .q-header { display: flex; justify-content: space-between; border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-bottom: 15px; }
        .q-text { font-size: 1.1rem; margin-bottom: 20px; line-height: 1.5; }
        
        .options-container { display: flex; flex-direction: column; gap: 10px; }
        .option-label { 
            display: flex; align-items: center; padding: 10px; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; transition: 0.2s; 
        }
        .option-label:hover { background: #f0f8ff; }
        .option-label input { margin-right: 15px; transform: scale(1.2); }

        /* Sidebar */
        .sidebar {
            width: 320px; background: var(--panel-bg); border-left: 1px solid #ccc;
            display: flex; flex-direction: column; flex-shrink: 0;
        }
        .user-info { padding: 10px; background: #e8eaf6; border-bottom: 1px solid #ccc; }
        
        .palette-legend { padding: 10px; font-size: 0.8rem; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; background: #fff; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }

        .question-grid { 
            padding: 10px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; 
            overflow-y: auto; flex: 1; align-content: start;
        }
        .q-btn {
            height: 35px; width: 35px; border: 1px solid #ccc; background: #fff; 
            border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
        }
        
        .q-btn.answered { background: var(--pallet-answered); color: white; border-color: var(--pallet-answered); }
        .q-btn.not-answered { background: var(--pallet-not-answered); color: white; border-color: var(--pallet-not-answered); }
        .q-btn.review { background: var(--pallet-review); color: white; border-radius: 50%; }
        .q-btn.current { border: 2px solid blue; box-shadow: 0 0 5px blue; }
        .q-btn.locked { opacity: 0.4; cursor: not-allowed; background: #444 !important; color: #888; border: 1px solid #000; }

        /* Footer */
        .footer-controls {
            height: 60px; background: #fff; border-top: 1px solid #ccc;
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
        }
        .btn { padding: 8px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.9rem; }
        .btn-primary { background: #2196f3; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-warn { background: #ff9800; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Mobile */
        .mobile-toggle { display: none; background: none; border: none; color: white; font-size: 1.5rem; }
        @media (max-width: 768px) {
            .mobile-toggle { display: block; }
            .sidebar { 
                position: absolute; right: 0; top: 60px; bottom: 60px; z-index: 100;
                transform: translateX(100%); transition: transform 0.3s; width: 85%;
            }
            .sidebar.active { transform: translateX(0); }
            .question-grid { grid-template-columns: repeat(6, 1fr); }
            .footer-controls { flex-wrap: wrap; gap: 5px; height: auto; padding: 10px; }
            .btn { flex: 1; padding: 8px; font-size: 0.8rem; }
        }

        /* Overlay */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .hidden { display: none !important; }
        
        .review-panel { display: none; padding: 20px; height: 100%; overflow-y: auto; background:#f9f9f9;}
        .review-item { margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 5px; background:white; }
        .explanation { background: #fff3cd; padding: 10px; margin-top: 10px; font-size: 0.9rem; border-left: 4px solid #ffc107; }

    </style>
</head>
<body>

    <div id="landingPage" class="overlay">
        <h1>AIIMS CRE CBT (Strict Pattern)</h1>
        <div style="width: 80%; max-width: 600px; text-align: left; margin: 20px 0;">
            <h3>Exam Rules:</h3>
            <ul>
                <li><strong>Questions:</strong> 100 (5 Sections of 20 questions each).</li>
                <li><strong>Timing:</strong> 18 Minutes per section (Strictly Dedicated).</li>
                <li><strong>Total Time:</strong> 90 Minutes.</li>
                <li><strong>Locking:</strong> Once 18 mins are up, or if you manually proceed to the next section, you <u>cannot</u> return to the previous section.</li>
                <li><strong>Marking:</strong> +4 Correct, -1 Incorrect.</li>
            </ul>
        </div>
        <button class="btn btn-success" style="font-size: 1.2rem;" onclick="startExam()">START EXAM</button>
    </div>

    <header id="examHeader" class="hidden">
        <div style="display:flex; align-items:center; gap:10px;">
            <h3>AIIMS Radiographer</h3>
            <span style="font-size:0.8rem; background:#eee; padding:2px 6px; border-radius:4px; color:#333;" id="sectionLabel">Section 1</span>
        </div>
        <div class="timer" id="timerDisplay">18:00</div>
        <button class="mobile-toggle" onclick="toggleSidebar()">â˜°</button>
    </header>

    <div class="main-container hidden" id="examBody">
        <div class="question-area">
            <div class="q-header">
                <span id="qNumDisplay">Question No. 1</span>
                <span style="color: #666;">Marks: +4, -1</span>
            </div>
            <div id="questionText" class="q-text">Loading...</div>
            <div id="optionsBox" class="options-container"></div>
        </div>

        <div class="sidebar" id="sidebar">
            <div class="user-info">
                <strong>Candidate Name</strong><br><small>Roll No: 123456</small>
            </div>
            <div class="palette-legend">
                <div class="legend-item"><span class="dot" style="background:var(--pallet-answered)"></span> Ans</div>
                <div class="legend-item"><span class="dot" style="background:var(--pallet-not-answered)"></span> Not Ans</div>
                <div class="legend-item"><span class="dot" style="background:var(--pallet-review)"></span> Review</div>
                <div class="legend-item"><span class="dot" style="background:#444"></span> Locked</div>
            </div>
            <div class="question-grid" id="questionPalette"></div>
            <div style="padding:10px; margin-top:auto;">
                <button class="btn btn-primary" style="width:100%" onclick="submitExam()">FINISH EXAM</button>
            </div>
        </div>
    </div>

    <div class="footer-controls hidden" id="examFooter">
        <div style="display:flex; gap:10px;">
            <button class="btn btn-danger" onclick="clearResponse()">Clear</button>
            <button class="btn btn-warn" onclick="markForReview()">Review</button>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn" onclick="prevQuestion()" id="btnPrev">Previous</button>
            <button class="btn btn-success" onclick="saveAndNext()">Save & Next</button>
        </div>
    </div>

    <div id="resultPage" class="overlay hidden" style="display:block; overflow-y:auto; justify-content:start; padding-top:40px;">
        <h2 style="text-align:center;">Exam Summary</h2>
        <div id="scoreCard" style="margin: 20px auto; width:90%; max-width:600px; padding: 20px; border: 1px solid #ccc; text-align: center; background:#fff;"></div>
        <div style="display:flex; justify-content:center; gap:20px; margin-bottom:20px;">
            <button class="btn btn-primary" onclick="showDetailedReview()">Review Solutions</button>
            <button class="btn btn-danger" onclick="location.reload()">Exit</button>
        </div>
        <div id="detailedReview" class="review-panel" style="width: 90%; max-width: 800px; margin:0 auto;"></div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const TOTAL_QUESTIONS = 100;
        const SECTION_SIZE = 20; // 20 questions per section
        const SECTION_TIME_LIMIT = 18 * 60; // 18 minutes in seconds
        
        let questions = [];

        function generateQuestions() {
        const createQ = (id, type, text, opts, ans, exp) => ({ id, type, text, opts, ans, exp });
        questions = []; // Reset array

        // --- SECTION A: NON-CORE (1-20) ---
        // Topics: Reasoning, GK, English, Computer (AIIMS General Section Pattern)

        const nonCoreData = [
            // Reasoning & Math
            ["Which number replaces the question mark? 2, 5, 11, 23, 47, ?", ["95", "90", "85", "100"], 0, "Pattern is x2 + 1. (47*2)+1 = 95."],
            ["If SOUTH is coded as 56328 and NORTH is 16728, how is SOUTH-NORTH coded?", ["56328-16728", "56328-16278", "Different logic", "None"], 0, "Direct letter to number mapping."],
            ["A train running at 54 km/hr crosses a pole in 20 seconds. What is the length of the train?", ["300 m", "150 m", "200 m", "540 m"], 0, "Speed in m/s = 54*(5/18) = 15 m/s. Distance = Speed * Time = 15 * 20 = 300 m."],
            ["Odd one out: Square, Circle, Rectangle, Triangle.", ["Circle", "Square", "Rectangle", "Triangle"], 0, "Circle has no straight lines/corners."],
            ["Pointing to a photograph, a man said, 'I have no brother or sister but that man's father is my father's son.' Whose photograph was it?", ["His own", "His son's", "His father's", "His nephew's"], 1, "'My father's son' (with no siblings) is the speaker himself. So, 'that man's father is ME'. The photo is of his son."],

            // GK & Current Affairs
            ["Which vitamin is essential for blood clotting?", ["Vitamin A", "Vitamin K", "Vitamin C", "Vitamin D"], 1, "Vitamin K."],
            ["'Satyameva Jayate' is inscribed on the Indian emblem in which script?", ["Devanagari", "Brahmi", "Sanskrit", "Pali"], 0, "Devanagari script."],
            ["The 'Tejas' is a:", ["Submarine", "Light Combat Aircraft (LCA)", "Tank", "Missile"], 1, "Indian indigenous Light Combat Aircraft."],
            ["Which city is known as the 'Manchester of South India'?", ["Coimbatore", "Chennai", "Madurai", "Bengaluru"], 0, "Coimbatore (Textile industry)."],
            ["Who won the 2024 Wimbledon Men's Singles title?", ["Carlos Alcaraz", "Novak Djokovic", "Rafael Nadal", "Roger Federer"], 0, "Carlos Alcaraz."],

            // English
            ["Synonym of 'Obsolete':", ["Modern", "Outdated", "New", "Fresh"], 1, "Outdated."],
            ["Antonym of 'Genuine':", ["Real", "Fake", "Authentic", "Pure"], 1, "Fake."],
            ["One word substitution: 'Fear of closed spaces':", ["Claustrophobia", "Acrophobia", "Agoraphobia", "Hydrophobia"], 0, "Claustrophobia."],
            ["Find the error: 'One of the student was absent.'", ["One of", "the student", "was", "absent"], 1, "Should be 'One of the students' (Plural)."],
            ["Correct spelling:", ["Pneumonia", "Neumonia", "Pnumonia", "Newmonia"], 0, "Pneumonia."],

            // Computer Basics
            ["'CPU' consists of:", ["ALU + CU", "RAM + ROM", "Hard Disk + Monitor", "Input + Output"], 0, "Arithmetic Logic Unit + Control Unit."],
            ["Which shortcut creates a 'New Folder' in Windows?", ["Ctrl + Shift + N", "Ctrl + N", "Alt + N", "Ctrl + Alt + N"], 0, "Ctrl + Shift + N."],
            ["'www' stands for:", ["World Wide Web", "World Web Wide", "Wide World Web", "Web World Wide"], 0, "World Wide Web."],
            ["1 Kilobyte (KB) is equal to:", ["1000 Bytes", "1024 Bytes", "1024 Bits", "8 Bytes"], 1, "1024 Bytes."],
            ["Which key is used to rename a file?", ["F2", "F4", "F5", "F12"], 0, "F2."]
        ];
        nonCoreData.forEach((d, i) => questions.push(createQ(i + 1, "Non-Core", d[0], d[1], d[2], d[3])));

        // --- SECTION B: CORE (21-100) ---
        
        const coreData = [
            // 1. Physics & X-Ray Generation (21-35)
            ["The efficiency of X-ray production is approximately:", ["1%", "50%", "90%", "99%"], 0, "<1% is X-ray, >99% is Heat."],
            ["Which target material is used in Mammography tubes?", ["Tungsten", "Molybdenum", "Copper", "Aluminum"], 1, "Molybdenum (or Rhodium) for characteristic X-rays at 17-20 keV."],
            ["The 'Line Focus Principle' is used to:", ["Reduce effective focal spot size", "Increase effective focal spot", "Reduce heat", "Increase patient dose"], 0, "Small effective spot for detail, large actual spot for heat."],
            ["'Space Charge Effect' limits the:", ["kVp", "mA", "Time", "Focal spot"], 1, "Limits the maximum mA (tube current) at low kVp."],
            ["High Frequency generators produce voltage ripple of:", ["< 1%", "13%", "100%", "50%"], 0, "Less than 1% (Near constant potential)."],
            ["The binding energy of Tungsten K-shell is:", ["69.5 keV", "33 keV", "12 keV", "100 keV"], 0, "69.5 keV."],
            ["Which interaction dominates in diagnostic radiology (Patient Dose)?", ["Photoelectric Effect", "Compton Scatter", "Coherent Scatter", "Pair Production"], 0, "Photoelectric effect (Total absorption) causes the most dose."],
            ["Which interaction is responsible for Occupational Dose (Scatter)?", ["Photoelectric", "Compton Scatter", "Pair Production", "Photodisintegration"], 1, "Compton scatter from the patient."],
            ["To double the optical density, mAs should be:", ["Doubled", "Halved", "Increased by 15%", "Squared"], 0, "Density is directly proportional to mAs."],
            ["The '15% Rule' states that increasing kVp by 15% is equivalent to:", ["Doubling the mAs", "Halving the mAs", "Doubling distance", "None"], 0, "Doubling mAs."],
            ["'Heel Effect' is more pronounced with:", ["Small Anode Angle", "Large Anode Angle", "Long SID", "Small Film Size"], 0, "Small angle + Short SID + Large field."],
            ["Total filtration in a general X-ray tube (operating >70 kVp) must be:", ["0.5 mm Al", "1.5 mm Al", "2.5 mm Al", "4.0 mm Al"], 2, "2.5 mm Aluminum equivalent."],
            ["Grid Ratio is calculated as:", ["Height / Distance between strips", "Distance / Height", "Height x Width", "Lines per inch"], 0, "H/D."],
            ["Air Gap technique is an alternative to using:", ["Screens", "Grids", "Filters", "Collimators"], 1, "Reduces scatter reaching the film."],
            ["'Quantum Mottle' (Noise) is caused by:", ["High mAs", "Insufficient photons (Low mAs)", "High kVp", "Slow speed screens"], 1, "Photon starvation."],

            // 2. Anatomy & Positioning (36-55)
            ["'Waters View' demonstrates:", ["Maxillary Sinuses", "Frontal Sinuses", "Sphenoid", "Ethmoid"], 0, "Maxillary sinuses clear of petrous ridges."],
            ["'Townes View' (30 deg caudal) visualizes:", ["Occipital bone / Foramen Magnum", "Frontal bone", "Mandible", "Zygoma"], 0, "Dorsum sellae and Foramen Magnum."],
            ["'Swimmers View' is used for:", ["C1-C2", "C7-T1 Junction", "L5-S1", "SI Joints"], 1, "Cervico-thoracic junction."],
            ["For 'Lateral Knee', the central ray is directed:", ["5-7 degrees cephalad", "5-7 degrees caudad", "Perpendicular", "Variable"], 0, "5-7 deg cephalad to superimpose condyles."],
            ["'Skyline View' (Merchant/Sunrise) is for:", ["Patella", "Calcaneus", "Shoulder", "Skull"], 0, "Patello-femoral joint space."],
            ["'Y-View' of the shoulder is used to diagnose:", ["Dislocation", "Fracture of Clavicle", "AC Joint separation", "Rotator cuff"], 0, "Anterior/Posterior Dislocation."],
            ["The 'Scaphoid' is best seen in:", ["PA with Ulnar Deviation", "PA with Radial Deviation", "Lateral", "AP Oblique"], 0, "Ulnar deviation."],
            ["'Judet Views' are used for:", ["Acetabulum", "Sacrum", "Ilium", "Pubis"], 0, "Acetabular fractures (Oblique pelvis)."],
            ["To demonstrate 'Pleural Effusion' in a patient who cannot stand, use:", ["Lateral Decubitus (Affected side down)", "Lateral Decubitus (Affected side up)", "Supine", "Prone"], 0, "Fluid sinks; affected side down."],
            ["To demonstrate 'Pneumothorax' (Air) in decubitus, use:", ["Affected side UP", "Affected side DOWN", "Supine", "Prone"], 0, "Air rises; affected side UP."],
            ["Which carpal bone articulates with the thumb?", ["Trapezium", "Trapezoid", "Scaphoid", "Capitate"], 0, "Trapezium."],
            ["The 'Olecranon Fossa' is located on the:", ["Humerus (Posterior)", "Ulna", "Radius", "Scapula"], 0, "Posterior distal humerus."],
            ["The 'Sella Turcica' is part of which bone?", ["Sphenoid", "Ethmoid", "Temporal", "Frontal"], 0, "Sphenoid bone."],
            ["'Mastoid Air Cells' are part of:", ["Temporal Bone", "Occipital Bone", "Parietal Bone", "Frontal Bone"], 0, "Temporal Bone."],
            ["Which foramen transmits the Spinal Cord?", ["Foramen Magnum", "Foramen Ovale", "Foramen Rotundum", "Obturator Foramen"], 0, "Foramen Magnum."],
            ["The 'Xiphoid Process' is at the level of:", ["T9-T10", "T7", "L1", "C7"], 0, "T9-T10."],
            ["Stomach 'Fundus' is usually filled with gas in which position?", ["Erect", "Supine", "Prone", "Trendelenburg"], 0, "Gas rises to fundus in erect position."],
            ["'McBurney's Point' is related to:", ["Appendix", "Gallbladder", "Kidney", "Spleen"], 0, "Appendicitis."],
            ["Which kidney is typically lower?", ["Right", "Left", "Both same", "Variable"], 0, "Right (displaced by liver)."],
            ["The 'Common Bile Duct' opens into:", ["Stomach", "Duodenum (2nd part)", "Jejunum", "Ileum"], 1, "Ampulla of Vater in Duodenum."],

            // 3. CT & Digital Radiography (56-70)
            ["'Hounsfield Unit' (HU) for Water is:", ["0", "-1000", "+1000", "+50"], 0, "0 HU."],
            ["HU for Air is:", ["-1000", "0", "-100", "+100"], 0, "-1000 HU."],
            ["HU for Dense Bone is approx:", ["+1000", "+100", "0", "-50"], 0, "+1000 or more."],
            ["'Window Width' controls image:", ["Contrast", "Brightness", "Resolution", "Size"], 0, "Contrast (Gray scale)."],
            ["'Window Level' controls image:", ["Brightness", "Contrast", "Detail", "Noise"], 0, "Brightness (Center point)."],
            ["'Pixel' size is calculated as:", ["FOV / Matrix size", "Matrix / FOV", "FOV x Matrix", "None"], 0, "Field of View divided by Matrix."],
            ["Which generation CT used a 'Translate-Rotate' motion?", ["1st and 2nd", "3rd", "4th", "Helical"], 0, "1st (Pencil beam) and 2nd (Fan beam)."],
            ["Slip-ring technology enabled:", ["Helical/Spiral CT", "4th Gen CT", "1st Gen CT", "Dual Energy"], 0, "Continuous rotation without cables."],
            ["'Pitch' > 1 indicates:", ["Table moves faster than beam width (Gaps)", "Overlap", "High dose", "Slow scan"], 0, "Undersampling, gaps in helix, lower dose."],
            ["'Beam Hardening' artifact appears as:", ["Dark streaks / Cupping", "Rings", "Blurring", "Steps"], 0, "Dark bands between dense objects."],
            ["'Partial Volume Averaging' occurs when:", ["Tissue is smaller than slice thickness", "Patient moves", "Metal is present", "kVp is low"], 0, "Multiple tissues averaged into one voxel."],
            ["In DR, 'DQE' stands for:", ["Detective Quantum Efficiency", "Digital Quality Energy", "Direct Quantum Effect", "None"], 0, "Measure of efficiency in converting X-rays to image."],
            ["PSP plates (CR) are erased by:", ["Bright White Light", "Red Laser", "Heat", "Chemicals"], 0, "Intense white light."],
            ["'Windowing' is a:", ["Post-processing technique", "Pre-processing", "Hardware feature", "Scanning mode"], 0, "Changing display settings after scanning."],
            ["DICOM is a standard for:", ["Image storage and communication", "Billing", "Staff scheduling", "Report typing"], 0, "Digital Imaging and Communications in Medicine."],

            // 4. MRI Physics & Sequences (71-85)
            ["T1 Relaxation is also called:", ["Spin-Lattice", "Spin-Spin", "Free Induction Decay", "Echo Time"], 0, "Spin-Lattice recovery."],
            ["T2 Relaxation is also called:", ["Spin-Spin", "Spin-Lattice", "Inversion", "Saturation"], 0, "Spin-Spin decay."],
            ["On T1 weighted images, Fluid (CSF/Water) appears:", ["Dark (Hypointense)", "Bright (Hyperintense)", "Grey", "Mixed"], 0, "Fluid is dark on T1."],
            ["On T2 weighted images, Fluid appears:", ["Bright", "Dark", "Grey", "Black"], 0, "Fluid is bright on T2."],
            ["'TR' stands for:", ["Repetition Time", "Relaxation Time", "Read Time", "Radio Time"], 0, "Time between RF pulses."],
            ["'TE' stands for:", ["Echo Time", "Excite Time", "End Time", "Energy Time"], 0, "Time until echo is read."],
            ["'STIR' sequence is used to:", ["Suppress Fat", "Suppress Fluid", "Enhance Flow", "Map diffusion"], 0, "Short Tau Inversion Recovery (Fat suppression)."],
            ["'FLAIR' sequence is used to:", ["Suppress CSF (Fluid)", "Suppress Fat", "Visualize Arteries", "None"], 0, "Fluid Attenuated Inversion Recovery (Dark CSF)."],
            ["Gadolinium contrast shortens:", ["T1 time (Bright on T1)", "T2 time", "Proton density", "TR"], 0, "Positive contrast -> Bright on T1."],
            ["'DWI' (Diffusion Weighted Imaging) is most useful for:", ["Acute Stroke (Infarct)", "Tumor sizing", "Bone fracture", "Bleed"], 0, "Restricted diffusion in cytotoxic edema."],
            ["'Time of Flight' (TOF) is used for:", ["MRA (Angiography)", "fMRI", "Spectroscopy", "Fat suppression"], 0, "Flow imaging without contrast."],
            ["'Quench' refers to:", ["Rapid loss of superconductivity (Helium boil-off)", "Stopping scan", "Patient panic", "Power failure"], 0, "Emergency magnet shutdown."],
            ["Safety Zone IV in MRI is:", ["The Magnet Room", "Console Room", "Waiting Area", "Reception"], 0, "Strictly restricted magnet room."],
            ["Contraindication for MRI:", ["Cardiac Pacemaker (Non-compatible)", "Dental filling", "Hip replacement (Titanium)", "Stent (>6 weeks)"], 0, "Pacemakers are the classic absolute contraindication."],
            ["'Larmor Frequency' depends on:", ["Magnetic Field Strength (Bo)", "Temperature", "Patient weight", "Time of day"], 0, "Proportional to Tesla strength."],

            // 5. Procedures, Contrast & Safety (86-100)
            ["'Double Contrast' study uses:", ["Barium + Air", "Barium + Iodine", "Iodine + Air", "Water + Milk"], 0, "Positive (Ba) + Negative (Air)."],
            ["'Enteroclysis' examines the:", ["Small Bowel", "Large Bowel", "Stomach", "Esophagus"], 0, "Small intestine via nasojejunal tube."],
            ["'RGU' (Retrograde Urethrogram) is best for:", ["Urethral Strictures", "Kidney Stones", "Bladder Tumor", "Ureter"], 0, "Anterior urethra visualization."],
            ["'MCU' (Micturating Cystourethrogram) is best for:", ["Vesicoureteral Reflux (VUR)", "Kidney Mass", "Stone", "Stricture"], 0, "Reflux during voiding."],
            ["Contraindication for Barium Enema:", ["Suspected Perforation", "Constipation", "Polyps", "Colitis"], 0, "Risk of Barium Peritonitis."],
            ["Which contrast is safe if perforation is suspected?", ["Water soluble (Gastrografin/Iodine)", "Barium", "Air", "Oil"], 0, "Absorbable by peritoneum."],
            ["'Myelography' contrast is injected into:", ["Subarachnoid Space", "Epidural", "Subdural", "Disk"], 0, "CSF space (L3-L4)."],
            ["Annual whole body dose limit for radiation workers:", ["20 mSv", "50 mSv", "5 mSv", "1 mSv"], 0, "20 mSv (averaged over 5 yrs)."],
            ["Dose limit for pregnant radiation worker:", ["1 mSv (surface of abdomen)", "20 mSv", "5 mSv", "10 mSv"], 0, "1 mSv for the term."],
            ["'ALARA' stands for:", ["As Low As Reasonably Achievable", "As Long As Radiation Allows", "Always Leave Area", "None"], 0, "Safety principle."],
            ["Lead apron thickness for fluoroscopy (standard):", ["0.5 mm Pb", "0.25 mm Pb", "1.0 mm Pb", "0.1 mm Pb"], 0, "0.5 mm is standard."],
            ["TLD Badge material (India):", ["CaSO4:Dy", "LiF", "AgBr", "NaI"], 0, "Calcium Sulfate Dysprosium."],
            ["'Stochastic' effects (Cancer) have:", ["No Threshold", "Threshold", "Severity dose-dependent", "Immediate effect"], 0, "Probability is dose dependent, no safe level."],
            ["'Deterministic' effects (Cataract, Skin burn) have:", ["Threshold", "No Threshold", "Random chance", "Genetic link"], 0, "Severity increases above a threshold."],
            ["Best material for shielding gamma/x-rays:", ["Lead / Concrete", "Wood", "Plastic", "Glass"], 0, "High Z and density."]
        ];

        coreData.forEach((d, i) => questions.push(createQ(21 + i, "Core", d[0], d[1], d[2], d[3])));
    }

        // --- STATE MANAGEMENT ---
        let state = {
            currentQ: 0,
            answers: new Array(TOTAL_QUESTIONS).fill(null),
            status: new Array(TOTAL_QUESTIONS).fill('not-visited'),
            currentSection: 1,      // 1 to 5
            sectionTimeLeft: SECTION_TIME_LIMIT,
            maxSetReached: 1,       // Tracks highest section unlocked
            isFinished: false
        };

        const els = {
            landing: document.getElementById('landingPage'),
            header: document.getElementById('examHeader'),
            body: document.getElementById('examBody'),
            footer: document.getElementById('examFooter'),
            result: document.getElementById('resultPage'),
            qText: document.getElementById('questionText'),
            optsBox: document.getElementById('optionsBox'),
            qNum: document.getElementById('qNumDisplay'),
            sectionLabel: document.getElementById('sectionLabel'),
            palette: document.getElementById('questionPalette'),
            timer: document.getElementById('timerDisplay'),
            btnPrev: document.getElementById('btnPrev'),
            sidebar: document.getElementById('sidebar')
        };

        let timerInterval;

        function init() {
            generateQuestions(); // Load data
            // Persistence check could go here, but for strict timing, fresh start is safer
            els.landing.classList.remove('hidden');
            els.result.classList.add('hidden');
        }

        function startExam() {
            els.landing.classList.add('hidden');
            renderExamInterface();
            startSectionTimer();
        }

        function startSectionTimer() {
            if(timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                state.sectionTimeLeft--;
                
                // Format Time
                const m = Math.floor(state.sectionTimeLeft / 60);
                const s = state.sectionTimeLeft % 60;
                els.timer.innerText = `${m}:${s < 10 ? '0'+s : s}`;
                
                // Visual Warning
                if(state.sectionTimeLeft < 60) els.timer.style.backgroundColor = "#ffcdd2";
                else els.timer.style.backgroundColor = "#fff";

                // Time Up Logic
                if (state.sectionTimeLeft <= 0) {
                    handleSectionTimeout();
                }
            }, 1000);
        }

        function handleSectionTimeout() {
            clearInterval(timerInterval);
            
            if (state.currentSection < 5) {
                alert(`Time is up for Section ${state.currentSection}! Moving to Section ${state.currentSection + 1}.`);
                forceNextSection();
            } else {
                alert("Time is up for the final section! Submitting Exam.");
                finishExam();
            }
        }

        function forceNextSection() {
            state.currentSection++;
            state.maxSetReached = state.currentSection;
            state.sectionTimeLeft = SECTION_TIME_LIMIT;
            
            // Move to first question of next section
            const firstQofNextSection = (state.currentSection - 1) * SECTION_SIZE;
            loadQuestion(firstQofNextSection);
            startSectionTimer();
        }

        function renderExamInterface() {
            els.header.classList.remove('hidden');
            els.body.classList.remove('hidden');
            els.footer.classList.remove('hidden');
            renderPalette();
            loadQuestion(state.currentQ);
        }

        function loadQuestion(index) {
            state.currentQ = index;
            if(state.status[index] === 'not-visited') state.status[index] = 'not-answered';

            // Update Section Label
            const secNum = Math.floor(index / SECTION_SIZE) + 1;
            els.sectionLabel.innerText = `Section ${secNum} (Q${(secNum-1)*20 + 1}-${secNum*20})`;

            // Render Text
            els.qNum.innerText = `Question ${index + 1}`;
            els.qText.innerText = questions[index].text;
            
            // Render Options
            els.optsBox.innerHTML = '';
            questions[index].opts.forEach((opt, i) => {
                const isChecked = state.answers[index] === i ? 'checked' : '';
                els.optsBox.innerHTML += `
                    <label class="option-label">
                        <input type="radio" name="opt" value="${i}" ${isChecked} onchange="selectOption(${i})">
                        ${opt}
                    </label>
                `;
            });

            // Update Palette UI
            document.querySelectorAll('.q-btn').forEach(b => b.classList.remove('current'));
            const currentBtn = document.getElementById(`qbtn-${index}`);
            if(currentBtn) currentBtn.classList.add('current');

            // Handle Prev Button State (Cannot go back to previous locked section)
            const startOfCurrentSection = (state.currentSection - 1) * SECTION_SIZE;
            els.btnPrev.disabled = (index <= startOfCurrentSection);
        }

        function selectOption(optIndex) {
            state.answers[state.currentQ] = optIndex;
        }

        function saveAndNext() {
            const index = state.currentQ;
            // Update status
            state.status[index] = (state.answers[index] !== null) ? 'answered' : 'not-answered';
            
            moveToNextQuestion();
        }

        function markForReview() {
            const index = state.currentQ;
            state.status[index] = (state.answers[index] !== null) ? 'marked-answered' : 'review'; // Simplified
            moveToNextQuestion();
        }

        function clearResponse() {
            state.answers[state.currentQ] = null;
            state.status[state.currentQ] = 'not-answered';
            loadQuestion(state.currentQ);
            renderPalette();
        }

        function moveToNextQuestion() {
            const nextIndex = state.currentQ + 1;
            const currentSecBound = state.currentSection * SECTION_SIZE;

            // Check if next question crosses section boundary
            if (nextIndex >= currentSecBound) {
                // End of section reached
                if (state.currentSection < 5) {
                    if (confirm(`You have reached the end of Section ${state.currentSection}.\nDo you want to submit this section and move to Section ${state.currentSection+1}?\n\nWARNING: You cannot return to this section.`)) {
                        forceNextSection();
                    }
                } else {
                    if(confirm("This was the last question. Submit Exam?")) {
                        finishExam();
                    }
                }
            } else {
                // Normal movement within section
                renderPalette();
                loadQuestion(nextIndex);
            }
        }

        function prevQuestion() {
            // Logic handled in loadQuestion to disable button if at start of section
            if (state.currentQ > 0) {
                loadQuestion(state.currentQ - 1);
            }
        }

        function renderPalette() {
            els.palette.innerHTML = '';
            for (let i = 0; i < TOTAL_QUESTIONS; i++) {
                let statusClass = state.status[i];
                if(statusClass === 'marked-answered') statusClass = 'review';
                
                // Check if question belongs to a locked (previous) section
                // A question is locked if its section index is < current active section
                const qSection = Math.floor(i / SECTION_SIZE) + 1;
                const isLocked = qSection < state.currentSection;
                const lockedClass = isLocked ? ' locked' : '';
                
                // Gray out future sections
                const isFuture = qSection > state.currentSection;
                const futureStyle = isFuture ? 'opacity:0.3; pointer-events:none;' : '';

                els.palette.innerHTML += `
                    <div id="qbtn-${i}" 
                         class="q-btn ${statusClass}${lockedClass}" 
                         style="${futureStyle}"
                         onclick="jumpToQuestion(${i})">
                        ${i + 1}
                    </div>
                `;
            }
        }

        function jumpToQuestion(index) {
            const qSection = Math.floor(index / SECTION_SIZE) + 1;
            
            if (qSection < state.currentSection) {
                alert("This section is locked.");
                return;
            }
            if (qSection > state.currentSection) {
                alert("You cannot jump to a future section yet.");
                return;
            }
            
            loadQuestion(index);
        }

        function submitExam() {
            if(confirm("Are you sure you want to finish the exam? Unanswered questions in future sections will be marked zero.")) {
                finishExam();
            }
        }

        function finishExam() {
            clearInterval(timerInterval);
            state.isFinished = true;
            
            els.header.classList.add('hidden');
            els.body.classList.add('hidden');
            els.footer.classList.add('hidden');
            els.result.classList.remove('hidden');
            
            calculateResult();
        }

        function calculateResult() {
            let correct = 0, wrong = 0, unattempted = 0, score = 0;

            state.answers.forEach((ans, i) => {
                if (ans === null) {
                    unattempted++;
                } else if (questions[i] && ans === questions[i].ans) {
                    correct++;
                    score += 4;
                } else {
                    wrong++;
                    score -= 1;
                }
            });

            document.getElementById('scoreCard').innerHTML = `
                <h1 style="color:#3f51b5; font-size:3rem;">${score} / 400</h1>
                <p><strong>Correct:</strong> ${correct} (+${correct*4})</p>
                <p><strong>Incorrect:</strong> ${wrong} (-${wrong})</p>
                <p><strong>Unattempted:</strong> ${unattempted}</p>
            `;
        }

        function showDetailedReview() {
            const container = document.getElementById('detailedReview');
            container.style.display = 'block';
            container.innerHTML = '<h3>Detailed Solutions</h3>';
            
            questions.forEach((q, i) => {
                const userAns = state.answers[i];
                const isCorrect = userAns === q.ans;
                const statusColor = userAns === null ? 'gray' : (isCorrect ? 'green' : 'red');
                const statusText = userAns === null ? 'Skipped' : (isCorrect ? 'Correct' : 'Incorrect');

                let optsHtml = '';
                q.opts.forEach((opt, oi) => {
                    let style = '';
                    if (oi === q.ans) style = 'font-weight:bold; color:green;'; 
                    if (oi === userAns && !isCorrect) style = 'font-weight:bold; color:red;'; 
                    optsHtml += `<div style="${style}">${oi+1}. ${opt}</div>`;
                });

                container.innerHTML += `
                    <div class="review-item">
                        <div style="color:${statusColor}; font-weight:bold; margin-bottom:5px;">Q${i+1}: ${statusText}</div>
                        <div>${q.text}</div>
                        <div style="margin:10px 0; padding-left:15px; border-left:3px solid #ddd;">${optsHtml}</div>
                        <div class="explanation"><strong>Explanation:</strong> ${q.exp}</div>
                    </div>
                `;
            });
        }

        function toggleSidebar() {
            els.sidebar.classList.toggle('active');
        }

        // Initialize
        init();

    </script>
</body>
</html>
