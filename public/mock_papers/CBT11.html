<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIIMS CBT - Sectional Timing Mode</title>
    <style>
        :root {
            --header-bg: #3f51b5;
            --header-text: #fff;
            --panel-bg: #f5f5f5;
            --pallet-answered: #4caf50;
            --pallet-not-answered: #f44336;
            --pallet-review: #9c27b0;
            --pallet-not-visited: #e0e0e0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; }
        body { height: 100vh; display: flex; flex-direction: column; overflow: hidden; background: #fff; }

        /* --- Header --- */
        header {
            background: var(--header-bg); color: var(--header-text);
            padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
            height: 60px; flex-shrink: 0;
        }
        .timer { font-size: 1.2rem; font-weight: bold; background: #fff; color: #d32f2f; padding: 5px 15px; border-radius: 4px; border: 2px solid #d32f2f; }

        /* --- Main Layout --- */
        .main-container { display: flex; flex: 1; overflow: hidden; }
        
        .question-area { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; }
        .q-header { display: flex; justify-content: space-between; border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-bottom: 15px; }
        .q-text { font-size: 1.1rem; margin-bottom: 20px; line-height: 1.5; }
        
        .options-container { display: flex; flex-direction: column; gap: 10px; }
        .option-label { 
            display: flex; align-items: center; padding: 10px; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; transition: 0.2s; 
        }
        .option-label:hover { background: #f0f8ff; }
        .option-label input { margin-right: 15px; transform: scale(1.2); }

        /* Sidebar */
        .sidebar {
            width: 320px; background: var(--panel-bg); border-left: 1px solid #ccc;
            display: flex; flex-direction: column; flex-shrink: 0;
        }
        .user-info { padding: 10px; background: #e8eaf6; border-bottom: 1px solid #ccc; }
        
        .palette-legend { padding: 10px; font-size: 0.8rem; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; background: #fff; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }

        .question-grid { 
            padding: 10px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; 
            overflow-y: auto; flex: 1; align-content: start;
        }
        .q-btn {
            height: 35px; width: 35px; border: 1px solid #ccc; background: #fff; 
            border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
        }
        
        .q-btn.answered { background: var(--pallet-answered); color: white; border-color: var(--pallet-answered); }
        .q-btn.not-answered { background: var(--pallet-not-answered); color: white; border-color: var(--pallet-not-answered); }
        .q-btn.review { background: var(--pallet-review); color: white; border-radius: 50%; }
        .q-btn.current { border: 2px solid blue; box-shadow: 0 0 5px blue; }
        .q-btn.locked { opacity: 0.4; cursor: not-allowed; background: #444 !important; color: #888; border: 1px solid #000; }

        /* Footer */
        .footer-controls {
            height: 60px; background: #fff; border-top: 1px solid #ccc;
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
        }
        .btn { padding: 8px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.9rem; }
        .btn-primary { background: #2196f3; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-warn { background: #ff9800; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Mobile */
        .mobile-toggle { display: none; background: none; border: none; color: white; font-size: 1.5rem; }
        @media (max-width: 768px) {
            .mobile-toggle { display: block; }
            .sidebar { 
                position: absolute; right: 0; top: 60px; bottom: 60px; z-index: 100;
                transform: translateX(100%); transition: transform 0.3s; width: 85%;
            }
            .sidebar.active { transform: translateX(0); }
            .question-grid { grid-template-columns: repeat(6, 1fr); }
            .footer-controls { flex-wrap: wrap; gap: 5px; height: auto; padding: 10px; }
            .btn { flex: 1; padding: 8px; font-size: 0.8rem; }
        }

        /* Overlay */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .hidden { display: none !important; }
        
        .review-panel { display: none; padding: 20px; height: 100%; overflow-y: auto; background:#f9f9f9;}
        .review-item { margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 5px; background:white; }
        .explanation { background: #fff3cd; padding: 10px; margin-top: 10px; font-size: 0.9rem; border-left: 4px solid #ffc107; }

    </style>
</head>
<body>

    <div id="landingPage" class="overlay">
        <h1>AIIMS CRE CBT (Strict Pattern)</h1>
        <div style="width: 80%; max-width: 600px; text-align: left; margin: 20px 0;">
            <h3>Exam Rules:</h3>
            <ul>
                <li><strong>Questions:</strong> 100 (5 Sections of 20 questions each).</li>
                <li><strong>Timing:</strong> 18 Minutes per section (Strictly Dedicated).</li>
                <li><strong>Total Time:</strong> 90 Minutes.</li>
                <li><strong>Locking:</strong> Once 18 mins are up, or if you manually proceed to the next section, you <u>cannot</u> return to the previous section.</li>
                <li><strong>Marking:</strong> +4 Correct, -1 Incorrect.</li>
            </ul>
        </div>
        <button class="btn btn-success" style="font-size: 1.2rem;" onclick="startExam()">START EXAM</button>
    </div>

    <header id="examHeader" class="hidden">
        <div style="display:flex; align-items:center; gap:10px;">
            <h3>AIIMS Radiographer</h3>
            <span style="font-size:0.8rem; background:#eee; padding:2px 6px; border-radius:4px; color:#333;" id="sectionLabel">Section 1</span>
        </div>
        <div class="timer" id="timerDisplay">18:00</div>
        <button class="mobile-toggle" onclick="toggleSidebar()">â˜°</button>
    </header>

    <div class="main-container hidden" id="examBody">
        <div class="question-area">
            <div class="q-header">
                <span id="qNumDisplay">Question No. 1</span>
                <span style="color: #666;">Marks: +4, -1</span>
            </div>
            <div id="questionText" class="q-text">Loading...</div>
            <div id="optionsBox" class="options-container"></div>
        </div>

        <div class="sidebar" id="sidebar">
            <div class="user-info">
                <strong>Candidate Name</strong><br><small>Roll No: 123456</small>
            </div>
            <div class="palette-legend">
                <div class="legend-item"><span class="dot" style="background:var(--pallet-answered)"></span> Ans</div>
                <div class="legend-item"><span class="dot" style="background:var(--pallet-not-answered)"></span> Not Ans</div>
                <div class="legend-item"><span class="dot" style="background:var(--pallet-review)"></span> Review</div>
                <div class="legend-item"><span class="dot" style="background:#444"></span> Locked</div>
            </div>
            <div class="question-grid" id="questionPalette"></div>
            <div style="padding:10px; margin-top:auto;">
                <button class="btn btn-primary" style="width:100%" onclick="submitExam()">FINISH EXAM</button>
            </div>
        </div>
    </div>

    <div class="footer-controls hidden" id="examFooter">
        <div style="display:flex; gap:10px;">
            <button class="btn btn-danger" onclick="clearResponse()">Clear</button>
            <button class="btn btn-warn" onclick="markForReview()">Review</button>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn" onclick="prevQuestion()" id="btnPrev">Previous</button>
            <button class="btn btn-success" onclick="saveAndNext()">Save & Next</button>
        </div>
    </div>

    <div id="resultPage" class="overlay hidden" style="display:block; overflow-y:auto; justify-content:start; padding-top:40px;">
        <h2 style="text-align:center;">Exam Summary</h2>
        <div id="scoreCard" style="margin: 20px auto; width:90%; max-width:600px; padding: 20px; border: 1px solid #ccc; text-align: center; background:#fff;"></div>
        <div style="display:flex; justify-content:center; gap:20px; margin-bottom:20px;">
            <button class="btn btn-primary" onclick="showDetailedReview()">Review Solutions</button>
            <button class="btn btn-danger" onclick="location.reload()">Exit</button>
        </div>
        <div id="detailedReview" class="review-panel" style="width: 90%; max-width: 800px; margin:0 auto;"></div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const TOTAL_QUESTIONS = 100;
        const SECTION_SIZE = 20; // 20 questions per section
        const SECTION_TIME_LIMIT = 18 * 60; // 18 minutes in seconds
        
        let questions = [];

function generateQuestions() {
        const createQ = (id, type, text, opts, ans, exp) => ({ id, type, text, opts, ans, exp });
        questions = []; // Reset array

        // --- SECTION A: NON-CORE (1-20) ---
        // Topics: Complex Reasoning, Word Problems, Paragraph-based English

        const nonCoreData = [
            // Reasoning & Quantitative (Wordy Problems)
            ["A fast train leaves station A at a speed of 70 km/hr. Two hours later, another train leaves station A in the same direction at a speed of 90 km/hr. How many hours after the departure of the second train will it overtake the first train?", ["5 hours", "6 hours", "7 hours", "8 hours"], 2, "First train has a 140km head start (70*2). Relative speed is 20 km/hr. Time = Distance/Relative Speed = 140/20 = 7 hours."],
            ["In a certain coding language, if the word 'ORGANIZATION' is written as 'CBDWLJWYQJON' and 'OPERATION' is written as 'CXFBWYQJON', then how would you encode the word 'SEPARATION' using the same logic?", ["JFXBWYQJON", "JFXWBWYQJN", "EFXBWYQJON", "JFXCWYQJON"], 0, "Direct mapping based on common letters in the example words provided."],
            ["Read the following statement carefully: 'A is the son of B. C, who is the sister of B, has a son D and a daughter E. F is the maternal uncle of D.' Based on this family tree, how is A related to D?", ["Cousin", "Nephew", "Uncle", "Brother"], 0, "A (child of B) and D (child of C) are children of siblings (B and C). Therefore, they are Cousins."],
            ["In a bag, there are coins of 25 paise, 10 paise, and 5 paise in the ratio of 1:2:3. If the total value of the money in the bag is Rs. 30, how many 5 paise coins are there?", ["50", "100", "150", "200"], 2, "Let coins be x, 2x, 3x. Value: 25x + 20x + 15x = 60x paise. 60x = 3000 paise (Rs 30). x = 50. Number of 5 paise coins = 3x = 150."],
            ["Statement: 'The government has decided to levy a 2% cess on the tax amount payable for funding drought relief programs.' Assumption I: The government does not have sufficient funds to tackle drought. Assumption II: The amount collected via this cess will be sufficient.", ["Only I is implicit", "Only II is implicit", "Both I and II are implicit", "Neither is implicit"], 0, "Assumption I is implicit (reason for the cess). Assumption II is not necessarily true (it helps, but may not be 'sufficient')."],

            // General Knowledge (Descriptive)
            ["The 'Pradhan Mantri Jan Dhan Yojana' (PMJDY), launched by the Government of India, primarily aims to promote which of the following objectives among the economically weaker sections?", ["Financial Inclusion", "Digital Literacy", "Skill Development", "Cleanliness"], 0, "It is a National Mission for Financial Inclusion to ensure access to financial services."],
            ["Which Indian state is famously known as the 'Land of Five Rivers' due to the presence of the Beas, Chenab, Jhelum, Ravi, and Sutlej rivers flowing through it?", ["Haryana", "Uttar Pradesh", "Punjab", "Jammu & Kashmir"], 2, "Punjab (Panj = Five, Aab = Water)."],
            ["In the context of the Indian Constitution, the 'Directive Principles of State Policy' (DPSP), which guide the state in making laws, were borrowed from the constitution of which country?", ["USA", "Canada", "Ireland", "Germany"], 2, "Borrowed from the Irish Constitution."],
            ["The prestigious 'Dadasaheb Phalke Award' is India's highest award in the field of cinema. It is presented annually at the National Film Awards ceremony by which organization?", ["Directorate of Film Festivals", "Film Federation of India", "Ministry of Culture", "CBFC"], 0, "Directorate of Film Festivals (Ministry of I&B)."],
            ["Chlorofluorocarbons (CFCs), which are widely used in refrigerators and air conditioners, are considered harmful to the environment primarily because they cause:", ["Acid Rain", "Depletion of the Ozone Layer", "Soil Pollution", "Water Contamination"], 1, "They release chlorine which destroys ozone molecules in the stratosphere."],

            // English (Sentence/Para based)
            ["Rearrange the following parts to form a meaningful sentence: (P) to the cinema / (Q) we went / (R) yesterday / (S) although it was raining.", ["QPRS", "PQRS", "QRSP", "SRPQ"], 0, "We went (Q) to the cinema (P) yesterday (R) although it was raining (S)."],
            ["Choose the word which is most nearly the SAME in meaning to 'INDIGENOUS' as used in the context of 'Indigenous technologies being promoted by the state'.", ["Foreign", "Native", "Expensive", "Complex"], 1, "Indigenous means originating naturally in a particular place; Native."],
            ["'To read between the lines' implies a specific way of understanding a text. What does this idiom accurately signify?", ["Reading very slowly", "Understanding the hidden or implied meaning", "Reading a poem", "Checking for grammatical errors"], 1, "Understanding the hidden meaning."],
            ["In the sentence 'The jury was divided in their opinion', which part contains a grammatical error regarding subject-verb agreement?", ["The jury", "was divided", "in their", "opinion"], 1, "If the jury is divided, it is treated as plural individuals. Should be 'The jury were divided'."],
            ["Select the one word substitution for: 'A decision upon which one cannot go back or which cannot be changed'.", ["Incorrigible", "Irrevocable", "Invulnerable", "Infallible"], 1, "Irrevocable."],

            // Computers (Scenario Based)
            ["You are working on a confidential document in MS Word. You want to ensure that no one else can open or edit this file without a password. Which feature would you access?", ["Review > Protect Document", "File > Info > Protect Document > Encrypt with Password", "Insert > Security", "View > Lock"], 1, "File > Info > Encrypt with Password."],
            ["When you delete a file from your Windows hard drive using the 'Delete' key, it moves to the Recycle Bin. If you want to delete a file permanently so that it does not go to the Recycle Bin, which key combination should you use?", ["Ctrl + Delete", "Alt + Delete", "Shift + Delete", "Fn + Delete"], 2, "Shift + Delete."],
            ["A user complains that their computer is taking a very long time to boot up and load applications. Which of the following hardware upgrades would most effectively improve the speed of the system?", ["Upgrading the Monitor", "Adding more RAM or an SSD", "Changing the Keyboard", "Installing a new DVD drive"], 1, "RAM and SSD significantly improve speed."],
            ["In the context of internet security, what is the primary function of a 'Firewall' installed on a computer network?", ["To prevent the computer from overheating", "To filter incoming and outgoing network traffic based on security rules", "To speed up the internet connection", "To stop viruses from a USB drive"], 1, "Filtering network traffic."],
            ["Which of the following file extensions indicates that a file is a compressed archive containing one or more files to save space?", [".docx", ".pdf", ".zip", ".txt"], 2, ".zip"]
        ];
        nonCoreData.forEach((d, i) => questions.push(createQ(i + 1, "Non-Core", d[0], d[1], d[2], d[3])));


        // --- SECTION B: CORE (21-100) ---
        // Detailed, Clinical, and Physics-heavy descriptions

        const coreData = [
            // 1. Physics & Equipment (21-40)
            ["A radiographer is operating a 3-phase, 12-pulse X-ray generator. If a single exposure is made using 80 kVp and 200 mAs, calculate the total Heat Units (HU) generated, considering the rectification constant for this specific generator type.", ["16,000 HU", "21,600 HU", "22,560 HU", "32,000 HU"], 2, "HU = kVp * mAs * 1.41. 80 * 200 * 1.41 = 22,560."],
            ["In the context of the Line Focus Principle, if the target angle of the anode is decreased (made steeper), what is the effect on the effective focal spot size and the thermal capacity of the tube?", ["Effective spot decreases, Heat capacity decreases", "Effective spot increases, Heat capacity increases", "Effective spot decreases, Heat capacity remains the same (for same actual spot)", "Effective spot increases, Heat capacity decreases"], 2, "A steeper angle (smaller degree) gives a smaller effective spot for better detail, while maintaining the same actual area for heat."],
            ["When utilizing a radiographic grid to improve image contrast, if the height of the lead strips is 2.4 mm and the width of the interspace material is 0.3 mm, what is the calculated Grid Ratio?", ["6:1", "8:1", "10:1", "12:1"], 1, "Grid Ratio = Height / Distance. 2.4 / 0.3 = 8:1."],
            ["A patient is undergoing a chest X-ray. The radiographer changes the Source-to-Image Distance (SID) from 100 cm to 180 cm to reduce magnification. According to the Inverse Square Law, if the original intensity was 'I', what will the new intensity be (approximately)?", ["1/2 of I", "1/3 of I", "1/4 of I", "Double of I"], 1, "100^2 / 180^2 is roughly 1/3.24. Intensity decreases significantly (approx 1/3 to 1/4). Exact: (10/18)^2 = 0.30."],
            ["During a fluoroscopic procedure, the Image Intensifier tube is used. Which internal component is responsible for converting the pattern of electrons emitted from the photocathode back into a visible light image?", ["Input Phosphor", "Electrostatic Lenses", "Output Phosphor", "Anode"], 2, "The Output Phosphor (Zinc Cadmium Sulfide) converts accelerated electrons into light."],
            ["The 'Anode Heel Effect' results in a variation of X-ray beam intensity along the longitudinal axis. In which of the following scenarios would this effect be MOST noticeable on the final image?", ["Long SID and Small Film Size", "Short SID and Large Film Size", "Long SID and Large Film Size", "Short SID and Small Film Size"], 1, "Short SID (more divergent beam used) and Large Film Size (catching the edges of the beam)."],
            ["Regarding X-ray interactions with matter: Which interaction involves an incident photon ejecting an inner-shell electron, being totally absorbed in the process, and is primarily responsible for the contrast seen between bone and soft tissue?", ["Compton Scattering", "Photoelectric Effect", "Coherent Scattering", "Pair Production"], 1, "Photoelectric Effect depends on Atomic Number (Z^3), providing contrast."],
            ["A technologist wishes to maintain the same optical density on a radiograph but wants to decrease the exposure time to minimize patient motion. If the original technique was 100 mA at 0.5 seconds, what should the new mA be if the time is reduced to 0.1 seconds?", ["200 mA", "300 mA", "400 mA", "500 mA"], 3, "mAs = 100 * 0.5 = 50. New mA * 0.1 = 50. New mA = 500."],
            ["When using a 'High Frequency' generator compared to a 'Single Phase' generator, how does the average energy of the X-ray beam change, and what is the implication for patient dose?", ["Average energy decreases, Dose increases", "Average energy increases, Dose decreases", "Average energy stays same", "Average energy increases, Dose increases"], 1, "Voltage ripple is low, so beam is consistently higher energy. This penetrates better, allowing lower mAs, thus reducing dose."],
            ["The 'Air Gap Technique' acts as an alternative to using a radiographic grid. For this technique to be effective in reducing scatter radiation reaching the receptor, what positional adjustment is required?", ["Decrease the SID", "Increase the OID (Object-Image Distance)", "Decrease the OID", "Increase the kVp"], 1, "Increasing OID allows divergent scatter radiation to miss the image receptor."],
            ["Which of the following X-ray beam filtration materials is typically added to the tube port to preferentially absorb low-energy (soft) X-rays that contribute to skin dose but not image quality?", ["Lead", "Aluminum", "Tungsten", "Molybdenum"], 1, "Aluminum is the standard filter material."],
            ["In a dual-focus X-ray tube, when the radiographer selects the 'Small Focal Spot' on the console, which component inside the tube is actually being energized?", [" The larger filament", "The smaller filament", "The rotating anode", "The focusing cup"], 1, "The smaller filament is energized to create a narrower electron stream."],
            ["Calculate the magnification factor if an object is placed 20 cm away from the image receptor (OID) and the total Source-to-Image Distance (SID) is 100 cm.", ["1.2", "1.25", "1.5", "2.0"], 1, "SOD = SID - OID = 100 - 20 = 80. Mag Factor = SID/SOD = 100/80 = 1.25."],
            ["A 'Focused Grid' is designed with lead strips that are angled to match the divergence of the X-ray beam. If this grid is used upside down, what artifact will appear on the image?", ["Uniform loss of density", "Severe loss of density at the edges (peripheral cutoff)", "Severe loss of density in the center", "Grid lines will disappear"], 1, "Peripheral cutoff (dark center, light edges)."],
            ["The unit 'Roentgen' (R) or 'Coulombs per Kilogram' (C/kg) is specifically used to measure:", ["Energy absorbed by tissue", "Biological damage in man", "Ionization in air", "Radioactivity of a source"], 2, "Ionization in dry air."],
            ["Which interaction involves an incident photon interacting with a loosely bound outer-shell electron, ejecting it, and then continuing in a different direction with reduced energy?", ["Photoelectric Effect", "Compton Scattering", "Pair Production", "Photodisintegration"], 1, "Compton Scattering (responsible for scatter/fog)."],
            ["If a radiograph exhibits 'Quantum Mottle' (grainy appearance), the most likely technical cause is:", ["Excessive kVp", "Excessive mAs", "Insufficient number of photons (Low mAs)", "Grid cutoff"], 2, "Quantum mottle is caused by photon starvation (low signal)."],
            ["The 'Modulation Transfer Function' (MTF) is a scientific measure used to evaluate the performance of an imaging system. An MTF value of 1.0 implies:", ["Zero resolution", "50% contrast transfer", "Perfect transfer of object contrast to image contrast", "System failure"], 2, "Perfect fidelity."],
            ["In digital radiography, the 'Fill Factor' of the pixel in a Flat Panel Detector refers to:", ["The percentage of the pixel area sensitive to X-rays", "The amount of data stored", "The speed of the processor", "The thickness of the scintillator"], 0, "Ratio of sensing area to the total area of the pixel."],
            ["When operating an X-ray tube, the 'Space Charge Effect' creates a cloud of electrons around the filament. This cloud tends to:", ["Attract more electrons", "Prevent further emission of electrons at low kVp", "Increase the speed of electrons", "Cool the filament"], 1, "It repels further electron emission (limiting mA)."],

            // 2. Clinical Anatomy & Positioning Scenarios (41-65)
            ["A patient arrives with a suspected fracture of the Scaphoid bone. The standard PA wrist view is inconclusive. Which specific positioning maneuver should be performed to elongate the Scaphoid and open the adjacent joint spaces?", ["Radial Deviation", "Ulnar Deviation", "Wrist Extension", "Wrist Flexion"], 1, "Ulnar deviation moves the scaphoid out from under the radius."],
            ["A patient complains of pain in the knee joint. The radiologist requests a 'Tunnel View' to evaluate the Intercondylar Fossa for loose bodies. Which of the following methods describes this projection?", ["Merchant Method", "Camp-Coventry or Holmblad Method", "Settegast Method", "Lawrence Method"], 1, "Camp-Coventry/Holmblad are tunnel views."],
            ["In a trauma setting, a patient arrives on a stretcher with a suspected cervical spine injury. The first and most critical projection to obtain to assess alignment and rule out major fracture/dislocation before moving the patient is:", ["AP Open Mouth", "AP Axial", "Cross-table Lateral (Horizontal Beam)", "Swimmer's View"], 2, "Cross-table lateral to see C1-C7/T1 without moving the neck."],
            ["To visualize the right Intervertebral Foramina of the Cervical Spine, which specific oblique position is required?", ["Right Posterior Oblique (RPO)", "Right Anterior Oblique (RAO)", "Left Posterior Oblique (LPO)", "Lateral"], 1, "Anterior Obliques (RAO/LAO) visualize the foramina on the SAME side closest to the IR. RAO = Right."],
            ["A patient is referred for a 'Sialography' examination. This contrast study is specifically designed to investigate the pathology of which anatomical structures?", ["The Spinal Cord", "The Salivary Glands and Ducts", "The Lacrimal Ducts", "The Bile Ducts"], 1, "Salivary glands (Parotid/Submandibular)."],
            ["When performing a chest X-ray to rule out a small pneumothorax, if the patient cannot stand, a lateral decubitus view is ordered. If the pneumothorax is suspected on the LEFT side, how should the patient be positioned?", ["Left side down", "Right side down", "Supine", "Prone"], 1, "Air rises. To see air on the LEFT lateral chest wall, the Right side must be down (Left side UP)."],
            ["For an 'AP Open Mouth' (Odontoid) projection, the patient is instructed to say 'Ah' or keep the mouth open. The primary goal of this positioning is to visualize which specific anatomical structures?", ["The mandibular condyles", "The Atlas (C1) and Axis (C2) dens", "The epiglottis", "The C7-T1 junction"], 1, "C1 lateral masses and C2 Dens."],
            ["A 'Skyline View' (e.g., Settegast, Merchant) is requested. This projection is specifically designed to visualize the:", ["Glenoid cavity of shoulder", "Patellofemoral joint space", "Acromioclavicular joint", "Calcaneus"], 1, "Patellofemoral joint (Patella and Femoral condyles)."],
            ["In the 'Waters View' (Parietoacanthial projection) for paranasal sinuses, the patient's chin is raised to place the OML at a 37-degree angle to the film. This is done primarily to:", ["Project the petrous ridges below the maxillary sinuses", "Visualize the sphenoid sinus", "Visualize the foramen magnum", "Magnify the orbits"], 0, "To clear the petrous ridges from obscuring the Maxillary sinuses."],
            ["The 'Stenvers Projection' is a specialized view used to visualize the profile of which specific bone structure?", ["Zygomatic Arch", "Petrous portion of Temporal bone", "Mandibular Ramus", "Nasal Bone"], 1, "Petrous temporal bone."],
            ["The 'Mortise View' of the ankle is essential for evaluating the ankle joint space. To achieve this, the leg and foot must be rotated:", ["Externally 15-20 degrees", "Internally 15-20 degrees", "Internally 45 degrees", "Externally 45 degrees"], 1, "15-20 degrees Internal rotation brings the malleoli parallel."],
            ["Which anatomical landmark lies at the approximate level of the interspace between the L4 and L5 vertebrae?", ["Xiphoid Tip", "Lower Costal Margin", "Iliac Crest", "ASIS"], 2, "Iliac Crest."],
            ["During an Intravenous Urogram (IVU), compression is applied to the lower abdomen. The purpose of this compression is to:", ["Immobilize the patient", "Retain contrast in the renal pelvis and calyces", "Empty the bladder", "Displace bowel gas"], 1, "To fill the upper urinary tract by blocking ureters."],
            ["The 'Garth Method' (Apical Oblique) of the shoulder is particularly useful in trauma for detecting:", ["Fracture of the Clavicle", "Posterior Scapulohumeral Dislocation", "AC Joint Separation", "Bicipital Groove spurs"], 1, "Posterior dislocations and Hill-Sachs lesions."],
            ["A 'Small Bowel Enema' (Enteroclysis) differs from a standard Small Bowel Follow Through because:", ["It uses a rectally inserted tube", "It involves intubation of the duodenum/jejunum for controlled contrast delivery", "It uses Ultrasound", "It requires no contrast"], 1, "Nasojejunal tube placement for double contrast."],
            ["'Hilgenreiner's Line' and 'Perkin's Line' are measurements used in pediatric radiography to evaluate:", ["Scoliosis", "Developmental Dysplasia of the Hip (DDH)", "Club foot", "Bone age"], 1, "Hip dysplasia."],
            ["The 'Valpeau View' is an alternative projection used for the shoulder when:", ["The patient can stand erect", "The arm is immobilized in a sling", "The patient is prone", "The patient is unconscious"], 1, "When the arm cannot be abducted (in a sling)."],
            ["A 'Voiding Cystourethrogram' (VCUG) is the gold standard investigation for diagnosing which condition in children?", ["Kidney Stones", "Vesicoureteral Reflux (VUR)", "Wilms Tumor", "Bladder Cancer"], 1, "VUR (Reflux of urine)."],
            ["The 'Jug Handle View' or Submentovertex (SMV) projection is primarily used to visualize the:", ["Zygomatic Arches", "Mandibular Condyles", "Occipital Bone", "Frontal Sinus"], 0, "Zygomatic Arches."],
            ["In the context of the digestive system, the 'Ligament of Treitz' marks the anatomical division between:", ["Stomach and Duodenum", "Duodenum and Jejunum", "Jejunum and Ileum", "Ileum and Cecum"], 1, "Upper and Lower GI tract boundary (Duodenojejunal flexure)."],
            ["The 'Sustentaculum Tali' is a bony shelf located on the medial aspect of which tarsal bone?", ["Talus", "Calcaneus", "Navicular", "Cuboid"], 1, "Calcaneus."],
            ["For a 'Lateral Projection' of the wrist, the elbow should be flexed 90 degrees. This is important to:", ["Comfort the patient", "Ensure the Radius and Ulna are superimposed", "Rotate the scaphoid", "None of the above"], 1, "Ensures true lateral alignment."],
            ["Which projection of the elbow best demonstrates the 'Radial Head' free of superimposition?", ["AP", "Lateral", "External Oblique", "Internal Oblique"], 2, "External (Lateral) Oblique."],
            ["'Judet Views' (Internal and External Oblique Pelvis) are specifically requested to assess fractures of the:", ["Sacrum", "Acetabulum", "Femoral Neck", "Symphysis Pubis"], 1, "Acetabulum columns."],
            ["The 'Swimmer's Lateral' view is performed when:", ["The patient is drowning", "The C7-T1 junction is obscured by the shoulders on a standard lateral", "The patient has a neck collar", "The odontoid is not visible"], 1, "To clear the shoulders from C7-T1."],

            // 3. CT, MRI, Ultrasound, Digital (66-85)
            ["In Computed Tomography, the 'Hounsfield Unit' (HU) value representing the density of Air is set to:", ["0", "+1000", "-1000", "+100"], 2, "-1000 HU."],
            ["A 'Ring Artifact' seen on a third-generation CT scanner image is most typically caused by:", ["Patient movement during the scan", "A single faulty detector element in the array", "Beam hardening", "Metal implants"], 1, "Faulty detector calibration."],
            ["In Helical (Spiral) CT, 'Pitch' is defined as the table travel per rotation divided by the beam collimation. A Pitch greater than 1 implies:", ["There is overlap between slices (Higher dose)", "There are gaps in the data acquisition helix (Lower dose)", "The table is not moving", "Maximum resolution"], 1, "Gaps in data (undersampling), resulting in faster scan and lower dose."],
            ["Regarding MRI Safety: The 'Quench' button should ONLY be pressed in which situation?", ["The image quality is poor", "There is a fire in the room", "A person is pinned against the magnet by a ferromagnetic object", "The patient is claustrophobic"], 2, "Life-threatening emergency (person pinned)."],
            ["In an MRI sequence, 'TR' (Repetition Time) primarily controls:", ["T2 weighting", "T1 weighting", "Proton Density", "Spatial Resolution"], 1, "Short TR emphasizes T1 contrast."],
            ["Which MRI pulse sequence uses an Inversion Pulse (180 degrees) to null the signal from fat?", ["Gradient Echo", "Spin Echo", "STIR (Short Tau Inversion Recovery)", "FLAIR"], 2, "STIR."],
            ["Diffusion Weighted Imaging (DWI) in MRI is the most sensitive sequence for the early detection of:", ["Brain Tumor", "Acute Ischemic Stroke", "Multiple Sclerosis", "Hemorrhage"], 1, "Acute cytotoxic edema (Stroke)."],
            ["In Digital Radiography (DR), 'Detective Quantum Efficiency' (DQE) is a measure of:", ["How fast the image appears", "The system's efficiency in converting x-ray input signal into a useful output image", "The resolution of the monitor", "The amount of storage required"], 1, "Efficiency of signal conversion."],
            ["A 'Ghosting Artifact' in a CR (Computed Radiography) system is usually caused by:", ["Incomplete erasure of the previous image from the IP plate", "Patient motion", "Grid cutoff", "Backscatter"], 0, "Latent image remains due to incomplete erasure."],
            ["In Ultrasound imaging, the 'Piezoelectric Effect' refers to the ability of the transducer crystals to:", ["Convert heat into sound", "Convert electrical energy into mechanical sound waves (and vice versa)", "Amplify the signal", "Filter the noise"], 1, "Electrical <-> Mechanical."],
            ["An 'Anechoic' structure on an ultrasound scan (appearing black) typically represents:", ["Bone", "Fluid (e.g., Cyst, Bladder)", "Fat", "Air"], 1, "Fluid transmits sound without reflection."],
            ["'Doppler Shift' in ultrasound is used to measure:", ["Tissue stiffness", "Temperature of tissue", "Velocity and direction of blood flow", "Bone density"], 2, "Blood flow."],
            ["The 'Blooming Artifact' in CT is commonly associated with:", ["Air pockets", "High-density objects like calcification or metal", "Patient breathing", "Low mAs"], 1, "High density objects appearing larger than reality."],
            ["'Gadolinium-based' contrast agents used in MRI work by:", ["Blocking X-rays", "Shortening the T1 relaxation time of nearby protons", "Increasing T2 decay", "Producing light"], 1, "Shortens T1, causing bright signal on T1-weighted images."],
            ["Nephrogenic Systemic Fibrosis (NSF) is a rare but serious complication associated with the use of Gadolinium contrast in patients with:", ["Liver failure", "Severe Renal (Kidney) Failure", "Heart failure", "Asthma"], 1, "Renal failure (GFR < 30)."],
            ["In CT Angiography (CTA), the 'Bolus Tracking' technique is used to:", ["Track the movement of the patient", "Trigger the scan automatically when contrast density in a target vessel reaches a threshold", "Measure the volume of contrast", "Reduce artifacts"], 1, "Ensures optimal enhancement timing."],
            ["What is the primary advantage of 'Iterative Reconstruction' (IR) algorithms in modern CT scanners?", ["Faster reconstruction speed", "Significant reduction in image noise allowing for lower radiation dose", "Increased tube heating", "Higher kVp usage"], 1, "Dose reduction."],
            ["The 'Moire Pattern' artifact in digital radiography is caused by:", ["Patient motion", "Aliasing between the grid lines and the digital scanning frequency", "Underexposure", "Dust on the CR plate"], 1, "Grid line frequency interference."],
            ["'T2-Weighted' images in MRI typically show water and fluid as:", ["Dark (Hypointense)", "Bright (Hyperintense)", "Grey (Isointense)", "Invisible"], 1, "Water is Bright on T2."],
            ["'Spectroscopy' (MRS) in MRI is used to provide information about:", ["Vascular flow", "Metabolic/Chemical composition of tissue", "Bone structure", "Motion"], 1, "Chemical metabolites (Choline, NAA, etc.)."],

            // 4. Pathology, Safety & Protocols (86-100)
            ["Which of the following describes the 'ALARA' principle in radiation protection?", ["As Long As Radiation Allows", "As Low As Reasonably Achievable", "Always Leave Area Radioactive", "As Low As Regulations Allow"], 1, "Fundamental safety principle."],
            ["The annual effective dose limit for a radiation worker (Occupational Exposure), as per AERB/ICRP guidelines, is:", ["5 mSv", "20 mSv (averaged over 5 years)", "50 mSv", "100 mSv"], 1, "20 mSv avg per year (Max 30 in one year, 100 in 5 years)."],
            ["'Stochastic Effects' of radiation (e.g., Cancer, Genetic defects) are characterized by:", ["A threshold dose below which they do not occur", "Severity dependent on dose", "Probability of occurrence increasing with dose, with no threshold", "Immediate appearance"], 2, "No threshold; probability increases with dose."],
            ["'Deterministic Effects' (e.g., Cataracts, Skin Erythema) are characterized by:", ["No threshold", "Severity increasing with dose above a specific threshold", "Random occurrence", "Genetic transmission"], 1, "Threshold exists."],
            ["A 'Lead Apron' used in fluoroscopy typically has a lead equivalence of:", ["0.1 mm Pb", "0.25 mm Pb", "0.5 mm Pb", "1.0 mm Pb"], 2, "0.5 mm is the standard."],
            ["Which radiographic sign is described as the 'Bamboo Spine' appearance, involving fusion of the vertebral bodies?", ["Osteoporosis", "Ankylosing Spondylitis", "Multiple Myeloma", "Scoliosis"], 1, "Ankylosing Spondylitis."],
            ["On a chest X-ray, the 'Silhouette Sign' refers to:", ["The loss of a normal border (e.g., heart) when an opacity of similar density is adjacent to it", "A pneumothorax", "Rib fractures", "Enlarged heart"], 0, "Loss of border definition."],
            ["'Codman's Triangle' is a specific periosteal reaction pattern seen on X-rays, often indicating:", ["Benign bone cyst", "Aggressive bone tumor (e.g., Osteosarcoma)", "Healing fracture", "Osteomyelitis"], 1, "Osteosarcoma."],
            ["A 'Volvulus' refers to which pathological condition of the bowel?", ["Telescoping of bowel", "Twisting of the bowel on its mesentery", "Inflammation", "Herniation"], 1, "Twisting."],
            ["'Hydrocephalus' is a condition characterized by:", ["Accumulation of blood in the brain", "Accumulation of Cerebrospinal Fluid (CSF) in the ventricles", "Shrinkage of the brain", "Tumor"], 1, "CSF accumulation."],
            ["Which of the following is an absolute contraindication for an IVU (Intravenous Urogram)?", ["Hypertension", "Renal Failure (High Creatinine)", "Diabetes", "UTI"], 1, "Renal failure (Contrast cannot be excreted/nephrotoxic)."],
            ["'Hirschsprung's Disease' in children is diagnosed using Barium Enema to look for:", ["A narrowed segment with proximal dilation (Megacolon)", "Polyps", "Ulcers", "Fistulas"], 0, "Congenital megacolon."],
            ["The 'Ten Day Rule' suggests that elective abdominal X-rays in women of childbearing age should be restricted to:", ["The last 10 days of the cycle", "The first 10 days following the onset of menstruation", "Any time", "When bleeding stops"], 1, "First 10 days to avoid undetected pregnancy."],
            ["Personnel monitoring badges (TLD) measure radiation dose based on the principle of:", ["Ionization of gas", "Thermoluminescence (Light emission upon heating)", "Chemical change", "Blackening of film"], 1, "Thermoluminescence."],
            ["The 'Half Value Layer' (HVL) is a measurement of the X-ray beam's:", ["Quantity", "Quality (Penetrability)", "Field size", "Scatter"], 1, "Quality."]
        ];

        coreData.forEach((d, i) => questions.push(createQ(21 + i, "Core", d[0], d[1], d[2], d[3])));
    }

        // --- STATE MANAGEMENT ---
        let state = {
            currentQ: 0,
            answers: new Array(TOTAL_QUESTIONS).fill(null),
            status: new Array(TOTAL_QUESTIONS).fill('not-visited'),
            currentSection: 1,      // 1 to 5
            sectionTimeLeft: SECTION_TIME_LIMIT,
            maxSetReached: 1,       // Tracks highest section unlocked
            isFinished: false
        };

        const els = {
            landing: document.getElementById('landingPage'),
            header: document.getElementById('examHeader'),
            body: document.getElementById('examBody'),
            footer: document.getElementById('examFooter'),
            result: document.getElementById('resultPage'),
            qText: document.getElementById('questionText'),
            optsBox: document.getElementById('optionsBox'),
            qNum: document.getElementById('qNumDisplay'),
            sectionLabel: document.getElementById('sectionLabel'),
            palette: document.getElementById('questionPalette'),
            timer: document.getElementById('timerDisplay'),
            btnPrev: document.getElementById('btnPrev'),
            sidebar: document.getElementById('sidebar')
        };

        let timerInterval;

        function init() {
            generateQuestions(); // Load data
            // Persistence check could go here, but for strict timing, fresh start is safer
            els.landing.classList.remove('hidden');
            els.result.classList.add('hidden');
        }

        function startExam() {
            els.landing.classList.add('hidden');
            renderExamInterface();
            startSectionTimer();
        }

        function startSectionTimer() {
            if(timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                state.sectionTimeLeft--;
                
                // Format Time
                const m = Math.floor(state.sectionTimeLeft / 60);
                const s = state.sectionTimeLeft % 60;
                els.timer.innerText = `${m}:${s < 10 ? '0'+s : s}`;
                
                // Visual Warning
                if(state.sectionTimeLeft < 60) els.timer.style.backgroundColor = "#ffcdd2";
                else els.timer.style.backgroundColor = "#fff";

                // Time Up Logic
                if (state.sectionTimeLeft <= 0) {
                    handleSectionTimeout();
                }
            }, 1000);
        }

        function handleSectionTimeout() {
            clearInterval(timerInterval);
            
            if (state.currentSection < 5) {
                alert(`Time is up for Section ${state.currentSection}! Moving to Section ${state.currentSection + 1}.`);
                forceNextSection();
            } else {
                alert("Time is up for the final section! Submitting Exam.");
                finishExam();
            }
        }

        function forceNextSection() {
            state.currentSection++;
            state.maxSetReached = state.currentSection;
            state.sectionTimeLeft = SECTION_TIME_LIMIT;
            
            // Move to first question of next section
            const firstQofNextSection = (state.currentSection - 1) * SECTION_SIZE;
            loadQuestion(firstQofNextSection);
            startSectionTimer();
        }

        function renderExamInterface() {
            els.header.classList.remove('hidden');
            els.body.classList.remove('hidden');
            els.footer.classList.remove('hidden');
            renderPalette();
            loadQuestion(state.currentQ);
        }

        function loadQuestion(index) {
            state.currentQ = index;
            if(state.status[index] === 'not-visited') state.status[index] = 'not-answered';

            // Update Section Label
            const secNum = Math.floor(index / SECTION_SIZE) + 1;
            els.sectionLabel.innerText = `Section ${secNum} (Q${(secNum-1)*20 + 1}-${secNum*20})`;

            // Render Text
            els.qNum.innerText = `Question ${index + 1}`;
            els.qText.innerText = questions[index].text;
            
            // Render Options
            els.optsBox.innerHTML = '';
            questions[index].opts.forEach((opt, i) => {
                const isChecked = state.answers[index] === i ? 'checked' : '';
                els.optsBox.innerHTML += `
                    <label class="option-label">
                        <input type="radio" name="opt" value="${i}" ${isChecked} onchange="selectOption(${i})">
                        ${opt}
                    </label>
                `;
            });

            // Update Palette UI
            document.querySelectorAll('.q-btn').forEach(b => b.classList.remove('current'));
            const currentBtn = document.getElementById(`qbtn-${index}`);
            if(currentBtn) currentBtn.classList.add('current');

            // Handle Prev Button State (Cannot go back to previous locked section)
            const startOfCurrentSection = (state.currentSection - 1) * SECTION_SIZE;
            els.btnPrev.disabled = (index <= startOfCurrentSection);
        }

        function selectOption(optIndex) {
            state.answers[state.currentQ] = optIndex;
        }

        function saveAndNext() {
            const index = state.currentQ;
            // Update status
            state.status[index] = (state.answers[index] !== null) ? 'answered' : 'not-answered';
            
            moveToNextQuestion();
        }

        function markForReview() {
            const index = state.currentQ;
            state.status[index] = (state.answers[index] !== null) ? 'marked-answered' : 'review'; // Simplified
            moveToNextQuestion();
        }

        function clearResponse() {
            state.answers[state.currentQ] = null;
            state.status[state.currentQ] = 'not-answered';
            loadQuestion(state.currentQ);
            renderPalette();
        }

        function moveToNextQuestion() {
            const nextIndex = state.currentQ + 1;
            const currentSecBound = state.currentSection * SECTION_SIZE;

            // Check if next question crosses section boundary
            if (nextIndex >= currentSecBound) {
                // End of section reached
                if (state.currentSection < 5) {
                    if (confirm(`You have reached the end of Section ${state.currentSection}.\nDo you want to submit this section and move to Section ${state.currentSection+1}?\n\nWARNING: You cannot return to this section.`)) {
                        forceNextSection();
                    }
                } else {
                    if(confirm("This was the last question. Submit Exam?")) {
                        finishExam();
                    }
                }
            } else {
                // Normal movement within section
                renderPalette();
                loadQuestion(nextIndex);
            }
        }

        function prevQuestion() {
            // Logic handled in loadQuestion to disable button if at start of section
            if (state.currentQ > 0) {
                loadQuestion(state.currentQ - 1);
            }
        }

        function renderPalette() {
            els.palette.innerHTML = '';
            for (let i = 0; i < TOTAL_QUESTIONS; i++) {
                let statusClass = state.status[i];
                if(statusClass === 'marked-answered') statusClass = 'review';
                
                // Check if question belongs to a locked (previous) section
                // A question is locked if its section index is < current active section
                const qSection = Math.floor(i / SECTION_SIZE) + 1;
                const isLocked = qSection < state.currentSection;
                const lockedClass = isLocked ? ' locked' : '';
                
                // Gray out future sections
                const isFuture = qSection > state.currentSection;
                const futureStyle = isFuture ? 'opacity:0.3; pointer-events:none;' : '';

                els.palette.innerHTML += `
                    <div id="qbtn-${i}" 
                         class="q-btn ${statusClass}${lockedClass}" 
                         style="${futureStyle}"
                         onclick="jumpToQuestion(${i})">
                        ${i + 1}
                    </div>
                `;
            }
        }

        function jumpToQuestion(index) {
            const qSection = Math.floor(index / SECTION_SIZE) + 1;
            
            if (qSection < state.currentSection) {
                alert("This section is locked.");
                return;
            }
            if (qSection > state.currentSection) {
                alert("You cannot jump to a future section yet.");
                return;
            }
            
            loadQuestion(index);
        }

        function submitExam() {
            if(confirm("Are you sure you want to finish the exam? Unanswered questions in future sections will be marked zero.")) {
                finishExam();
            }
        }

        function finishExam() {
            clearInterval(timerInterval);
            state.isFinished = true;
            
            els.header.classList.add('hidden');
            els.body.classList.add('hidden');
            els.footer.classList.add('hidden');
            els.result.classList.remove('hidden');
            
            calculateResult();
        }

        function calculateResult() {
            let correct = 0, wrong = 0, unattempted = 0, score = 0;

            state.answers.forEach((ans, i) => {
                if (ans === null) {
                    unattempted++;
                } else if (questions[i] && ans === questions[i].ans) {
                    correct++;
                    score += 4;
                } else {
                    wrong++;
                    score -= 1;
                }
            });

            document.getElementById('scoreCard').innerHTML = `
                <h1 style="color:#3f51b5; font-size:3rem;">${score} / 400</h1>
                <p><strong>Correct:</strong> ${correct} (+${correct*4})</p>
                <p><strong>Incorrect:</strong> ${wrong} (-${wrong})</p>
                <p><strong>Unattempted:</strong> ${unattempted}</p>
            `;
        }

        function showDetailedReview() {
            const container = document.getElementById('detailedReview');
            container.style.display = 'block';
            container.innerHTML = '<h3>Detailed Solutions</h3>';
            
            questions.forEach((q, i) => {
                const userAns = state.answers[i];
                const isCorrect = userAns === q.ans;
                const statusColor = userAns === null ? 'gray' : (isCorrect ? 'green' : 'red');
                const statusText = userAns === null ? 'Skipped' : (isCorrect ? 'Correct' : 'Incorrect');

                let optsHtml = '';
                q.opts.forEach((opt, oi) => {
                    let style = '';
                    if (oi === q.ans) style = 'font-weight:bold; color:green;'; 
                    if (oi === userAns && !isCorrect) style = 'font-weight:bold; color:red;'; 
                    optsHtml += `<div style="${style}">${oi+1}. ${opt}</div>`;
                });

                container.innerHTML += `
                    <div class="review-item">
                        <div style="color:${statusColor}; font-weight:bold; margin-bottom:5px;">Q${i+1}: ${statusText}</div>
                        <div>${q.text}</div>
                        <div style="margin:10px 0; padding-left:15px; border-left:3px solid #ddd;">${optsHtml}</div>
                        <div class="explanation"><strong>Explanation:</strong> ${q.exp}</div>
                    </div>
                `;
            });
        }

        function toggleSidebar() {
            els.sidebar.classList.toggle('active');
        }

        // Initialize
        init();

    </script>
</body>
</html>
